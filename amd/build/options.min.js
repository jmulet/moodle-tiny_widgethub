define("tiny_widgethub/options",["exports","editor_tiny/options","./common","./util","./service/template_service"],(function(_exports,_options,_common,_util,_template_service){var obj,_document$querySelect;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.Widget=_exports.Shared=_exports.EditorOptions=void 0,_exports.applyPartials=applyPartials,_exports.expandPartial=expandPartial,_exports.fixMissingParamProperties=fixMissingParamProperties,_exports.getAdditionalCss=void 0,_exports.getEditorOptions=function(editor){let instance=editorOptionsInstances.get(editor);instance||(instance=new EditorOptions(editor),editorOptionsInstances.set(editor,instance));return instance},_exports.register=_exports.isShareCss=_exports.isPluginVisible=_exports.getWidgetDict=_exports.getGlobalConfig=void 0;const pluginName=(_common=(obj=_common)&&obj.__esModule?obj:{default:obj}).default.pluginName,showPlugin=(0,_options.getPluginOptionName)(pluginName,"showplugin"),userInfoOpt=(0,_options.getPluginOptionName)(pluginName,"user"),courseId=(0,_options.getPluginOptionName)(pluginName,"courseid"),widgetList=(0,_options.getPluginOptionName)(pluginName,"widgetlist"),shareCss=(0,_options.getPluginOptionName)(pluginName,"sharecss"),additionalCss=(0,_options.getPluginOptionName)(pluginName,"additionalcss"),globalConfig=(0,_options.getPluginOptionName)(pluginName,"cfg");_exports.register=editor=>{const registerOption=editor.options.register;registerOption(showPlugin,{processor:"boolean",default:!0}),registerOption(userInfoOpt,{processor:"object",default:{id:0,username:"",roles:[]}}),registerOption(courseId,{processor:"string",default:"-1"}),registerOption(widgetList,{processor:"array",default:[]}),registerOption(shareCss,{processor:"boolean",default:!0}),registerOption(additionalCss,{processor:"string",default:""}),registerOption(globalConfig,{processor:"object",default:{}})};_exports.isPluginVisible=editor=>editor.options.get(showPlugin);_exports.getAdditionalCss=editor=>editor.options.get(additionalCss);_exports.isShareCss=editor=>editor.options.get(shareCss);let _widgetDict;_exports.getGlobalConfig=(editor,key,defaultValue)=>(editor.options.get(globalConfig)??{})[key]??defaultValue;const getWidgetDict=editor=>{if(_widgetDict)return _widgetDict;let rawWidgets=editor.options.get(widgetList)??[];_widgetDict={};let partials=rawWidgets.filter((e=>"partials"===e.key))[0];partials&&(rawWidgets=rawWidgets.filter((e=>"partials"!==e.key)));const wrappedWidgets=rawWidgets.map((w=>new Widget(w,partials||{}))),userInfo=editor.options.get(userInfoOpt);return wrappedWidgets.filter((w=>w.isFor(userInfo)&&(0,_util.compareVersion)(_common.default.currentRelease,w.prop("plugin_release")))).forEach((w=>{_widgetDict&&(_widgetDict[w.key]=w)})),_widgetDict};_exports.getWidgetDict=getWidgetDict;class EditorOptions{constructor(editor){this.editor=editor}get userInfo(){return this.editor.options.get(userInfoOpt)}get courseId(){return parseInt(this.editor.options.get(courseId))}get widgetDict(){return getWidgetDict(this.editor)}}_exports.EditorOptions=EditorOptions;const Shared={currentScope:(null===(_document$querySelect=document.querySelector("body"))||void 0===_document$querySelect?void 0:_document$querySelect.id)??""};function fixMissingParamProperties(param){var _param$options;if(param.type||(param.options?param.type="select":"boolean"==typeof param.value?param.type="checkbox":"number"==typeof param.value?param.type="numeric":"string"==typeof param.value&&(param.type=param.options?"select":"textfield")),!param.value)switch(param.type){case"checkbox":param.value=!1;break;case"numeric":param.value=0;break;case"select":case"autocomplete":param.value=null===(_param$options=param.options)||void 0===_param$options?void 0:_param$options[0],"object"==typeof param.value&&(param.value=param.value.v);break;case"color":param.value="#ffffff";break;default:param.value=""}}function expandPartial(obj,partials){if(null===(obj??null))return obj;let partialKey;return"string"==typeof obj&&obj.startsWith("__")&&obj.endsWith("__")?(partialKey=obj,obj={}):"object"==typeof obj&&obj.partial&&(partialKey=obj.partial,delete obj.partial),partialKey&&(partialKey=partialKey.replace(/__/g,""),partials[partialKey]?obj={...partials[partialKey],...obj}:console.error(`Cannot find partial for ${partialKey}`)),obj}function applyPartials(widget,partials){const regex=/__([\w\d]+)__/g;widget.template&&(widget.template=widget.template.replace(regex,((s0,s1)=>partials[s1]??s0)));const parameters=widget.parameters;parameters&&parameters.forEach(((param,i)=>{param=expandPartial(param,partials),parameters[i]=param;let prop=expandPartial(param.bind,partials);prop&&(param.bind=prop),prop=expandPartial(param.transform,partials),prop&&(param.transform=prop),fixMissingParamProperties(param)}))}_exports.Shared=Shared;class Widget{_widget;#instructionsParsed=!1;_preview;constructor(widget,partials){widget.key||(widget.key="w"+(0,_util.genID)()),applyPartials(widget,partials=partials??{}),this._widget=widget}get id(){return this._widget.id}get name(){return this._widget.name}get key(){return this._widget.key}get I18n(){return this._widget.I18n||{}}get template(){return this._widget.template??this._widget.filter??""}get category(){return this._widget.category}get insertquery(){return this._widget.insertquery}get selectors(){return this._widget.selectors}get unwrap(){return this._widget.unwrap}get version(){return this._widget.version||"1.0.0"}get instructions(){return this._widget.instructions&&!this.#instructionsParsed&&(this._widget.instructions=decodeURIComponent(this._widget.instructions),this.#instructionsParsed=!0),this._widget.instructions??""}get parameters(){return this._widget.parameters??[]}get defaults(){const obj={};return(this._widget.parameters??[]).forEach((param=>{obj[param.name]=(0,_template_service.createDefaultsForParam)(param)})),obj}isFor(userInfo){if(!0===this._widget.hidden)return!1;const checkList=(value,ruleStr)=>{if(!ruleStr||""===ruleStr.trim())return null;if("*"===ruleStr.trim())return!0;let allowMode=ruleStr.trim().startsWith("+")||!ruleStr.trim().startsWith("-");const list=ruleStr.replace(/[+\-\s]/g,"").split(",");return allowMode?list.includes(String(value)):!list.includes(String(value))},idRule=this._widget.for||this._widget.forids||"",usernameRule=this._widget.forusernames||"",roleRule=this._widget.forroles||"",results=[],idResult=checkList(userInfo.id,idRule);null!==idResult&&results.push(idResult);const usernameResult=checkList(userInfo.username,usernameRule);null!==usernameResult&&results.push(usernameResult);const roleResult=""===roleRule.trim()?null:userInfo.roles.some((role=>checkList(null==role?void 0:role.toLowerCase(),null==roleRule?void 0:roleRule.toLowerCase())));null!==roleResult&&results.push(roleResult);const matchMode=(this._widget.formatch||"AND").toUpperCase();if(0===results.length)return!0;const isAllowed="OR"===matchMode?results.some(Boolean):results.every(Boolean);return isAllowed||console.warn(`Widget ${this._widget.key} not allowed for user ${userInfo.id}`),isAllowed}isFilter(){return void 0===this._widget.template&&void 0!==this._widget.filter}isUsableInScope(scope){scope=scope??Shared.currentScope??"";const widgetScopes=this._widget.scope;return!scope||!widgetScopes||"*"===widgetScopes||new RegExp(widgetScopes).test(scope)}hasBindings(){const parameters=this._widget.parameters??[],repeatable=parameters.filter((param=>"repeatable"===param.type)).map((rep=>(rep.fields||[]).some((field=>void 0!==field.bind))));return parameters.some((param=>void 0!==param.bind))||repeatable.some((rep=>rep))}prop(name){return this._widget[name]}}_exports.Widget=Widget;const editorOptionsInstances=new Map}));

//# sourceMappingURL=options.min.js.map