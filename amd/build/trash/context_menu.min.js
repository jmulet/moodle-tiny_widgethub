define("tiny_widgethub/trash/context_menu",["exports","./options","jquery","./context_menu_actions","./util"],(function(_exports,_options,_jquery,_context_menu_actions,_util){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.UiContextMenu=_exports.ContextMenu=void 0,_jquery=_interopRequireDefault(_jquery),_context_menu_actions=_interopRequireDefault(_context_menu_actions);const matchesSelectors=function(elem,selectors){let selector=selectors,extraQuery=[];Array.isArray(selectors)&&(selector=selectors[0],selectors.length>1&&(extraQuery=selectors.slice(1)));let match=elem.matches(selector);return match&&extraQuery.forEach((e=>{match=match&&null!=elem.querySelector(e)})),match},contextMenuItems={"@edit":function(){this.uiContextMenu.addMenuItem("Edita",_context_menu_actions.default["@edit"].bind(this),"fas fa fa-cog")},"@unpack":function(){this.uiContextMenu.addSeparator(),this.uiContextMenu.addMenuItem("Desempaquetar",_context_menu_actions.default["@unpack"].bind(this),"fas fa fa-external-link")},"@cut":function(){this.uiContextMenu.addMenuItem("Retallar",_context_menu_actions.default["@clipboard/cut"].bind(this),"fas fa fa-scissors")},"@paste":function(){const subMenu=this.uiContextMenu.addSubMenu("Enganxar");this.clipBoard.forEach(((content,indx)=>{const desc=content.split("@@")[0];subMenu.addMenuItem(indx+1+". "+desc,_context_menu_actions.default["@clipboard/paste"].bind(this),"",{pos:indx+""})})),subMenu.endSubMenu().addSeparator().addMenuItem("Buidar portaretalls",_context_menu_actions.default["@clipboard/clear"].bind(this))},"menu-pestanyes2":function(){const theTab=this.currentContext.clickedElem.closest('a[data-toggle="tab"]');this.currentContext.theTab=theTab,theTab?this.uiContextMenu.addSubMenu("Afegir pestanya","fas fa fa-plus").addMenuItem("Abans",_context_menu_actions.default["tabs/add"].bind(this),"",{before:"true"}).addMenuItem("Després",_context_menu_actions.default["tabs/add"].bind(this),"").endSubMenu().addSubMenu("Moure","fas fa fa-arrows-h").addMenuItem("Abans",_context_menu_actions.default["tabs/move"].bind(this),"fas fa fa-arrow-left",{before:"true"}).addMenuItem("Després",_context_menu_actions.default["tabs/move"].bind(this),"fas fa fa-arrow-right").endSubMenu().addMenuItem("Eliminar pestanya",_context_menu_actions.default["tabs/del"].bind(this),"fa fas fa-trash"):this.uiContextMenu.addMenuItem("Afegir pestanya",_context_menu_actions.default["tabs/add"].bind(this),"fas fa fa-plus")},imatge:function(){const effect=this.currentContext.elem.dataset.snptd;"zoom"===effect||"lightbox"===effect?this.uiContextMenu.addMenuItem("Eliminar efecte "+effect,_context_menu_actions.default.imatge.bind(this),"fa fas fa-trash"):this.uiContextMenu.addSubMenu("Efectes d'imatge").addMenuItem("Afegir zoom",_context_menu_actions.default.imatge.bind(this),"",{effect:"zoom"}).addMenuItem("A pantalla completa",_context_menu_actions.default.imatge.bind(this),"",{effect:"lightbox"}).endSubMenu()},"imatge-fons":function(){this.uiContextMenu.addMenuItem("Canviar fons",_context_menu_actions.default["imatge-fons"].bind(this))},"two-cols":function(){const subMenu=this.uiContextMenu.addSubMenu("Mida columnes");for(let i=2;i<12;i+=2){const tpc=parseInt((100*i/12).toFixed(0)),label=tpc+"% | "+(100-tpc)+"%";subMenu.addMenuItem(label,_context_menu_actions.default["two-cols"].bind(this),"",{cols:""+i})}subMenu.endSubMenu().addMenuItem("Passar a una columna",_context_menu_actions.default["two-cols"].bind(this),"fa fas fa-trash",{cols:"rm"})},desplegable2:function(){console.log("Creating desplegable2 menus on ",this.currentContext.clickedElem),this.currentContext.theTab=this.currentContext.clickedElem.closest("div.accordion-group");const isAcc=null!=(0,_jquery.default)(this.currentContext.elem).find("div.accordion-body").attr("data-parent"),howManyAccordions=this.currentContext.elem.querySelectorAll(".accordion-group").length,desplegableAction=_context_menu_actions.default.desplegable2.bind(this);this.uiContextMenu.addSubMenu("Comportament").addMenuItem("Individual",desplegableAction,isAcc?"":"fa fas fa-check",{accordion:"bind"}).addMenuItem("Accordió",desplegableAction,isAcc?"fa fas fa-check":"",{accordion:"bacc"}).endSubMenu(),howManyAccordions>1&&this.uiContextMenu.addSubMenu("Mou desplegable","fas fa fa-arrows-v").addMenuItem("A dalt",desplegableAction,"fas fa fa-arrow-up",{accordion:"mup"}).addMenuItem("A baix",desplegableAction,"fas fa fa-arrow-down",{accordion:"mdwn"}).endSubMenu(),this.uiContextMenu.addSubMenu("Afegir desplegable","fas fa fa-plus").addMenuItem("A dalt",desplegableAction,"",{accordion:"iup"}).addMenuItem("A baix",desplegableAction,"",{accordion:"idwn"}).endSubMenu().addMenuItem("Eliminar desplegable",desplegableAction,"fas fa fa-trash",{accordion:"rm"}).addSeparator().addMenuItem("Convertir a llista",desplegableAction,"",{accordion:"2list"})},"taula-predefinida":function(){let theadToggle="Crear una",tfootToggle="Crear un";this.currentContext.elem.querySelector("thead")&&(theadToggle="Eliminar la"),this.currentContext.elem.querySelector("tfoot")&&(tfootToggle="Eliminar el");const ampMax=(0,_util.convertInt)((this.currentContext.elem.style.getPropertyValue("max-width")||"0").replace("px",""),0),tableAction=_context_menu_actions.default["taula-predefinida"].bind(this);if(this.uiContextMenu.addMenuItem(theadToggle+" capçalera",tableAction,"",{pos:"thead"}).addMenuItem(tfootToggle+" peu",tableAction,"",{pos:"tfoot"}).addNumericField("Amplada màxima (px)",_context_menu_actions.default["taula-predefinida/maxwidth"].bind(this),"",{value:ampMax+""}),this.currentContext.elem.classList.contains("iedib-table")?this.uiContextMenu.addSeparator().addMenuItem("Convertir a taula Bootstrap",tableAction,"",{pos:"2bs"}):this.uiContextMenu.addSeparator().addMenuItem("Convertir a taula predefinida",tableAction,"",{pos:"2pf"}),"taula-bs"===this.currentContext.snpt.key){const parent=this.currentContext.elem.parentElement;null!=parent&&"DIV"===parent.nodeName&&parent.classList.contains("table-responsive")?this.uiContextMenu.addSeparator().addMenuItem("Eliminar responsivitat",tableAction,"",{pos:"delres"}):this.uiContextMenu.addSeparator().addMenuItem("Afegir responsivitat",tableAction,"",{pos:"addres"})}},"capsa-generica":function(){const clst=this.currentContext.elem.classList;let mida2="gran";clst.contains("iedib-capsa-petita")&&(mida2="petita");const midaCapsaAction=_context_menu_actions.default["capsa/mida"].bind(this);this.uiContextMenu.addSubMenu("Mida").addMenuItem("Petita",midaCapsaAction,"petita"===mida2?"fa fas fa-check":"",{mida:"petita"}).addMenuItem("Gran",midaCapsaAction,"gran"===mida2?"fa fas fa-check":"",{mida:"gran"}).endSubMenu();const currentLang=this.currentContext.elem.dataset.lang||"ca";console.log(this.currentContext);const widget=this.currentContext.snpt;if(null!=widget){const parameters=widget.parameters,theLangParam=(0,_util.findVariableByName)("LANG",parameters);if(null!=theLangParam&&theLangParam.options){const capsaAction=_context_menu_actions.default.capsa.bind(this);let oldtype="alerta";const subMenuTipus=["alerta","ampliacio","consell","important","introduccio"].map((ty=>{let icon="";return clst.contains("iedib-"+ty+"-border")&&(oldtype=ty,icon="fa fas fa-check"),{name:ty,icon:icon,ds:{type:ty},action:capsaAction}})),subMenu=this.uiContextMenu.addSubMenu("Idioma");theLangParam.options.forEach((opt=>{const icon=opt.v===currentLang?"fa fas fa-check":"";subMenu.addMenuItem(opt.l,capsaAction,icon,{lang:opt.v,oldtype:oldtype,proposat:"false"})})),subMenu.endSubMenu();const subMenu2=this.uiContextMenu.addSubMenu("Tipus");subMenuTipus.forEach((e=>{subMenu2.addMenuItem(e.name,e.action,e.icon,e.ds)})),subMenu2.endSubMenu()}}},"capsa-exemple-cols":function(){this.uiContextMenu.addMenuItem("Convertir a exemple 2 files",_context_menu_actions.default["capsa-exemple-cols"].bind(this))},"capsa-exemple-rows":function(){this.uiContextMenu.addMenuItem("Convertir a exemple simple",_context_menu_actions.default["capsa-exemple-rows"].bind(this))},"tasca-exercici":function(){const currentLang=this.currentContext.elem.dataset.lang||"ca",widget=this.currentContext.snpt;if(null==widget)return;const parameters=widget.parameters,theLangParam=(0,_util.findVariableByName)("LANG",parameters);if(null!=theLangParam&&theLangParam.options){let oldtype="alerta";const subMenu=this.uiContextMenu.addSubMenu("Idioma"),capsaAction=_context_menu_actions.default.capsa;theLangParam.options.forEach((opt=>{const icon=opt.v===currentLang?"fa fas fa-check":"";subMenu.addMenuItem(opt.l,capsaAction,icon,{lang:opt.v,oldtype:oldtype,proposat:"true"})})),subMenu.endSubMenu();const isQuizzEnabled=(0,_util.isUserAllowed)((0,_options.getGlobalConfig)(this.editor)["enable.ibquizz.userlist"],(0,_options.getUserId)(this.editor)+""),proposatDiv=this.currentContext.elem.querySelector("div.iedib-tasca.iedib-proposat");if(proposatDiv&&isQuizzEnabled){if(0===proposatDiv.querySelectorAll("div[data-quizz-group]").length){const actionToggleDS=()=>{const inspoint=proposatDiv.querySelector(".iedib-inspoint");inspoint&&(inspoint.setAttribute("data-quizz-group",""),this.handleRequires(["/sd/quizz.min.js"]),this.uiContextMenu.hide(),inspoint.after(document.createElement("p")))};this.uiContextMenu.addMenuItem("Converteix a àrea de qüestionari",actionToggleDS)}}}},"!ol":function(){const decorat=this.currentContext.elem.classList.contains("iedib-falist"),startFrom=(0,_util.convertInt)(this.currentContext.elem.getAttribute("start"),1),olAction=_context_menu_actions.default["!ol"].bind(this);this.uiContextMenu.addSubMenu("Estil").addMenuItem("Normal",olAction,decorat?"":"fa fas fa-check",{ol:"snorm"}).addMenuItem("Embellit",olAction,decorat?"fa fas fa-check":"",{ol:"sfa"}).endSubMenu().addNumericField("Comença en ...",olAction,"",{ol:"startAt",value:startFrom+""})}};contextMenuItems["dinamic-presentacio"]=contextMenuItems["menu-pestanyes2"],contextMenuItems["image-grid"]=contextMenuItems.imatge,contextMenuItems["taula-bs"]=contextMenuItems["taula-predefinida"];class ContextMenu{static getInstance(editor){return null==this._contextMenuInstances[editor.id]&&(this._contextMenuInstances[editor.id]=new ContextMenu(editor)),this._contextMenuInstances[editor.id]}constructor(editor){_defineProperty(this,"editor",void 0),_defineProperty(this,"uiContextMenu",void 0),_defineProperty(this,"currentContext",void 0),_defineProperty(this,"clipBoard",void 0),this.editor=editor;const userId=(0,_options.getUserId)(editor);this.clipBoard=JSON.parse(localStorage.getItem("widgethub-clipboard_"+userId)||"[]"),console.log("Initializing context menu ",editor.id,editor.dom);const widgetList=Object.values((0,_options.getWidgetDict)(editor)).filter((snpt=>null!=snpt.selectors));widgetList.push(new _util.WidgetWrapper({key:"!ol",name:"Llista enumerada",selectors:"ol"}));const iFrame=document.getElementById(editor.id).parentElement.querySelector("iframe");editor.on("contextmenu longpress",(evt=>{console.log(evt);const result=function(widgetList,clickedElem){const result={clickedElem:clickedElem};let elem=clickedElem;const componentsLength=widgetList.length;for(;null!=elem&&"BODY"!==elem.getAttribute("name")&&null==result.snpt;){let i=0;for(;i<componentsLength&&null==result.snpt;)matchesSelectors(elem,widgetList[i].selectors)&&(result.snpt=widgetList[i],result.elem=elem),i++;elem=elem.parentElement}return result}(widgetList,evt.target);if(this.currentContext=result,this.uiContextMenu?this.uiContextMenu.hide():this.uiContextMenu=new UiContextMenu(this),this.clipBoard=JSON.parse(localStorage.getItem("widgethub-clipboard_"+userId)||"[]"),result.snpt){evt.preventDefault(),console.log("Generating contextmenu for result ",result),this.uiContextMenu.clear(),this.uiContextMenu.setTitle(result.snpt.name),result.snpt.hasBindings()&&(contextMenuItems["@edit"].call(this),this.uiContextMenu.addSeparator()),contextMenuItems[result.snpt.key]&&(console.log("Adding specific items for ",result.snpt.key),contextMenuItems[result.snpt.key].call(this)),null!=result.snpt.unpack&&contextMenuItems["@unpack"].call(this),contextMenuItems["@cut"].call(this),this.clipBoard.length&&contextMenuItems["@paste"].call(this);const rect=iFrame.getBoundingClientRect();this.uiContextMenu.show(evt.clientX+rect.left,evt.clientY+rect.top,evt)}else{let toBeShown=!1;if(this.uiContextMenu.clear(),"IMG"===evt.target.nodeName&&(this.currentContext.elem=evt.target,this.uiContextMenu.setTitle("Imatge"),this.uiContextMenu.addMenuItem("Convertir a widget imatge",_context_menu_actions.default["!img"].bind("this")),evt.preventDefault(),toBeShown=!0),this.clipBoard.length&&(toBeShown=!0,evt.preventDefault(),this.uiContextMenu.setTitle("Portaretalls"),contextMenuItems["@paste"].call(this)),toBeShown){const rect=iFrame.getBoundingClientRect();this.uiContextMenu.show(evt.clientX+rect.left,evt.clientY+rect.top,evt)}}})),(0,_jquery.default)("body").on("click",(evt=>{evt.target.closest(".dropdown-menu.ib-bsdialog")||this.hide()}))}hide(){var _this$uiContextMenu;null===(_this$uiContextMenu=this.uiContextMenu)||void 0===_this$uiContextMenu||_this$uiContextMenu.hide()}}_exports.ContextMenu=ContextMenu,_defineProperty(ContextMenu,"_contextMenuInstances",{});const SPACER='<i style="display: inline-block;margin-left: 14px;"></i> ';class UiContextSubMenu{constructor(theParent,name,icon){_defineProperty(this,"theParent",void 0),_defineProperty(this,"$submenu",void 0),this.theParent=theParent;const icona=icon?'<i class="'.concat(icon,'" style="color:gray;width:14px;"></i>'):SPACER,$elem=(0,_jquery.default)('<li class="dropdown-submenu"><a class="moodle-dialogue dropdown-item" href="#">'.concat(icona," ").concat(name,"</a></li>"));this.$submenu=(0,_jquery.default)('<ul class="dropdown-menu"></ul>'),$elem.append(this.$submenu),this.theParent.addLevel($elem)}addSeparator(){return this.$submenu.find(":last-child").hasClass("dropdown-divider")||this.$submenu.append((0,_jquery.default)('<li class="dropdown-divider"></li>')),this}addMenuItem(name,action,icon,ds){const $elem=_createDropdownItem(name,icon,ds);return this.$submenu.append($elem),$elem.on("click",action.bind(this.getRoot())),this}addNumericField(name,action,icon,ds){const $elem=_createNumericFieldItem(this.getRoot(),name,action,icon,ds);return this.$submenu.append($elem),this}endSubMenu(){return this.theParent}endSubSubMenu(){return this.theParent}getRoot(){return this.theParent.getRoot()}addLevel(elem){this.$submenu.append(elem)}addSubMenu(name,icon){return new UiContextSubMenu(this,name,icon)}}function _createNumericFieldItem(root,name,action,icon,ds){ds=ds||{},icon=icon?'<i class="'+icon+'" style="color:gray;width:14px;"></i> ':SPACER;const $elem=(0,_jquery.default)('<li class="dropdown-item">'.concat(icon," <span>").concat(name,"</span><br>\n    ").concat(SPACER,'&nbsp;&nbsp;<input class="moodle-dialogue" type="number" value="').concat(ds.value,'" style="width:100px"/></li>')),$input=$elem.find("input");if($elem.append($input),null!=ds){const keys=Object.keys(ds);for(let i=0,len=keys.length;i<len;i++){const k=keys[i],v=ds[k];$input.attr("data-"+k,v)}}return $input.on("change",(evt=>{$input.val()&&($input.attr("data-value",$input.val()+""||"1"),action.call(root,evt))})),$elem}function _createDropdownItem(name,icon,ds){const $elem=(0,_jquery.default)('<li class="dropdown-item"></li>'),isTrash=icon&&icon.indexOf("trash")>0,styleColor=isTrash?"darkred":"gray";icon=icon?'<i class="'.concat(icon,'" style="color:').concat(styleColor,';width:14px;"></i> '):SPACER;const $elemA=(0,_jquery.default)('<a href="#" class="moodle-dialogue"'.concat(isTrash?' style="color:darkred;"':"",">").concat(icon," ").concat(name,"</a>"));if($elem.append($elemA),null!=ds){const keys=Object.keys(ds);for(let i=0,len=keys.length;i<len;i++){const k=keys[i],v=ds[k];$elem.attr("data-"+k,v)}}return $elem}class UiContextMenu{constructor(popup){_defineProperty(this,"popup",void 0),_defineProperty(this,"$popupMenu",void 0),_defineProperty(this,"originalEvent",void 0),this.popup=popup,this.$popupMenu=(0,_jquery.default)("#snpteditor_popup"),0===this.$popupMenu.length&&(this.$popupMenu=(0,_jquery.default)('<ul id="snpteditor_popup" class="dropdown-menu ib-bsdialog" role="menu" style="-webkit-box-shadow: 4px 4px 7px 2px rgba(112,112,112,1);-moz-box-shadow: 4px 4px 7px 2px rgba(112,112,112,1);box-shadow: 4px 4px 7px 2px rgba(112,112,112,1);"></ul>'),this.$popupMenu.css({position:"fixed"}),(0,_jquery.default)("body").append(this.$popupMenu))}addSeparator(){return this.$popupMenu.find(":last-child").hasClass("dropdown-divider")||this.$popupMenu.append((0,_jquery.default)('<li class="dropdown-divider"></li>')),this}addHeader(name){return this.$popupMenu.append((0,_jquery.default)('<li class="dropdown-header">'+name+"</li>")),this}addMenuItem(name,action,icon,ds){const $elem=_createDropdownItem(name,icon,ds);return this.$popupMenu.append($elem),$elem.on("click",action.bind(this.popup)),this}addNumericField(name,action,icon,ds){const $elem=_createNumericFieldItem(this.getRoot(),name,action,icon,ds);return this.$popupMenu.append($elem),this}addSubMenu(name,icon){return new UiContextSubMenu(this,name,icon)}show(clientX,clientY,originalEvent){const $d=(0,_jquery.default)(window);let mw=this.$popupMenu.width()||100,mh=this.$popupMenu.height()||100;console.log("Popup show:: popup w and h ",mw,mh);let maxwSubmenu=0,maxhSubmenu=0;this.$popupMenu.find("li.dropdown-submenu").each(((i,ele)=>{const $ele=(0,_jquery.default)(ele),smw=$ele.width()||100,smh=$ele.height()||0;smw>maxwSubmenu&&(maxwSubmenu=smw),smh>maxhSubmenu&&(maxhSubmenu=smh)})),mw+=maxwSubmenu,mh+=maxhSubmenu;const ww=$d.width()||400,wh=$d.height()||200;console.log("Popup show:: window w and  h ",ww,wh),clientY+mh>wh&&(clientY=wh-mh-100),clientX+mw>ww&&(clientX=ww-mw-100),this.$popupMenu.show().css({left:clientX,top:clientY}),this.originalEvent=originalEvent}setTitle(title){this.$popupMenu.find("h6 > span").text(title)}clear(){this.$popupMenu.find("a").off(),this.$popupMenu.find("button").off(),this.$popupMenu.html("");const $label=(0,_jquery.default)('<h6 class="dropdown-header" style="border-bottom: 1px solid lightgray;transform: translateY(-8px);padding: 0.5rem 0.8rem;"><span>Menú</span></h6>'),$closeSB=(0,_jquery.default)('<a class="moodle-dialogue" href="" title="Tancar" style="margin-left:10px;float:right;color:gray;"><i class="fad fa fa-times"></i></a>');$closeSB.on("click touchstart",(e2=>{e2.preventDefault(),this.hide()})),$label.append($closeSB),this.$popupMenu.append($label)}hide(){this.$popupMenu.hide()}getRoot(){return this.popup}addLevel(elem){this.$popupMenu.append(elem)}}_exports.UiContextMenu=UiContextMenu}));

//# sourceMappingURL=context_menu.min.js.map