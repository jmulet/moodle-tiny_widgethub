{"version":3,"file":"uiPick.min.js","sources":["../src/uiPick.js"],"sourcesContent":["/* eslint-disable no-eq-null */\n/* eslint-disable no-console */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny WidgetHub plugin.\n *\n * @module      tiny_widgethub/plugin\n * @copyright   2024 Josep Mulet Pol <pep.mulet@gmail.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport ModalFactory from 'core/modal_factory';\nimport {IBPickModal} from './modal';\nimport {getCourseId, getWidgetDict, getUserId} from './options';\n// eslint-disable-next-line no-unused-vars\nimport {UserStorage, genID, hashCode, searchComp, templateRendererMustache, WidgetWrapper} from './util';\nimport {UiParamsCtrl} from './uiParams';\n// eslint-disable-next-line no-unused-vars\nimport {WidgetPlugin} from './commands';\n\n/**\n * Convert a simple input element in a typeahead widget\n */\nclass TypeAheadInput {\n    _inputElem;\n    _listener;\n    /** @type {number | undefined} */\n    _sfTimeout;\n    /**\n     * @param {HTMLElement} inputElem\n     * @param {Function} callback\n     * @param {number=} delay\n     */\n    constructor(inputElem, callback, delay) {\n        this._inputElem = inputElem;\n        this._listener = () => {\n            if (this._sfTimeout) {\n                window.clearTimeout(this._sfTimeout);\n                this._sfTimeout = undefined;\n            }\n            this._sfTimeout = window.setTimeout(() => callback(), delay ?? 800);\n        };\n        this._inputElem.addEventListener('keyup', this._listener);\n    }\n    off() {\n        if (this._sfTimeout) {\n            window.clearTimeout(this._sfTimeout);\n            this._sfTimeout = undefined;\n        }\n        if (this._listener) {\n            this._inputElem.removeEventListener('keyup', this._listener);\n        }\n    }\n}\n\n/**\n * @param {HTMLElement} el\n * @param {boolean} visible\n */\nconst toggleVisible = function(el, visible) {\n    if (visible) {\n        el.classList.remove(\"tiny_widgethub-hidden\");\n    } else {\n        el.classList.add(\"tiny_widgethub-hidden\");\n    }\n};\n\nconst Templates = {\n    RECENT_SNPT: `<div style=\"margin:10px 45px;font-size:85%;\">{{#recent}} {{#str}} recents, tiny_widgethub {{/str}}:\n    {{#name}}<a href=\"javascript:void(0)\" data-key=\"{{key}}\"><span class=\"badge badge-secondary\">{{name}}</span></a>{{/name}}\n    {{/recent}}`\n};\n\nexport class UiPickCtrl {\n    widgetPlugin;\n    editor;\n    /** @type {UiParamsCtrl | undefined} */\n    _uiParamsCtrl;\n    // @ts-ignore\n    modal;\n    /**\n     * @param {WidgetPlugin} widgetPlugin\n     */\n    constructor(widgetPlugin) {\n        this.widgetPlugin = widgetPlugin;\n        this.editor = widgetPlugin.editor;\n    }\n\n    /**\n     * @param {import('./util').WidgetWrapper} widget\n     * @returns {UiParamsCtrl}\n     */\n    getUiParamsCtrl(widget) {\n        if (this._uiParamsCtrl) {\n            this._uiParamsCtrl.destroy();\n            this._uiParamsCtrl.widget = widget;\n        } else {\n            this._uiParamsCtrl = new UiParamsCtrl(this, widget);\n        }\n        return this._uiParamsCtrl;\n    }\n\n    show() {\n        this.modal?.show();\n    }\n\n    async handleAction() {\n        const userId = getUserId(this.editor);\n        const courseId = getCourseId(this.editor);\n        const storage = UserStorage.getInstance(userId, courseId);\n\n        // Type on search input\n        const selectMode = this.editor.selection.getContent().trim().length > 0;\n\n        const onSearchKeyup = () => {\n            let numshown = 0;\n            const widgetSearchElem = this.modal.body.find(\"input\")[0];\n            const searchText = (widgetSearchElem.value || '');\n            storage.setToSession('searchtext', searchText, true);\n            /** @type {NodeListOf<HTMLElement>} */\n            const allbtns = document.querySelectorAll(\".tiny_widgethub-buttons\");\n            /** @type {NodeListOf<HTMLElement>} */\n            const allcatgs = document.querySelectorAll(\".tiny_widgethub-category\");\n\n            // Are we in selectMode, does the widget support it? insertquery\n            if (!searchText) {\n                allbtns.forEach(\n                    (el) => {\n                    const visible = !selectMode || (selectMode && el.dataset.selectable === \"true\");\n                    toggleVisible(el, visible);\n                    if (visible) {\n                        numshown++;\n                    }\n                });\n            } else {\n                allbtns.forEach((el) => {\n                    let visible = !selectMode || (selectMode && el.dataset.selectable === \"true\");\n                    const el2 = el.querySelector('button');\n                    visible = visible && searchComp(el2?.title + \"\", searchText);\n                    toggleVisible(el, visible);\n                    if (visible) {\n                        numshown++;\n                    }\n                });\n            }\n            allcatgs.forEach((el) => {\n                const count = el.querySelectorAll(\".tiny_widgethub-buttons:not(.tiny_widgethub-hidden)\").length;\n                toggleVisible(el, count > 0);\n            });\n            console.log(\"Num shown buttons is \", numshown);\n            // If no result show emptyList message\n            toggleVisible(this.modal.body.find(\".tiny_widgethub-emptylist\")[0], numshown == 0);\n        };\n\n\n        // Show modal with buttons.\n        if (this.modal) {\n            console.log(\"Estic en mode selecció? \" + selectMode);\n            if (selectMode) {\n                this.modal.header.find(\"span.ib-blink\").removeClass(\"tiny_widgethub-hidden\");\n            } else {\n                this.modal.header.find(\"span.ib-blink\").addClass(\"tiny_widgethub-hidden\");\n            }\n        } else {\n            const searchText = storage.getFromSession(\"searchtext\", \"\");\n            const data = this.getPickTemplateContext({\n                searchText: searchText\n            });\n            console.log(\" data  is  \", data);\n            // @ts-ignore\n            this.modal = await ModalFactory.create({\n                type: IBPickModal.TYPE,\n                templateContext: data,\n                large: true,\n            });\n            // Event listeners.\n            // Click on clear text\n            const widgetSearchElem = this.modal.body.find(\"input\")[0];\n            widgetSearchElem.value = searchText;\n            this.modal.body.find(`#widget-clearfilter-btn${data.rid}`)[0].addEventListener('click', () => {\n                widgetSearchElem.value = \"\";\n                onSearchKeyup();\n            });\n            // Click on any widget button\n            this.modal.body[0].addEventListener('click',\n                /** @param {Event} event */\n                (event) => {\n                    this.handlePickModalClick(event);\n                });\n\n            this._typeAheadInput = new TypeAheadInput(widgetSearchElem, onSearchKeyup);\n        }\n\n        // Update the list of recently used widgets\n        const snptDict = getWidgetDict(this.editor);\n        const recentWidgets = storage.getFromSession(\"recentsnpt\", \"\").split(\",\").filter(e=>e.trim()).map(key => {\n            const snpt = snptDict[key];\n            if (snpt) {\n                return {\n                    key: key,\n                    name: snpt.name\n                };\n            } else {\n                return {\n                    key: key,\n                    name: \"\"\n                };\n            }\n        });\n        let recentHTML = \"\";\n        if (recentWidgets.length) {\n            recentHTML = templateRendererMustache(Templates.RECENT_SNPT, {recent: recentWidgets});\n        }\n        this.modal.body.find(\".tiny_widgethub-recent\").html(recentHTML);\n\n        this.modal.show();\n        onSearchKeyup();\n        setTimeout(() => {\n            const widgetSearchElem = this.modal.body.find(\"input\")[0];\n            widgetSearchElem.focus();\n        }, 400);\n    }\n\n    /**\n     * Get the template context for the dialogue.\n     *\n     * @param {Object.<string, any>=} data\n     * @returns {Object.<string, any>} data\n     */\n    getPickTemplateContext(data) {\n        const allButtons = Object.values(getWidgetDict(this.editor));\n\n        /**\n         * @typedef {Object} Button\n         * @property {boolean} hidden\n         * @property {string} category\n         * @property {string} widgetkey\n         * @property {string} widgetname\n         * @property {string} widgettitle\n         * @property {string} iconname\n         * @property {boolean} disabled\n         * @property {boolean} selectable\n         * @property {string} widgetfawesome\n         */\n        /**\n         * @typedef {Object} Category\n         * @property {string} name\n         * @property {boolean} hidden\n         * @property {string} color\n         * @property {Button[]} buttons\n         */\n        /**\n         * @type {Object.<string, Category>}\n         **/\n        const categories = {};\n        allButtons.forEach(btn => {\n            const catName = btn.category.toUpperCase();\n            let found = categories[catName];\n            if (!found) {\n                const color = hashCode(catName) % 360;\n                let sat = '30%';\n                if (catName.toLowerCase() === 'obsolet') {\n                    sat = '0%'; // Gray\n                }\n                found = {\n                    name: catName,\n                    hidden: false,\n                    color: `${color},${sat}`,\n                    buttons: []\n                };\n                categories[catName] = found;\n            }\n            found.buttons.push({\n                    hidden: false,\n                    category: catName,\n                    widgetkey: btn.key,\n                    widgetname: btn.name,\n                    widgettitle: btn.name + \" \" + catName,\n                    iconname: \"fa fas fa-eye\",\n                    disabled: !btn.isUsableInScope(),\n                    selectable: btn.insertquery != null,\n                    widgetfawesome: \"\" // TODO\n            });\n        });\n        const categoriesList = Object.values(categories);\n        categoriesList.sort((a, b) => {\n            if (a.name < b.name) {\n                return -1;\n            }\n            if (a.name > b.name) {\n                return 1;\n            }\n            return 0;\n        });\n        categoriesList.forEach(cat => {\n            cat.buttons.sort();\n            cat.hidden = cat.buttons.filter(btn => !btn.hidden).length == 0;\n        });\n\n        return {rid: genID(),\n            selectMode: this.editor.selection.getContent().trim().length > 0,\n            elementid: this.editor.id,\n            categories: categoriesList, ...(data ?? {})};\n    }\n\n    /**\n     * Handle a click within the Modal.\n     *\n     * @param {Event} event The click event\n     */\n    async handlePickModalClick(event) {\n        /** @type {any} */\n        const target = event.target;\n        if (!target) {\n            return;\n        }\n        const button = target.closest('button.tiny_widgethub-btn');\n        const aRecent = target.closest('a[data-key]');\n        let widget = null;\n        if (button ?? aRecent) {\n            const selectedButton = (button ?? aRecent).dataset.key;\n            widget = getWidgetDict(this.editor)[selectedButton];\n        }\n        if (!widget) {\n            return;\n        }\n        // Must open a configuration dialogue for the current widget\n        let confirmMsg = null;\n        if (!widget.isUsableInScope()) {\n            confirmMsg = \"Aquest widget no és adequat per a la pàgina actual. Segur que voleu continuar?\";\n        }\n\n        if (confirmMsg) {\n            this.editor.windowManager.confirm(confirmMsg,\n            /** @param {*} state */\n            (state) => {\n                if (state) {\n                    this.handlePickModalAction(widget);\n                }\n            });\n        } else {\n            this.handlePickModalAction(widget);\n        }\n    }\n\n    /**\n     * @param {WidgetWrapper} widget\n     */\n    handlePickModalAction(widget) {\n        this.modal.hide();\n        const paramsController = this.getUiParamsCtrl(widget);\n        // Decide whether to show the form or directly doInsert\n        if (widget.parameters.length === 0 && !widget.instructions) {\n            // Do insert directly\n            paramsController.insertWidget({});\n        } else {\n            paramsController.handleAction();\n        }\n    }\n}"],"names":["TypeAheadInput","constructor","inputElem","callback","delay","_inputElem","_listener","this","_sfTimeout","window","clearTimeout","undefined","setTimeout","addEventListener","off","removeEventListener","toggleVisible","el","visible","classList","remove","add","Templates","widgetPlugin","editor","getUiParamsCtrl","widget","_uiParamsCtrl","destroy","UiParamsCtrl","show","modal","userId","courseId","storage","UserStorage","getInstance","selectMode","selection","getContent","trim","length","onSearchKeyup","numshown","searchText","body","find","value","setToSession","allbtns","document","querySelectorAll","allcatgs","forEach","dataset","selectable","el2","querySelector","title","count","console","log","header","removeClass","addClass","getFromSession","data","getPickTemplateContext","ModalFactory","create","type","IBPickModal","TYPE","templateContext","large","widgetSearchElem","rid","event","handlePickModalClick","_typeAheadInput","snptDict","recentWidgets","split","filter","e","map","key","snpt","name","recentHTML","recent","html","focus","allButtons","Object","values","categories","btn","catName","category","toUpperCase","found","color","sat","toLowerCase","hidden","buttons","push","widgetkey","widgetname","widgettitle","iconname","disabled","isUsableInScope","insertquery","widgetfawesome","categoriesList","sort","a","b","cat","elementid","id","target","button","closest","aRecent","selectedButton","confirmMsg","windowManager","confirm","state","handlePickModalAction","hide","paramsController","parameters","instructions","handleAction","insertWidget"],"mappings":"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"}