{"version":3,"file":"uiPick.min.js","sources":["../src/uiPick.js"],"sourcesContent":["/* eslint-disable max-len */\n/* eslint-disable no-alert */\n/* eslint-disable no-eq-null */\n/* eslint-disable no-console */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny WidgetHub plugin.\n *\n * @module      tiny_widgethub/plugin\n * @copyright   2024 Josep Mulet Pol <pmulet@iedib.net>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport ModalFactory from 'core/modal_factory';\nimport {IBPickModal} from './modal';\nimport {getCourseId, getWidgetDict, getUserId} from './options';\nimport {UserStorage, genID, hashCode, searchComp, Shared, templateRendererMustache} from './util';\nimport {UiParamsCtrl} from './uiParams';\n\n/**\n * Convert a simple input element in a typeahead widget\n */\nclass TypeAheadInput {\n    _inputElem;\n    _listener;\n    _sfTimeout;\n    constructor(inputElem, callback, delay) {\n        this._inputElem = inputElem;\n        this._listener = () => {\n            if (this._sfTimeout) {\n                window.clearTimeout(this._sfTimeout);\n                this._sfTimeout = null;\n            }\n            this._sfTimeout = window.setTimeout(() => callback(), delay || 800);\n        };\n        this._inputElem.addEventListener('keyup', this._listener);\n    }\n    off() {\n        if (this._sfTimeout) {\n            window.clearTimeout(this._sfTimeout);\n            this._sfTimeout = null;\n        }\n        if (this._listener) {\n            this._inputElem.removeEventListener('keyup', this._listener);\n        }\n    }\n}\n\n/**\n * @param {HTMLElement} el\n * @param {boolean} visible\n */\nconst toggleVisible = function(el, visible) {\n    if (visible) {\n        el.classList.remove(\"tiny_widgethub-hidden\");\n    } else {\n        el.classList.add(\"tiny_widgethub-hidden\");\n    }\n};\n\nconst Templates = {\n    RECENT_SNPT: `<div style=\"margin:10px 45px;font-size:85%;\">{{#recent}} {{#str}} recents, tiny_widgethub {{/str}}:\n    {{#name}}<a href=\"javascript:void(0)\" data-key=\"{{key}}\"><span class=\"badge badge-secondary\">{{name}}</span></a>{{/name}}\n    {{/recent}}`\n};\n\nexport class UiPickCtrl {\n    widgetPlugin;\n    editor;\n    _uiParamsCtrl;\n    modal;\n    constructor(widgetPlugin) {\n        this.widgetPlugin = widgetPlugin;\n        this.editor = widgetPlugin.editor;\n    }\n\n    getUiParamsCtrl(widget) {\n        if (this._uiParamsCtrl) {\n            this._uiParamsCtrl.destroy();\n            this._uiParamsCtrl.widget = widget;\n        } else {\n            this._uiParamsCtrl = new UiParamsCtrl(this, widget);\n        }\n        return this._uiParamsCtrl;\n    }\n\n    show() {\n        this.modal?.show();\n    }\n\n    async handleAction() {\n        const userId = getUserId(this.editor);\n        const courseId = getCourseId(this.editor);\n        const storage = UserStorage.getInstance(userId, courseId);\n\n        // Type on search input\n        const selectMode = this.editor.selection.getContent().trim().length > 0;\n\n        const onSearchKeyup = () => {\n            let numshown = 0;\n            const widgetSearchElem = this.modal.body.find(\"input\")[0];\n            const searchText = (widgetSearchElem.value || '');\n            storage.setToSession('searchtext', searchText, true);\n            const allbtns = document.querySelectorAll(\".tiny_widgethub-buttons\");\n            const allcatgs = document.querySelectorAll(\".tiny_widgethub-category\");\n\n            // Are we in selectMode, does the widget support it? insertquery\n            if (!searchText) {\n                allbtns.forEach((el) => {\n                    const visible = !selectMode || (selectMode && el.dataset.selectable === \"true\");\n                    toggleVisible(el, visible);\n                    if (visible) {\n                        numshown++;\n                    }\n                });\n            } else {\n                allbtns.forEach((el) => {\n                    let visible = !selectMode || (selectMode && el.dataset.selectable === \"true\");\n                    const el2 = el.querySelector('button');\n                    visible = visible && searchComp(el2.title + \"\", searchText);\n                    toggleVisible(el, visible);\n                    if (visible) {\n                        numshown++;\n                    }\n                });\n            }\n            allcatgs.forEach((el) => {\n                const count = el.querySelectorAll(\".tiny_widgethub-buttons:not(.tiny_widgethub-hidden)\").length;\n                toggleVisible(el, count > 0);\n            });\n            console.log(\"Num shown buttons is \", numshown);\n            // If no result show emptyList message\n            toggleVisible(this.modal.body.find(\".tiny_widgethub-emptylist\")[0], numshown == 0);\n        };\n\n\n        // Show modal with buttons.\n        if (this.modal) {\n            console.log(\"Estic en mode selecció? \" + selectMode);\n            if (selectMode) {\n                this.modal.header.find(\"span.ib-blink\").removeClass(\"tiny_widgethub-hidden\");\n            } else {\n                this.modal.header.find(\"span.ib-blink\").addClass(\"tiny_widgethub-hidden\");\n            }\n        } else {\n            const searchText = storage.getFromSession(\"searchtext\", \"\");\n            const data = this.getPickTemplateContext(userId, {\n                searchText: searchText\n            });\n            console.log(\" data  is  \", data);\n            this.modal = await ModalFactory.create({\n                type: IBPickModal.TYPE,\n                templateContext: data,\n                large: true,\n            });\n            // Event listeners.\n            // Click on clear text\n            const widgetSearchElem = this.modal.body.find(\"input\")[0];\n            widgetSearchElem.value = searchText;\n            this.modal.body.find(`#widget-clearfilter-btn${data.rid}`)[0].addEventListener('click', () => {\n                widgetSearchElem.value = \"\";\n                onSearchKeyup();\n            });\n            // Click on any widget button\n            this.modal.body[0].addEventListener('click', (event) => {\n                this.handlePickModalClick(event);\n            });\n\n            this._typeAheadInput = new TypeAheadInput(widgetSearchElem, onSearchKeyup);\n        }\n\n        // Update the list of recently used widgets\n        const snptDict = getWidgetDict(this.editor);\n        const recentWidgets = storage.getFromSession(\"recentsnpt\", \"\").split(\",\").filter(e=>e.trim()).map(key => {\n            const snpt = snptDict[key];\n            if (snpt) {\n                return {\n                    key: key,\n                    name: snpt.name\n                };\n            } else {\n                return {\n                    key: key,\n                    name: \"\"\n                };\n            }\n        });\n        let recentHTML = \"\";\n        if (recentWidgets.length) {\n            recentHTML = templateRendererMustache(Templates.RECENT_SNPT, {recent: recentWidgets});\n        }\n        this.modal.body.find(\".tiny_widgethub-recent\").html(recentHTML);\n\n        this.modal.show();\n        onSearchKeyup();\n        setTimeout(() => {\n            const widgetSearchElem = this.modal.body.find(\"input\")[0];\n            widgetSearchElem.focus();\n        }, 400);\n    }\n\n    /**\n     * Get the template context for the dialogue.\n     *\n     * @param {object} data\n     * @returns {object} data\n     */\n    getPickTemplateContext(data) {\n        const allButtons = Object.values(getWidgetDict(this.editor));\n\n        const categories = {};\n        allButtons.forEach(btn => {\n            const catName = btn.category.toUpperCase();\n            let found = categories[catName];\n            if (!found) {\n                const color = hashCode(catName) % 360;\n                let sat = '30%';\n                if (catName.toLowerCase() === 'obsolet') {\n                    sat = '0%'; // Gris\n                }\n                found = {\n                    name: catName,\n                    hide: false,\n                    color: `${color},${sat}`,\n                    buttons: []\n                };\n                categories[catName] = found;\n            }\n            found.buttons.push({\n                    hide: false,\n                    category: catName,\n                    widgetkey: btn.key,\n                    widgetname: btn.name,\n                    widgettitle: btn.name + \" \" + catName,\n                    iconname: \"fa fas fa-eye\",\n                    disabled: !btn.isUsableInScope(),\n                    selectable: btn.insertquery != null,\n                    widgetfawesome: \"\" // TODO\n            });\n        });\n        const categoriesList = Object.values(categories);\n        categoriesList.sort((a, b) => {\n            if (a.name < b.name) {\n                return -1;\n            }\n            if (a.name > b.name) {\n                return 1;\n            }\n            return 0;\n        });\n        categoriesList.forEach(cat => {\n            cat.buttons.sort();\n            cat.hidden = cat.buttons.filter(btn => !btn.hide).length == 0;\n        });\n\n        return {rid: genID(),\n            selectMode: this.editor.selection.getContent().trim().length > 0,\n            elementid: this.editor.id,\n            categories: categoriesList, ...data};\n    }\n\n    /**\n     * Handle a click within the Modal.\n     *\n     * @param {MouseEvent} event The click event\n     */\n    async handlePickModalClick(event) {\n        const button = event.target.closest('button.tiny_widgethub-btn');\n        const aRecent = event.target.closest('a[data-key]');\n        let widget = null;\n        if (button || aRecent) {\n            const selectedButton = (button || aRecent).dataset.key;\n            widget = getWidgetDict(this.editor)[selectedButton];\n        }\n        if (!widget) {\n            return;\n        }\n        // Must open a configuration dialogue for the current widget\n        let confirmMsg = null;\n        if (!widget.isUsableInScope()) {\n            confirmMsg = \"Aquest widget no és adequat per a la pàgina actual. Segur que voleu continuar?\";\n        } else if (widget.requires != null && RegExp(/^page-mod-forum/).exec(Shared.currentScope)) {\n            confirmMsg = \"Aquest widget necessita JavaScript i no funcionarà en fòrums. Segur que voleu continuar?\";\n        }\n\n        if (confirmMsg) {\n            this.editor.windowManager.confirm(confirmMsg, (state) => {\n                if (state) {\n                    this.handlePickModalAction(widget);\n                }\n            });\n        } else {\n            this.handlePickModalAction(widget);\n        }\n    }\n\n    handlePickModalAction(widget) {\n        this.modal.hide();\n        const paramsController = this.getUiParamsCtrl(widget);\n        // Decide whether to show the form or directly doInsert\n        if (widget.parameters.length === 0 && !widget.instructions) {\n            // Do insert directly\n            paramsController.insert();\n        } else {\n            paramsController.handleAction();\n        }\n    }\n}"],"names":["TypeAheadInput","constructor","inputElem","callback","delay","_inputElem","_listener","this","_sfTimeout","window","clearTimeout","setTimeout","addEventListener","off","removeEventListener","toggleVisible","el","visible","classList","remove","add","Templates","widgetPlugin","editor","getUiParamsCtrl","widget","_uiParamsCtrl","destroy","UiParamsCtrl","show","modal","userId","courseId","storage","UserStorage","getInstance","selectMode","selection","getContent","trim","length","onSearchKeyup","numshown","searchText","body","find","value","setToSession","allbtns","document","querySelectorAll","allcatgs","forEach","dataset","selectable","el2","querySelector","title","count","console","log","header","removeClass","addClass","getFromSession","data","getPickTemplateContext","ModalFactory","create","type","IBPickModal","TYPE","templateContext","large","widgetSearchElem","rid","event","handlePickModalClick","_typeAheadInput","snptDict","recentWidgets","split","filter","e","map","key","snpt","name","recentHTML","recent","html","focus","allButtons","Object","values","categories","btn","catName","category","toUpperCase","found","color","sat","toLowerCase","hide","buttons","push","widgetkey","widgetname","widgettitle","iconname","disabled","isUsableInScope","insertquery","widgetfawesome","categoriesList","sort","a","b","cat","hidden","elementid","id","button","target","closest","aRecent","selectedButton","confirmMsg","requires","RegExp","exec","Shared","currentScope","windowManager","confirm","state","handlePickModalAction","paramsController","parameters","instructions","handleAction","insert"],"mappings":"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"}