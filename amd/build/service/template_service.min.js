define("tiny_widgethub/service/template_service",["exports","core/mustache","../util"],(function(_exports,_mustache,_util){var obj;
/**
   * Tiny WidgetHub plugin.
   *
   * @module      tiny_widgethub/plugin
   * @copyright   2024 Josep Mulet Pol <pep.mulet@gmail.com>
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.TemplateSrv=void 0,_exports.createDefaultsForParam=function(param,populateRepeatable){if("repeatable"!==param.type)return param.value??"";const lst=[];if(populateRepeatable){const nitems=param.min||0;for(let i=1;i<=nitems;i++){var _param$fields;const obj={};null===(_param$fields=param.fields)||void 0===_param$fields||_param$fields.forEach((field=>{let val=field.value??"";"string"==typeof val&&val.indexOf("{{i}}")>=0&&(val=getTemplateSrv().renderMustache(val,{i:i})),obj[field.name]=val})),lst.push(obj)}}return lst},_exports.getTemplateSrv=getTemplateSrv,_mustache=(obj=_mustache)&&obj.__esModule?obj:{default:obj};const defineVar=function(text,ctx2){const pos=text.indexOf("="),varname=text.substring(0,pos).trim(),varvalue=(0,_util.evalInContext)(ctx2,text.substring(pos+1).trim());return ctx2[varname]=varvalue,varname};class TemplateSrv{constructor(mustache,ejsLoader){this.mustache=mustache,this.ejsLoader=ejsLoader}renderMustache(template,context,translations){const ctx={...context};return Object.keys(ctx).forEach((key=>{"$RND"===ctx[key]&&(ctx[key]=(0,_util.genID)())})),this.applyMustacheHelpers(ctx,translations??{}),this.mustache.render(template,ctx)}async renderEJS(template,context,translations){const ctx={...context,I18n:{}};Object.keys(ctx).forEach((key=>{"$RND"===ctx[key]&&(ctx[key]=(0,_util.genID)())}));const lang=ctx._lang;for(let wordKey in translations){const dict=translations[wordKey];ctx.I18n[wordKey]=dict[lang]||dict.en||dict.es||wordKey}try{return(await this.ejsLoader()).render(template,ctx)}catch(ex){return console.error(ex),"<p>Error: rendering EJS template.</p>"}}render(template,context,translations,engine){if(engine||(engine=template.includes("<%")?"ejs":"mustache"),"ejs"===engine)return this.renderEJS(template,context,translations);const tmpl=this.renderMustache(template,context,translations);return Promise.resolve(tmpl)}applyMustacheHelpers(ctx,translations){const self=this;ctx.if=()=>function(text,render){const pos=text.indexOf("]"),condition=text.substring(0,pos).trim().substring(1);return(0,_util.evalInContext)(ctx,condition)?render(text.substring(pos+1).trim()):""},ctx.var=()=>function(text){defineVar(text,ctx)},ctx.eval=()=>function(text){return(0,_util.evalInContext)(ctx,text)+""},ctx.I18n=()=>function(text,render){const key=render(text).trim(),dict=translations[key]||{};return dict[ctx._lang]||dict.en||dict.ca||key},ctx.each=()=>function(text){const pos=text.indexOf("]"),components=text.substring(0,pos).trim().substring(1).split(","),dim=components.length,maxValues=new Array(dim),loopVars=new Array(dim);let total=1;const cc="i".charCodeAt(0);components.forEach(((def,i)=>{const parts=def.split("=");1===parts.length&&parts.unshift(String.fromCharCode(cc+i));const cname=parts[0].trim();loopVars[i]=cname;const dm=(0,_util.evalInContext)(ctx,parts[1]);total*=dm,maxValues[i]=dm,ctx[cname]=1}));let output=[];for(let _ei=0;_ei<total;_ei++){output.push(self.mustache.render(text.substring(pos+1),ctx));let incrUp,currentDim=dim-1;do{const oldValue=ctx[loopVars[currentDim]]-1,newValue=(oldValue+1)%maxValues[currentDim]+1;ctx[loopVars[currentDim]]=newValue,incrUp=newValue<oldValue,currentDim--}while(currentDim>=0&&incrUp)}return output.join("")},ctx.for=()=>function(text){const pos=text.indexOf("]"),parts=text.substring(0,pos).trim().substring(1).split(";"),loopvar=defineVar(parts[0],ctx);let output="",maxIter=0;for(;(0,_util.evalInContext)(ctx,parts[1])&&maxIter<1e3;)output+=self.mustache.render(text.substring(pos+1),ctx),3===parts.length&&parts[2].trim()?defineVar(loopvar+"="+parts[2],ctx):ctx[loopvar]=ctx[loopvar]+1,maxIter++;return output}}}let _ejs;_exports.TemplateSrv=TemplateSrv;const ejsLoader=()=>_ejs?Promise.resolve(_ejs):new Promise(((resolve,reject)=>{window.require(["tiny_widgethub/libs/ejs-lazy"],(ejsModule=>{_ejs=ejsModule,_ejs?resolve(_ejs):reject()}),reject)}));let instanceSrv;function getTemplateSrv(){return instanceSrv||(instanceSrv=new TemplateSrv(_mustache.default,ejsLoader)),instanceSrv}}));

//# sourceMappingURL=template_service.min.js.map