define("tiny_widgethub/util",["exports","core/mustache","core/str"],(function(_exports,_mustache,_str){var obj,_document$querySelect;function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _classPrivateFieldInitSpec(obj,privateMap,value){!function(obj,privateCollection){if(privateCollection.has(obj))throw new TypeError("Cannot initialize the same private elements twice on an object")}(obj,privateMap),privateMap.set(obj,value)}function _classPrivateFieldGet(receiver,privateMap){return function(receiver,descriptor){if(descriptor.get)return descriptor.get.call(receiver);return descriptor.value}(receiver,_classExtractFieldDescriptor(receiver,privateMap,"get"))}function _classPrivateFieldSet(receiver,privateMap,value){return function(receiver,descriptor,value){if(descriptor.set)descriptor.set.call(receiver,value);else{if(!descriptor.writable)throw new TypeError("attempted to set read only private field");descriptor.value=value}}(receiver,_classExtractFieldDescriptor(receiver,privateMap,"set"),value),value}function _classExtractFieldDescriptor(receiver,privateMap,action){if(!privateMap.has(receiver))throw new TypeError("attempted to "+action+" private field on non-instance");return privateMap.get(receiver)}let Ejs;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.WidgetWrapper=_exports.UserStorage=_exports.Shared=void 0,_exports.addBaseToUrl=function(base,url){if((url=(url||"").trim()).toLowerCase().startsWith("http"))return url;return pathJoin(base,url)},_exports.addScript=function(url,id,onSuccess,onError){if(id&&null!=document.head.querySelector("script#"+id))return;const newScript=document.createElement("script");newScript.type="text/javascript",newScript.src=url,id&&newScript.setAttribute("id",id);newScript.onload=()=>{console.info("Loaded ",url),onSuccess&&onSuccess()},newScript.onerror=function(){console.error("Error loading ",url),onError&&onError()},document.head.append(newScript)},_exports.applyWidgetFilter=async function(editor,widgetTemplate,silent,mergevars){const translations=await(0,_str.get_strings)([{key:"filterres",component:"tiny_widgethub"},{key:"nochanges",component:"tiny_widgethub"}]),userWidgetFilter=createFilterFunction(widgetTemplate);if(!userWidgetFilter)return editor.notificationManager.open({text:translations[0]+": Invalid filter",type:"danger",timeout:4e3}),!1;const handleFilterResult=function(res){const out=res[0];let msg=res[1];null!=out?"string"==typeof out?(editor.setContent(out),editor.notificationManager.open({text:translations[0]+": "+msg,type:"success",timeout:5e3})):!0===out?editor.notificationManager.open({text:translations[0]+": "+msg,type:"success",timeout:5e3}):!1!==out||silent||editor.notificationManager.open({text:translations[1],type:"info",timeout:4e3}):silent||editor.notificationManager.open({text:translations[1],type:"info",timeout:4e3})},initialHTML=editor.getContent(),filteredResult=userWidgetFilter(initialHTML,editor.dom.window,mergevars);null!=filteredResult&&"object"==typeof filteredResult&&"then"in filteredResult?filteredResult.then(handleFilterResult):handleFilterResult(filteredResult||[null,"El filter no ha produït canvis"]);return!0},_exports.capitalize=void 0,_exports.cleanParameterName=function(name){return name.replace(/\$/g,"_")},_exports.convertInt=function(str,def){if(str&&"number"==typeof str)return Math.floor(str);if(!str||!(str+"").trim()||!(str+"").match(/^\s*[+-]?\d+(\.\d*)?\s*$/))return def;try{const val=parseInt(str+"");if(!isNaN(val))return val}catch(ex){}return def},_exports.createFilterFunction=createFilterFunction,_exports.findVariableByName=function(varname,listVars){if(!listVars)return null;let found=null;const len=listVars.length;let k=0;for(;k<len&&!found;)listVars[k].name===varname&&(found=listVars[k]),k++;return found},_exports.genID=genID,_exports.hashCode=function(s){let h=0;const l=(s=s||"").length;let i=0;if(l>0)for(;i<l;)h=(h<<6)+(s.charCodeAt(i)-65|0),i++;return Math.abs(h)},_exports.parseBinding=void 0,_exports.pathJoin=pathJoin,_exports.scopedEval=scopedEval,_exports.searchComp=function(str1,needle){return str1=(str1||"").trim().toLowerCase(),needle=(needle||"").trim().toLowerCase(),str1=str1.replace(/[àáâãäå]/,"a").replace(/[èéêë]/,"e").replace(/[ìíîï]/,"i").replace(/[òóôö]/,"o").replace(/[ùúüû]/,"u").replace(/ç/,"c").replace(/·/,""),needle=needle.replace(/[àáâãäå]/,"a").replace(/[èéêë]/,"e").replace(/[ìíîï]/,"i").replace(/[òóôö]/,"o").replace(/[ùúüû]/,"u").replace(/ç/,"c").replace(/·/,""),str1.indexOf(needle)>=0},_exports.stream=function(transformStr){return new Builder(transformStr)},_exports.templateRenderer=templateRenderer,_exports.templateRendererMustache=templateRendererMustache,_mustache=(obj=_mustache)&&obj.__esModule?obj:{default:obj};const Shared={currentScope:null===(_document$querySelect=document.querySelector("body"))||void 0===_document$querySelect?void 0:_document$querySelect.id,activatePopup:!0,globalConfig:{}};function genID(){return"g"+Math.random().toString(32).substring(2)}function scopedEval(ctx,expr){const listArgs=[],listVals=[];ctx&&Object.keys(ctx).forEach((key=>{"function"!=typeof ctx[key]&&(listArgs.push(key),listVals.push(ctx[key]))})),listArgs.push("expr"),listArgs.push("return eval(expr)"),listVals.push(expr);return new Function(...listArgs)(...listVals)}_exports.Shared=Shared;const defineVar=function(text,ctx2){const pos=text.indexOf("="),varname=text.substring(0,pos).trim(),varvalue=scopedEval(ctx2,text.substring(pos+1).trim());return ctx2[varname]=varvalue,varname};function templateRendererMustache(template,context,translations){const ctx={...context};return Object.keys(ctx).forEach((key=>{"$RND"===ctx[key]&&(ctx[key]=genID())})),function(ctx,translations){ctx.if=()=>function(text,render){const pos=text.indexOf("]"),condition=text.substring(0,pos).trim().substring(1);return scopedEval(ctx,condition)?render(text.substring(pos+1).trim()):""},ctx.var=()=>function(text){defineVar(text,ctx)},ctx.eval=()=>function(text){return scopedEval(ctx,text)+""},ctx.I18n=()=>function(text,render){const key=render(text).trim(),dict=translations[key]||{};return dict[ctx.LANG]||dict.en||dict.ca||key},ctx.each=()=>function(text){const pos=text.indexOf("]"),components=text.substring(0,pos).trim().substring(1).split(","),dim=components.length,maxValues=new Array(dim),loopVars=new Array(dim);let total=1;const cc="i".charCodeAt();components.forEach(((def,i)=>{const parts=def.split("=");1===parts.length&&parts.unshift(String.fromCharCode(cc+i));const cname=parts[0].trim();loopVars[i]=cname;const dm=scopedEval(ctx,parts[1]);total*=dm,maxValues[i]=dm,ctx[cname]=1}));let output=[];for(let _ei=0;_ei<total;_ei++){output.push(_mustache.default.render(text.substring(pos+1),ctx));let incrUp,currentDim=dim-1;do{const oldValue=ctx[loopVars[currentDim]]-1,newValue=(oldValue+1)%maxValues[currentDim]+1;ctx[loopVars[currentDim]]=newValue,incrUp=newValue<oldValue,currentDim--}while(currentDim>=0&&incrUp)}return output.join("")},ctx.for=()=>function(text){const pos=text.indexOf("]"),parts=text.substring(0,pos).trim().substring(1).split(";"),loopvar=defineVar(parts[0],ctx);let output="",maxIter=0;for(;scopedEval(ctx,parts[1])&&maxIter<1e3;)output+=_mustache.default.render(text.substring(pos+1),ctx),3===parts.length&&parts[2].trim()?defineVar(loopvar+"="+parts[2]):ctx[loopvar]=ctx[loopvar]+1,maxIter++;return output}}(ctx,translations||{}),_mustache.default.render(template,ctx)}async function templateRendererEJS(template,context,translations){const ctx={...context,I18n:{}};Object.keys(ctx).forEach((key=>{"$RND"===ctx[key]&&(ctx[key]=genID())}));const lang=ctx.LANG;for(let wordKey in translations){const dict=translations[wordKey];ctx.I18n[wordKey]=dict[lang]||dict.en||dict.es||wordKey}return(await(Ejs?Promise.resolve(Ejs):new Promise(((resolve,reject)=>{require(["tiny_widgethub/ejs-lazy"],(ejsModule=>{Ejs=ejsModule,resolve(Ejs)}),reject)})))).render(template,ctx)}function templateRenderer(template,context,translations,engine){if(engine||(engine=template.includes("<%")?"ejs":"mustache"),"ejs"===engine)return templateRendererEJS(template,context,translations);const tmpl=templateRendererMustache(template,context,translations);return Promise.resolve(tmpl)}var _widget=new WeakMap,_instructionsParsed=new WeakMap;_exports.WidgetWrapper=class{constructor(snpt,partials){var _snpt$parameters;_classPrivateFieldInitSpec(this,_widget,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,_instructionsParsed,{writable:!0,value:!1}),null===(_snpt$parameters=snpt.parameters)||void 0===_snpt$parameters||_snpt$parameters.forEach(((param,i)=>{if(param.partial){if(!partials[param.partial])return void console.error("Cannot find partial for ",param.partial,partials);snpt.parameters[i]=partials[param.partial]}param.type||("boolean"==typeof param.value?param.type="checkbox":"number"==typeof param.value?param.type="numeric":"string"==typeof param.value&&(param.type=param.options?"select":"textfield"))})),_classPrivateFieldSet(this,_widget,snpt)}get name(){return _classPrivateFieldGet(this,_widget).name}get key(){return _classPrivateFieldGet(this,_widget).key}get I18n(){return _classPrivateFieldGet(this,_widget).I18n||{}}get template(){return _classPrivateFieldGet(this,_widget).template}get category(){return _classPrivateFieldGet(this,_widget).category||"MISC"}get insertquery(){return _classPrivateFieldGet(this,_widget).insertquery}get selectors(){return _classPrivateFieldGet(this,_widget).selectors}get unwrap(){return _classPrivateFieldGet(this,_widget).uwrap}get version(){return _classPrivateFieldGet(this,_widget).version||"1.0.0"}get instructions(){return _classPrivateFieldGet(this,_instructionsParsed)||(_classPrivateFieldGet(this,_widget).instructions=decodeURIComponent(_classPrivateFieldGet(this,_widget).instructions),_classPrivateFieldSet(this,_instructionsParsed,!0)),_classPrivateFieldGet(this,_widget).instructions}get parameters(){return _classPrivateFieldGet(this,_widget).parameters||[]}get defaults(){const obj={};return this.parameters.forEach((param=>{obj[param.name]=param.value})),obj}render(ctx){var _this$template,_classPrivateFieldGet2;const defaultsCopy={...this.defaults},toInterpolate=Object.assign(defaultsCopy,ctx||{});let engine=_classPrivateFieldGet(this,_widget).engine;return templateRenderer(null!==(_this$template=this.template)&&void 0!==_this$template?_this$template:"",toInterpolate,null!==(_classPrivateFieldGet2=_classPrivateFieldGet(this,_widget).I18n)&&void 0!==_classPrivateFieldGet2?_classPrivateFieldGet2:{},engine)}isFor(userId){if(!0===_classPrivateFieldGet(this,_widget).hidden)return!1;let grantStr=(_classPrivateFieldGet(this,_widget).for||"").trim();if(""===grantStr||"*"===grantStr||userId<=2)return!0;let allowMode=!0;grantStr.startsWith("-")&&(allowMode=!1),grantStr=grantStr.replace(/[+\- ]/g,"");const grantList=grantStr.split(",");return allowMode&&grantList.indexOf(userId+"")>=0||!allowMode&&grantList.indexOf(userId+"")<0}isUsableInScope(scope){scope=scope||Shared.currentScope;const widgetScopes=_classPrivateFieldGet(this,_widget).scope;if(!scope||!widgetScopes||"*"===widgetScopes)return!0;return null!=new RegExp(widgetScopes).exec(scope)}isFilter(){var _this$category;return"filtres"===(null===(_this$category=this.category)||void 0===_this$category?void 0:_this$category.toLowerCase())}hasBindings(){return this.parameters.filter((param=>void 0!==param.bind)).length>0}prop(name){return _classPrivateFieldGet(this,_widget)[name]}};class UserStorage{static getInstance(userId,courseId){const key=userId+"_"+courseId;return UserStorage._instances[key]||(UserStorage._instances[key]=new UserStorage(userId,courseId)),UserStorage._instances[key]}constructor(userId,courseId){_defineProperty(this,"_userId",0),_defineProperty(this,"_courseId",0),_defineProperty(this,"_localStore",void 0),_defineProperty(this,"_sessionStore",void 0),_defineProperty(this,"STORE_KEY",void 0),this._userId=userId,this._courseId=courseId,this.STORE_KEY="iedib-widgets_"+userId,this._localStore={valors:{}},this._sessionStore={searchtext:""},this.loadStore()}loadStore(){if(void 0!==window.localStorage){const txt=window.localStorage.getItem(this.STORE_KEY);if(txt)try{this._localStore=JSON.parse(txt)}catch(ex){console.error(ex)}}if(this._localStore["_"+this._courseId]||(this._localStore["_"+this._courseId]={}),void 0!==window.sessionStorage){const txt2=window.sessionStorage.getItem(this.STORE_KEY);if(txt2)try{this._sessionStore=JSON.parse(txt2)}catch(ex){console.error(ex)}}}getFromLocal(key,defaultValue){if(!this._localStore)return defaultValue;const MLSC=this._localStore["_"+this._courseId],MLS=this._localStore;return MLSC?MLSC[key]||MLS[key]||defaultValue:MLS&&MLS[key]||defaultValue}getFromSession(key,defaultValue){return null!=this._sessionStore[key]?this._sessionStore[key]:defaultValue}saveStore(type){"local"===type&&void 0!==window.localStorage?window.localStorage.setItem(this.STORE_KEY,JSON.stringify(this._localStore)):"session"===type&&void 0!==window.sessionStorage?window.sessionStorage.setItem(this.STORE_KEY,JSON.stringify(this._sessionStore)):null==type&&(void 0!==window.localStorage&&window.localStorage.setItem(this.STORE_KEY,JSON.stringify(this._localStore)),void 0!==window.sessionStorage&&window.sessionStorage.setItem(this.STORE_KEY,JSON.stringify(this._sessionStore)))}setToLocal(key,value,persist){if(null==this._localStore)return;const MLSC=this._localStore["_"+this._courseId],MLS=this._localStore;if("object"==typeof theValueMap){MLSC&&"saveall_data"===key||"valors"===key?MLSC[key]=MLSC[key]||{}:MLS[key]=MLS[key]||{};const keys=Object.keys(value);for(let i=0,len=keys.length;i<len;i++){const theKey=keys[i],val=value[theKey];MLSC&&"saveall_data"===key||"valors"===key?MLSC[key][theKey]=val:MLS[key][theKey]=val}}else MLS[key]=value;persist&&this.saveStore("local")}setToSession(key,value,persist){if("object"==typeof value){this._sessionStore[key]=this._sessionStore[key]||{};const keys=Object.keys(value);for(let i=0,len=keys.length;i<len;i++){const theKey=keys[i],val=value[theKey];this._sessionStore[key][theKey]=val}}else this._sessionStore[key]=value;persist&&this.saveStore("session")}}_exports.UserStorage=UserStorage,_defineProperty(UserStorage,"_instances",{});const Transformers={toUpperCase:function(txt){return(txt+"").toUpperCase()},toLowerCase:function(txt){return(txt+"").toLowerCase()},trim:function(txt){return(txt+"").trim()},ytId:function(txt){const r=(txt||"").match(/^.*(?:(?:youtu\.be\/|v\/|vi\/|u\/\w\/|embed\/|shorts\/)|(?:(?:watch)?\?v(?:i)?=|&v(?:i)?=))([^#&?]*).*/);return null!=r&&r.length?r[1]:txt},vimeoId:function(txt){const match=(txt||"").match(/^.*(vimeo\.com\/)((channels\/[A-z]+\/)|(groups\/[A-z]+\/videos\/))?(\d+)/);return null!=match&&match[5]?match[5]:txt},serveGDrive:function(txt){const res=(txt+"").match(/https:\/\/drive.google.com\/file\/d\/([a-zA-Z0-9_]+)\//);if(null!=res&&res.length){return"https://docs.google.com/uc?export=open&id="+res[1]}return txt},removeHTML:function(txt){return(txt||"").replace(/<[^>]*>?/gm,"")},escapeHTML:function(txt){return(txt||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},encodeHTML:function(txt){return this.encodeURIComponent(txt||"")},escapeQuotes:function(txt){return(txt||"").replace(/"/gm,"'")}};class Builder{constructor(transformStr){_defineProperty(this,"transSeq",void 0);const parts=transformStr.split("|");this.transSeq=[];for(let j=0,lenj=parts.length;j<lenj;j++){const prts=parts[j].trim(),transfunc=Transformers[prts];null!=transfunc?this.transSeq.push(transfunc):console.error("Cannot find transformer named "+prts)}}reduce(text){for(let j=0,lenj=this.transSeq.length;j<lenj;j++){text=(0,this.transSeq[j])(text)}return text}}function createFilterFunction(filterCode){filterCode=filterCode.replace("\x3c!--<widgetcode>","").replace("</widgetcode>--\x3e","");let userWidgetFilter=null;try{userWidgetFilter=new Function("text","tiny","opts",filterCode)}catch(ex){userWidgetFilter=null,console.error(ex)}return userWidgetFilter}function pathJoin(a,b){return a=(a||"").trim(),b=(b||"").trim(),a.endsWith("/")||(a+="/"),b.startsWith("/")&&(b=b.substring(1)),a+b}const performCasting=function(value,type){switch(type){case"boolean":value=1===value||"1"===value||!0===value||"true"===value;break;case"number":try{value=parseInt(value)}catch(ex){console.error("Error parsing number",ex)}break;case"string":value+=""}return value},BindingFactory={hasClass:class{constructor(elem,className,castTo,neg){this.elem=elem,this.castTo=castTo,this.neg=neg,this.className=className}getValue(){const res=this.neg^this.elem.classList.contains(this.className);return"boolean"===this.castTo?Boolean(res):res}setValue(bool){this.neg^bool?this.elem.classList.add(this.className):this.elem.classList.remove(this.className)}},classRegex:class{constructor(elem,classExpr,castTo){this.elem=elem,this.castTo=castTo,this.classExpr=classExpr}getValue(){let ret="";return this.elem.classList.forEach((c=>{const match=c.match(this.classExpr);null!=match&&match[1]&&"string"==typeof match[1]&&(ret=match[1])})),performCasting(ret,this.castTo)}setValue(val){const cl=this.elem.classList;cl.forEach((c=>{c.match(this.classExpr)&&cl.remove(c)})),cl.add(this.classExpr.replace("(.*)",val+""))}},attr:class{constructor(elem,attrName,castTo){this.elem=elem,this.castTo=castTo,this.attrName=attrName}getValue(){return performCasting(this.elem.getAttribute(this.attrName),this.castTo)}setValue(val){return"boolean"==typeof val&&(val=val?1:0),this.elem.setAttribute(this.attrName,val+"")}},hasAttr:class{constructor(elem,attr,castTo,neg){this.elem=elem,this.castTo=castTo,this.neg=neg;const parts=attr.split("=");this.attrName=parts[0].trim(),parts.length>1&&(this.attrValue=parts[1].replace(/["']/g,"").trim())}getValue(){let found=null!=this.elem.getAttribute(this.attrName);this.attrValue&&(found=found&&this.elem.getAttribute(this.attrName)===this.attrValue);const res=this.neg^found;return"boolean"===this.castTo?Boolean(res):res}setValue(bool){this.neg^bool?this.elem.setAttribute(this.attrName,this.attrValue||""):this.elem.removeAttribute(this.attrName)}},attrRegex:class{constructor(elem,attr,castTo){this.elem=elem,this.castTo=castTo;const parts=attr.split("=");this.attrName=parts[0].trim(),parts.length>1&&(this.attrValue=parts[1].replace(/["']/g,"").trim())}getValue(){if(null!=this.elem.getAttribute(this.attrName)){const match=this.elem.getAttribute(this.attrName).match(this.attrValue);return null!=match&&match[1]&&"string"==typeof match[1]?performCasting(match[1],this.castTo):""}return null}setValue(val){this.elem.setAttribute(this.attrName,this.attrValue.replace("(.*)",val+""))}},hasStyle:class{constructor(elem,attr,castTo,neg){this.elem=elem,this.castTo=castTo,this.neg=neg;const parts=attr.split(":");this.styName=parts[0].trim(),parts.length>1&&(this.styValue=parts[1].replace(/["']/g,"").trim())}getValue(){const res=this.elem.style.getPropertyValue(this.styName)===this.styValue^this.neg;return"boolean"===this.castTo?Boolean(res):res}setValue(bool){bool^this.neg?this.elem.style.setProperty(this.styName,this.styValue):this.elem.style.removeProperty(this.styName)}},styleRegex:class{constructor(elem,attr,castTo){this.elem=elem,this.castTo=castTo;const parts=attr.split(":");this.styName=parts[0].trim(),parts.length>1&&(this.styValue=parts[1].replace(/["']/g,"").trim())}getValue(){const st=this.elem.style;if(null!=st.getPropertyValue(this.styName)){const match=st.getPropertyValue(this.styName).match(this.styValue);return null!=match&&match[1]&&"string"==typeof match[1]?performCasting(match[1],this.castTo):""}return null}setValue(val){this.elem.style.setProperty(this.styName,this.styValue.replace("(.*)",val+""))}}};_exports.parseBinding=(definition,elem,castTo)=>{if(!definition||!elem)return null;const m=/^\s*(?:<([^<>]+)>)?\s*(not\s+)?(classRegex|hasClass|styleRegex|hasStyle|attr|attrRegex|hasAttr)\s+<([^<>]+)>\s*$/g.exec(definition);if(m){m[1]&&(elem=elem.querySelector(m[1]));const neg=void 0!==m[2],type=m[3],params=m[4];return new BindingFactory[type](elem,params,castTo,neg)}return null};_exports.capitalize=s=>s&&s[0].toUpperCase()+s.slice(1)||""}));

//# sourceMappingURL=util.min.js.map