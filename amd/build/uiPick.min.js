define("tiny_widgethub/uiPick",["exports","core/modal_factory","./modal","./options","./util","./uiParams","./commands"],(function(_exports,_modal_factory,_modal,_options,_util,_uiParams,_commands){var obj;function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.UiPickCtrl=void 0,_modal_factory=(obj=_modal_factory)&&obj.__esModule?obj:{default:obj};class TypeAheadInput{constructor(inputElem,callback,delay){_defineProperty(this,"_inputElem",void 0),_defineProperty(this,"_listener",void 0),_defineProperty(this,"_sfTimeout",void 0),this._inputElem=inputElem,this._listener=()=>{this._sfTimeout&&(window.clearTimeout(this._sfTimeout),this._sfTimeout=void 0),this._sfTimeout=window.setTimeout((()=>callback()),null!=delay?delay:800)},this._inputElem.addEventListener("keyup",this._listener)}off(){this._sfTimeout&&(window.clearTimeout(this._sfTimeout),this._sfTimeout=void 0),this._listener&&this._inputElem.removeEventListener("keyup",this._listener)}}const toggleVisible=function(el,visible){visible?el.classList.remove("tiny_widgethub-hidden"):el.classList.add("tiny_widgethub-hidden")},Templates_RECENT_SNPT='<div style="margin:10px 45px;font-size:85%;">{{#recent}} {{#str}} recents, tiny_widgethub {{/str}}:\n    {{#name}}<a href="javascript:void(0)" data-key="{{key}}"><span class="badge badge-secondary">{{name}}</span></a>{{/name}}\n    {{/recent}}';_exports.UiPickCtrl=class{constructor(widgetPlugin){_defineProperty(this,"widgetPlugin",void 0),_defineProperty(this,"editor",void 0),_defineProperty(this,"_uiParamsCtrl",void 0),_defineProperty(this,"modal",void 0),this.widgetPlugin=widgetPlugin,this.editor=widgetPlugin.editor}getUiParamsCtrl(widget){return this._uiParamsCtrl?(this._uiParamsCtrl.destroy(),this._uiParamsCtrl.widget=widget):this._uiParamsCtrl=new _uiParams.UiParamsCtrl(this,widget),this._uiParamsCtrl}show(){var _this$modal;null===(_this$modal=this.modal)||void 0===_this$modal||_this$modal.show()}async handleAction(){const userId=(0,_options.getUserId)(this.editor),courseId=(0,_options.getCourseId)(this.editor),storage=_util.UserStorage.getInstance(userId,courseId),selectMode=this.editor.selection.getContent().trim().length>0,onSearchKeyup=()=>{let numshown=0;const searchText=this.modal.body.find("input")[0].value||"";storage.setToSession("searchtext",searchText,!0);const allbtns=document.querySelectorAll(".tiny_widgethub-buttons"),allcatgs=document.querySelectorAll(".tiny_widgethub-category");searchText?allbtns.forEach((el=>{let visible=!selectMode||selectMode&&"true"===el.dataset.selectable;const el2=el.querySelector("button");visible=visible&&(0,_util.searchComp)((null==el2?void 0:el2.title)+"",searchText),toggleVisible(el,visible),visible&&numshown++})):allbtns.forEach((el=>{const visible=!selectMode||selectMode&&"true"===el.dataset.selectable;toggleVisible(el,visible),visible&&numshown++})),allcatgs.forEach((el=>{const count=el.querySelectorAll(".tiny_widgethub-buttons:not(.tiny_widgethub-hidden)").length;toggleVisible(el,count>0)})),console.log("Num shown buttons is ",numshown),toggleVisible(this.modal.body.find(".tiny_widgethub-emptylist")[0],0==numshown)};if(this.modal)console.log("Estic en mode selecció? "+selectMode),selectMode?this.modal.header.find("span.ib-blink").removeClass("tiny_widgethub-hidden"):this.modal.header.find("span.ib-blink").addClass("tiny_widgethub-hidden");else{const searchText=storage.getFromSession("searchtext",""),data=this.getPickTemplateContext({searchText:searchText});console.log(" data  is  ",data),this.modal=await _modal_factory.default.create({type:_modal.IBPickModal.TYPE,templateContext:data,large:!0});const widgetSearchElem=this.modal.body.find("input")[0];widgetSearchElem.value=searchText,this.modal.body.find("#widget-clearfilter-btn".concat(data.rid))[0].addEventListener("click",(()=>{widgetSearchElem.value="",onSearchKeyup()})),this.modal.body[0].addEventListener("click",(event=>{this.handlePickModalClick(event)})),this._typeAheadInput=new TypeAheadInput(widgetSearchElem,onSearchKeyup)}const snptDict=(0,_options.getWidgetDict)(this.editor),recentWidgets=storage.getFromSession("recentsnpt","").split(",").filter((e=>e.trim())).map((key=>{const snpt=snptDict[key];return snpt?{key:key,name:snpt.name}:{key:key,name:""}}));let recentHTML="";recentWidgets.length&&(recentHTML=(0,_util.templateRendererMustache)(Templates_RECENT_SNPT,{recent:recentWidgets})),this.modal.body.find(".tiny_widgethub-recent").html(recentHTML),this.modal.show(),onSearchKeyup(),setTimeout((()=>{this.modal.body.find("input")[0].focus()}),400)}getPickTemplateContext(data){const allButtons=Object.values((0,_options.getWidgetDict)(this.editor)),categories={};allButtons.forEach((btn=>{const catName=btn.category.toUpperCase();let found=categories[catName];if(!found){const color=(0,_util.hashCode)(catName)%360;let sat="30%";"obsolet"===catName.toLowerCase()&&(sat="0%"),found={name:catName,hidden:!1,color:"".concat(color,",").concat(sat),buttons:[]},categories[catName]=found}found.buttons.push({hidden:!1,category:catName,widgetkey:btn.key,widgetname:btn.name,widgettitle:btn.name+" "+catName,iconname:"fa fas fa-eye",disabled:!btn.isUsableInScope(),selectable:null!=btn.insertquery,widgetfawesome:""})}));const categoriesList=Object.values(categories);return categoriesList.sort(((a,b)=>a.name<b.name?-1:a.name>b.name?1:0)),categoriesList.forEach((cat=>{cat.buttons.sort(),cat.hidden=0==cat.buttons.filter((btn=>!btn.hidden)).length})),{rid:(0,_util.genID)(),selectMode:this.editor.selection.getContent().trim().length>0,elementid:this.editor.id,categories:categoriesList,...null!=data?data:{}}}async handlePickModalClick(event){const target=event.target;if(!target)return;const button=target.closest("button.tiny_widgethub-btn"),aRecent=target.closest("a[data-key]");let widget=null;if(null!=button?button:aRecent){const selectedButton=(null!=button?button:aRecent).dataset.key;widget=(0,_options.getWidgetDict)(this.editor)[selectedButton]}if(!widget)return;let confirmMsg=null;widget.isUsableInScope()||(confirmMsg="Aquest widget no és adequat per a la pàgina actual. Segur que voleu continuar?"),confirmMsg?this.editor.windowManager.confirm(confirmMsg,(state=>{state&&this.handlePickModalAction(widget)})):this.handlePickModalAction(widget)}handlePickModalAction(widget){this.modal.hide();const paramsController=this.getUiParamsCtrl(widget);0!==widget.parameters.length||widget.instructions?paramsController.handleAction():paramsController.insertWidget({})}}}));

//# sourceMappingURL=uiPick.min.js.map