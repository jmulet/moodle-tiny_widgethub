{"version":3,"file":"contextmenus.min.js","sources":["../../src/extension/contextmenus.js"],"sourcesContent":["/* eslint-disable no-console */\n/* eslint-disable max-len */\nimport {registerMenuItemProvider} from \"../extension\";\nimport {convertInt, findVariableByName} from \"../util\";\nimport * as Action from './contextactions';\n\nconst SUPPORTED_LANGS = [\n    {iso: 'ca', title: 'Català'},\n    {iso: 'es', title: 'Castellà'},\n    {iso: 'en', title: 'English'},\n    {iso: 'fr', title: 'Francès'},\n    {iso: 'de', title: 'Alemany'},\n];\n\nconst AVAILABLE_EFFECTS = [\n    {name: 'zoom', title: 'Zoom'},\n    {name: 'lightbox', title: 'Pantalla completa'},\n];\n\nconst SUPPORTED_SIZES = [\n    {v: 'gran', l: 'Gran'},\n    {v: 'mitjana', l: 'Mitjana'},\n    {v: 'petita', l: 'Petita'},\n];\n\n/**\n * @typedef {{type: string, text: string, icon?: string, onAction: (api?: *) => void}} MenuItem\n * @typedef {{name: string, title: string, condition?: string | RegExp | (() => boolean), icon?:string, onAction?: ()=> void, subMenuItems?: () => string | MenuItem[]}} UserDefinedItem\n */\n\n/**\n * @param {import(\"../contextInit\").ItemMenuContext} ctx\n * @returns {UserDefinedItem[]}\n **/\nfunction provider(ctx) {\n    /**\n     * @param {string} title\n     * @param {string} label\n     * @param {*} initialValue\n     * @param {(api: *) => void} onSubmit\n     */\n    const openInputDialog = function(title, label, initialValue, onSubmit) {\n        ctx.editor?.windowManager.open({\n            title,\n            body: {\n              type: 'panel',\n              items: [\n                {\n                  type: 'input',\n                  name: 'value',\n                  label: label\n                }\n              ]\n            },\n            buttons: [\n              {\n                type: 'submit',\n                text: 'Acceptar'\n              }\n            ],\n            initialData: {\n                value: initialValue\n            },\n            onSubmit\n        });\n    };\n\n    /**\n     * @param {import(\"../contextInit\").ItemMenuContext} ctx\n     * @returns {UserDefinedItem}\n     */\n    const imageEffectsNestedMenu = {\n        name: 'imageEffects',\n        condition: 'imatge',\n        title: 'Efectes d\\'imatge',\n        subMenuItems: () => {\n            const elem = ctx.path?.elem;\n            if (!elem) {\n                return '';\n            }\n            if (!elem.attr('data-snptd')) {\n                return AVAILABLE_EFFECTS.map(e => ({\n                    type: 'menuitem',\n                    text: e.title,\n                    onAction: Action.addImageEffectAction(ctx, e.name)\n                }));\n            } else {\n                return [{\n                    type: 'menuitem',\n                    icon: 'remove',\n                    text: 'Treure',\n                    onAction: Action.removeImageEffectsAction(ctx)\n                }];\n            }\n        }\n    };\n\n    /**\n     * Converts a raw image into a snippet\n     * @param {import(\"../contextInit\").ItemMenuContext} ctx\n     * @returns {UserDefinedItem}\n     */\n    const imageSwitchToSnippet = {\n        name: 'imageSwitchToSnippet',\n        condition: () => {\n           // We are not inside a widget image and the\n           // selectedElement right clicked must be a tag img\n           const key = ctx.path?.widget?.key;\n           const elem = ctx.path?.selectedElement;\n           const isImg = (key !== undefined && key !== 'imatge' && key !== 'grid-imatge' &&\n            elem?.prop('tagName') === 'IMG');\n           if (ctx.path && isImg && elem?.[0]) {\n                ctx.path.targetElement = elem;\n           }\n           return isImg;\n        },\n        title: 'Convertir a snippet imatge',\n        onAction: Action.imageSwitchToSnippetAction(ctx)\n    };\n\n    /**\n     * @param {import(\"../contextInit\").ItemMenuContext} ctx\n     * @returns {UserDefinedItem}\n     */\n     const changeBoxLanguageNestedMenu = {\n        name: 'changeBoxLanguage',\n        condition: /capsa-.*|tasca-exercici/,\n        title: 'Idioma',\n        subMenuItems: () => {\n            const elem = ctx.path?.elem;\n            if (!elem) {\n                return '';\n            }\n            const currentLang = elem.attr('data-lang') ?? '';\n            return SUPPORTED_LANGS.map(({iso, title}) => ({\n                type: 'menuitem',\n                text: title,\n                icon: iso === currentLang ? 'checkmark' : undefined,\n                onAction: Action.changeBoxLangAction(ctx, iso)\n            }));\n        }\n    };\n\n     /**\n      * @param {import(\"../contextInit\").ItemMenuContext} ctx\n      * @returns {UserDefinedItem}\n      */\n     const changeBoxSizeNestedMenu = {\n        name: 'changeBoxSize',\n        condition: /^capsa-.*|^tasca-exercici$/,\n        title: 'Mida',\n        subMenuItems: () => {\n            const elem = ctx.path?.elem;\n            const widget = ctx.path?.widget;\n            if (!elem || !widget) {\n                return '';\n            }\n            const sizes = findVariableByName('mida', widget.parameters)?.options;\n            return (sizes || SUPPORTED_SIZES).map((/** @type {*}*/ e) => ({\n                type: 'menuitem',\n                text: e.l ?? e,\n                icon: elem.hasClass('iedib-capsa-' + (e.v ?? e)) ? 'checkmark' : undefined,\n                onAction: Action.changeBoxSizeAction(ctx, e.v ?? e)\n            }));\n        }\n    };\n\n      /**\n       * @param {import(\"../contextInit\").ItemMenuContext} ctx\n       * @returns {UserDefinedItem}\n       */\n      const changeBoxSeverityNestedMenu = {\n        name: 'changeBoxSeverity',\n        condition: 'capsa-generica',\n        title: 'Tipus',\n        subMenuItems: () => {\n            const elem = ctx.path?.elem;\n            const widget = ctx.path?.widget;\n            if (!elem || !widget) {\n                return '';\n            }\n            const severities = findVariableByName('tipus', widget.parameters)?.options;\n            return (severities || []).map((/** @type {*}*/ e) => ({\n                type: 'menuitem',\n                text: e.l ?? e,\n                icon: elem.hasClass('iedib-' + (e.v ?? e) + '-border') ? 'checkmark' : undefined,\n                onAction: Action.changeBoxSeverityAction(ctx, e.v ?? e)\n            }));\n        }\n    };\n\n      /**\n       * @param {import(\"../contextInit\").ItemMenuContext} ctx\n       * @returns {UserDefinedItem}\n       */\n      const switchBoxRowsExample = {\n        name: 'switchBoxRowsExample',\n        condition: 'capsa-exemple-cols',\n        title: 'Convertir a exemple 2 files',\n        onAction: Action.switchBoxRowsExampleAction(ctx)\n    };\n\n     /**\n      * @param {import(\"../contextInit\").ItemMenuContext} ctx\n      * @returns {UserDefinedItem}\n      */\n     const switchBoxSimpleExample = {\n        name: 'switchBoxSimpleExample',\n        condition: 'capsa-exemple-rows',\n        title: 'Convertir a exemple simple',\n        onAction: Action.switchBoxSimpleExampleAction(ctx)\n    };\n\n    /**\n     * @param {import(\"../contextInit\").ItemMenuContext} ctx\n     * @returns {UserDefinedItem}\n     */\n    const numberedListNestedMenu = {\n        name: 'numberedListNestedMenu',\n        condition: () => {\n            const selectedElement = ctx.path?.selectedElement;\n            // It must search an OL in the path, probably selectedElement is LI or so!!!!!\n            const target = selectedElement?.closest(\"ol\");\n            if (ctx.path && target?.[0]) {\n                ctx.path.targetElement = target;\n            }\n            return target?.[0] !== undefined;\n        },\n        icon: 'list-num-default',\n        title: 'Llista',\n        subMenuItems: () => {\n            // Determine if the class is there\n            const isBeauty = ctx.path?.targetElement?.hasClass('iedib-falist');\n            return [\n                {\n                    type: 'menuitem',\n                    text: 'Embellit',\n                    icon: isBeauty ? 'checkmark' : undefined,\n                    onAction: () => {\n                        console.log(\"beauty action\");\n                        // Toggle class\n                        const $target = ctx.path?.targetElement;\n                        if (!$target) {\n                            return;\n                        }\n                        $target.toggleClass('iedib-falist');\n                        // Make sure that start and style are in sync\n                        const startAt = $target.attr(\"start\") || \"1\";\n                        if ($target.hasClass('iedib-falist')) {\n                            const beginAt = parseInt(startAt);\n                            $target.css(\"counter-reset\", \"iedibfalist-counter \" + (beginAt - 1));\n                        } else {\n                            $target.css(\"counter-reset\", \"\");\n                        }\n                    }\n                },\n                {\n                    type: 'menuitem',\n                    text: 'Comença a',\n                    onAction: () => {\n                        console.log(\"start at\");\n                        // Get the start property of the list\n                        const startAt1 = ctx.path?.targetElement?.attr(\"start\") ?? \"1\";\n                        // Open input dialog, set the value and retrieve new value\n                        openInputDialog('Comença la numeració a ...', '', startAt1,\n                        (/** @type {*} */ api) => {\n                            api.close();\n                            const $target = ctx.path?.targetElement;\n                            if (!$target) {\n                                return;\n                            }\n                            // Change the number at which start\n                            const startAt2 = api.getData().value ?? \"1\";\n                            const beginAt3 = convertInt(startAt2, 1);\n                            $target.attr(\"start\", beginAt3);\n                            $target.css(\"counter-reset\", \"iedibfalist-counter \" + (beginAt3 - 1));\n                        });\n                    },\n                }\n            ];\n        }\n    };\n\n    /**\n     * @param {import(\"../contextInit\").ItemMenuContext} ctx\n     * @returns {UserDefinedItem}\n     */\n    const tablesMaxWidthMenu = {\n        name: 'tablesMaxWidthMenu',\n        condition: 'taula-predefinida,taula-bs',\n        title: 'Amplada taula',\n        onAction: () => {\n            const $target = ctx.path?.elem;\n            if (!$target) {\n                return;\n            }\n            // Get the initial width\n            const startAt1 = ($target.css(\"max-width\") || \"-1\").replace(\"px\", \"\");\n            // Open input dialog, set the value and retrieve new value\n            openInputDialog('Amplada màxima en (px)', '-1=sense limit', startAt1,\n            (/** @type {*} */ api) => {\n                const $target = ctx.path?.elem;\n                if (!$target) {\n                    return;\n                }\n                const maxwidth = convertInt(api.getData().value, 0);\n                if (maxwidth > 0) {\n                    $target.css(\"max-width\", maxwidth + \"px\");\n                } else {\n                    $target.css(\"max-width\", \"\");\n                }\n                api.close();\n            });\n        },\n    };\n\n    return [\n        // Image actions\n        imageEffectsNestedMenu,\n        imageSwitchToSnippet,\n\n        // Box actions\n        changeBoxLanguageNestedMenu,\n        changeBoxSizeNestedMenu,\n        changeBoxSeverityNestedMenu,\n        switchBoxRowsExample,\n        switchBoxSimpleExample,\n\n        // Others\n        numberedListNestedMenu,\n        tablesMaxWidthMenu,\n    ];\n}\n\nregisterMenuItemProvider(provider);"],"names":["SUPPORTED_LANGS","iso","title","AVAILABLE_EFFECTS","name","SUPPORTED_SIZES","v","l","ctx","openInputDialog","label","initialValue","onSubmit","editor","windowManager","open","body","type","items","buttons","text","initialData","value","condition","subMenuItems","elem","path","_ctx$path","attr","icon","onAction","Action","removeImageEffectsAction","map","e","addImageEffectAction","key","_ctx$path2","widget","_ctx$path2$widget","_ctx$path3","selectedElement","isImg","undefined","prop","targetElement","imageSwitchToSnippetAction","_ctx$path4","currentLang","_ref","changeBoxLangAction","_ctx$path5","_ctx$path6","parameters","_findVariableByName","options","hasClass","changeBoxSizeAction","_ctx$path7","_ctx$path8","_findVariableByName2","changeBoxSeverityAction","switchBoxRowsExampleAction","switchBoxSimpleExampleAction","_ctx$path9","target","closest","_ctx$path10","_ctx$path10$targetEle","console","log","$target","_ctx$path11","toggleClass","startAt","beginAt","parseInt","css","startAt1","api","close","_ctx$path13","startAt2","getData","beginAt3","_ctx$path14","replace","_ctx$path15","maxwidth"],"mappings":"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"}