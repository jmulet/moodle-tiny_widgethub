define("tiny_widgethub/extension/dependencies",["exports","../extension","../options","../util"],(function(_exports,_extension,_options,_util){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.addRequires=addRequires,_exports.cleanUnusedRequires=cleanUnusedRequires;function addRequires(editor,requireList){let dependenciesUpdated=0;try{const jsareaSelector="div.tiny_widgethub-jsarea",affectedWidgets=Object.values((0,_options.getWidgetDict)(editor)).filter((w=>w.selectors&&w.prop("requires"))),tiny=editor.getBody();let jsArea=tiny.querySelector(jsareaSelector);if(requireList||(requireList=[],affectedWidgets.forEach((w=>{var _requireList,_w$prop;anyMatchesSelectors(tiny,w.selectors||[])&&(null===(_requireList=requireList)||void 0===_requireList||_requireList.push(null===(_w$prop=w.prop("requires"))||void 0===_w$prop?void 0:_w$prop.trim()))}))),cleanUnusedRequires(editor,affectedWidgets),jsArea=tiny.querySelector(jsareaSelector),!jsArea&&requireList.length>0){const spacer=editor.dom.create("p",{},"<br>");jsArea=editor.dom.create("div",{class:"tiny_widgethub-jsarea"}),tiny.append(spacer),tiny.append(jsArea)}const scriptsToInsert=requireList.filter((requireScript=>{var _jsArea;return!!requireScript.endsWith(".js")&&null===(null===(_jsArea=jsArea)||void 0===_jsArea?void 0:_jsArea.querySelector(`script[src="${requireScript}"]`))}));jsArea&&scriptsToInsert.length>0&&scriptsToInsert.forEach((scriptUrl=>{const scriptNode=editor.dom.create("script",{src:scriptUrl,type:"mce-no/type","data-mce-src":scriptUrl});jsArea.append(scriptNode),dependenciesUpdated++}))}catch(ex){console.error("A problem occurred adding dependencies:",ex)}return dependenciesUpdated}function anyMatchesSelectors(tiny,selectors){"string"==typeof selectors&&(selectors=[selectors]);let anyFound=!1;try{anyFound=[...tiny.querySelectorAll(selectors[0]??"")].some((e=>{if(1===selectors.length)return!0;let match=!0;for(let i=1;i<selectors.length&&(match=match&&null!==e.querySelector(selectors[i]),match);i++);return match}))}catch(ex){console.error("Error in anyMatchesSelectors:",ex)}return anyFound}function cleanUnusedRequires(editor,affectedWidgets){let changes=0;try{const tiny=editor.getBody(),jsArea=tiny.querySelector("div.tiny_widgethub-jsarea");if(!jsArea)return 0;affectedWidgets||(affectedWidgets=Object.values((0,_options.getWidgetDict)(editor)).filter((w=>w.selectors&&w.prop("requires"))));jsArea.querySelectorAll("script").forEach((scriptElem=>{var _ref;const src=null===(_ref=scriptElem.src||"")||void 0===_ref?void 0:_ref.trim(),widgetFound=affectedWidgets.filter((w=>{var _w$prop2;return(null===(_w$prop2=w.prop("requires"))||void 0===_w$prop2?void 0:_w$prop2.trim())===src}))[0];if(!widgetFound)return scriptElem.remove(),void changes++;anyMatchesSelectors(tiny,widgetFound.selectors??[])||(scriptElem.remove(),changes++)})),jsArea.querySelectorAll("script").length||(jsArea.remove(),changes++)}catch(ex){console.error("Error while removing unused dependencies:",ex)}return changes}(0,_extension.subscribe)("contentSet",addRequires),(0,_extension.subscribe)("widgetInserted",(function(editor,widget,ctxFromDialogue){try{const requireList=[];if(widget.prop("requires")){const parts=widget.prop("requires").split("|");let conditionFullfilled=!0;var _parts$;if(parts.length>1&&(conditionFullfilled=(0,_util.evalInContext)(ctxFromDialogue,parts[1])),conditionFullfilled)requireList.push(null===(_parts$=parts[0])||void 0===_parts$?void 0:_parts$.trim())}let changes=0;requireList.length>0?changes+=addRequires(editor,requireList):changes+=cleanUnusedRequires(editor),changes>0&&editor.setDirty(!0)}catch(ex){console.error("An error occurre when treating dependencies of inserted widget:",ex)}})),(0,_extension.subscribe)("widgetRemoved",cleanUnusedRequires),(0,_extension.subscribe)("ctxAction",cleanUnusedRequires)}));

//# sourceMappingURL=dependencies.min.js.map