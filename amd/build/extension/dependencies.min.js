define("tiny_widgethub/extension/dependencies",["exports","../extension","../options","../util"],(function(_exports,_extension,_options,_util){function addRequires(editor,requireList){const imgBaseUrl=(0,_options.getGlobalConfig)(editor,"imgBaseUrl","https://iedib.net/assets");let dependenciesUpdated=0;const tiny=editor.getBody();let sdArea=tiny.querySelector("div.iedib-sd-area");if(!requireList){requireList=[];let found=tiny.querySelector('[role="snptd_zoom"],[data-snptd="zoom"],[role="snptd_lightbox"],[data-snptd="lightbox"]');found&&requireList.push("sd/images.min.js"),found=tiny.querySelector('[role="snptd_presentacio"],[data-snptd="presentacio"]'),found&&requireList.push("sd/presentacio.min.js"),found=tiny.querySelector('a[href^="#speak_"]'),found&&requireList.push("sd/speak.min.js"),found=tiny.querySelector('[role="snptd_talea"],[data-snptd="talea"]'),found&&requireList.push("sd/talea.min.js"),found=tiny.querySelector('[role="snptd_narracio"],[data-snptd="narracio"]'),found&&requireList.push("sd/narracio.min.js"),found=tiny.querySelector("div[data-quizz-group]"),found&&requireList.push("sd/quizz.min.js"),found=tiny.querySelector("pre.iedib-code"),found&&requireList.push("sd/programacio.min.js")}if(cleanUnusedRequires(editor),sdArea=tiny.querySelector("div.iedib-sd-area"),!sdArea&&requireList.length>0){const spacer=editor.dom.create("p",{},"<br>");sdArea=editor.dom.create("div",{class:"iedib-sd-area"}),tiny.append(spacer),tiny.append(sdArea)}const scriptsToInsert=requireList.filter((requireScript=>{var _sdArea;if(!requireScript.endsWith(".js"))return!1;return!(null!==(null===(_sdArea=sdArea)||void 0===_sdArea?void 0:_sdArea.querySelector('script[src$="'+requireScript+'"]')))}));return sdArea&&scriptsToInsert.length>0&&scriptsToInsert.forEach((scriptUrl=>{const depen=(0,_util.addBaseToUrl)(imgBaseUrl,scriptUrl),scriptNode=editor.dom.create("script",{src:depen});scriptNode.setAttribute("type","mce-no/type"),scriptNode.setAttribute("data-mce-src",depen),sdArea.append(scriptNode),dependenciesUpdated++})),dependenciesUpdated}function cleanUnusedRequires(editor){console.log("Removing unused requires...");const tiny=editor.getBody(),sdArea=tiny.querySelector("div.iedib-sd-area");if(!sdArea)return console.log("No sdArea found"),0;const allScripts=sdArea.querySelectorAll("script");let changes=0;return allScripts.forEach((scriptElem=>{const src=(scriptElem.src||"").trim();let found=null;src.endsWith("sd/zoom.min.js")||src.endsWith("sd/lightbox.min.js")?(scriptElem.remove(),changes++):src.endsWith("sd/images.min.js")?(found=tiny.querySelectorAll('[role="snptd_zoom"],[data-snptd="zoom"],[role="snptd_lightbox"],[data-snptd="lightbox"]'),found.length||(scriptElem.remove(),changes++)):src.endsWith("sd/presentacio.min.js")?(found=tiny.querySelectorAll('[role="snptd_presentacio"],[data-snptd="presentacio"]'),found.length||(scriptElem.remove(),changes++)):src.endsWith("sd/speak.min.js")?(found=tiny.querySelectorAll('a[href^="#speak_"]'),found.length||(scriptElem.remove(),changes++)):src.endsWith("sd/talea.min.js")?(found=tiny.querySelectorAll('[role="snptd_talea"],[data-snptd="talea"]'),found.length||(scriptElem.remove(),changes++)):src.endsWith("sd/narracio.min.js")?(found=tiny.querySelectorAll('[role="snptd_narracio"],[data-snptd="narracio"]'),found.length||(scriptElem.remove(),changes++)):src.endsWith("sd/quizz.min.js")?(found=tiny.querySelectorAll("div[data-quizz-group]"),found.length||(scriptElem.remove(),changes++)):src.endsWith("sd/programacio.min.js")&&(found=tiny.querySelectorAll("pre.iedib-code"),found.length||(scriptElem.remove(),changes++))})),sdArea.querySelectorAll("script").length||(sdArea.remove(),changes++),changes}function alphaWalker(editor,query,attr,ishash,prefix,changesWorker){const all=editor.getBody().querySelectorAll(query);let casos=0;return all.forEach((ele=>{let localChange=0,old=ele.getAttribute(attr)||"";ishash?("href"===attr&&(old="#"+old.split("#")[1]),RegExp(/^#\d/).exec(old)&&(old="#"+prefix+old.substring(1),ele.setAttribute(attr,old),"href"===attr&&(ele.dataset.mceHref=old),localChange+=1)):RegExp(/^\d/).exec(old)&&(old=prefix+old,ele.setAttribute(attr,old),"href"===attr&&(ele.dataset.mceHref=old),localChange+=1),localChange&&changesWorker&&changesWorker(ele),casos+=localChange})),casos}function changesWorker(ele){const newId=ele.getAttribute("id");ele.querySelectorAll('a.accordion-toggle[data-toggle="collapse"]').forEach((asel=>{asel.setAttribute("data-parent","#"+newId)}))}function alphaFixingRefractor(editor){console.log("alphaFixingRefractor",editor,editor.dom,editor.getElement());let casos=0;try{casos+=alphaWalker(editor,".accordion.iedib-accordion","id",!1,"f_",changesWorker);const casos2=alphaWalker(editor,"ul.nav.nav-tabs>li>a","href",!0,"f_");casos2>0&&(casos+=casos2+alphaWalker(editor,".tab-pane.iedib-tabpane","id",!1,"f_"))}catch(ex){console.error(ex)}casos>0&&(editor.notificationManager.open({text:"S'ha millorat la configuració d'alguns snippets. Desau els canvis de la pàgina.",type:"info"}),editor.setDirty(!0))}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.addRequires=addRequires,_exports.alphaFixingRefractor=alphaFixingRefractor,_exports.cleanUnusedRequires=cleanUnusedRequires,(0,_extension.subscribe)("contentSet",addRequires),(0,_extension.subscribe)("contentSet",alphaFixingRefractor),(0,_extension.subscribe)("widgetInserted",(function(editor,widget,ctxFromDialogue){const requireList=[];if(widget.prop("requires")){const parts=widget.prop("requires").split("|");let conditionFullfilled=!0;parts.length>1&&(conditionFullfilled=(0,_util.evalInContext)(ctxFromDialogue,parts[1])),conditionFullfilled&&requireList.push(parts[0].trim())}let changes=0;requireList.length>0?changes+=addRequires(editor,requireList):changes+=cleanUnusedRequires(editor),changes>0&&editor.setDirty(!0)})),(0,_extension.subscribe)("widgetRemoved",cleanUnusedRequires),(0,_extension.subscribe)("ctxAction",cleanUnusedRequires)}));

//# sourceMappingURL=dependencies.min.js.map