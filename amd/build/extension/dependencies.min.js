define("tiny_widgethub/extension/dependencies",["exports","../options","../extension","../util","../common"],(function(_exports,_options,_extension,_util,_common){var obj;
/**
   * Tiny WidgetHub plugin.
   *
   * @module      tiny_widgethub/plugin
   * @copyright   2025 Josep Mulet Pol <pep.mulet@gmail.com>
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.addRequires=addRequires,_exports.cleanUnusedRequires=cleanUnusedRequires,_common=(obj=_common)&&obj.__esModule?obj:{default:obj};const{jsAreaClassname:jsAreaClassname,jsURL:jsURL}=_common.default;function addRequires(editor,requireList){const imgBaseUrl=(0,_options.getGlobalConfig)(editor,"imgBaseUrl",jsURL),jsBaseUrl=(0,_options.getGlobalConfig)(editor,"jsBaseUrl",imgBaseUrl);let dependenciesUpdated=0;try{const jsareaSelector=`div.${jsAreaClassname}`,affectedWidgets=Object.values((0,_options.getWidgetDict)(editor)).filter((w=>w.selectors&&w.prop("requires"))),tiny=editor.getBody();let jsArea=tiny.querySelector(jsareaSelector);if(requireList||(requireList=[],affectedWidgets.forEach((w=>{var _requireList,_w$prop;anyMatchesSelectors(tiny,w.selectors||[])&&(null===(_requireList=requireList)||void 0===_requireList||_requireList.push(null===(_w$prop=w.prop("requires"))||void 0===_w$prop?void 0:_w$prop.trim()))}))),cleanUnusedRequires(editor,affectedWidgets),jsArea=tiny.querySelector(jsareaSelector),!jsArea&&requireList.length>0){const spacer=editor.dom.create("p",{},"<br>");jsArea=editor.dom.create("div",{class:jsAreaClassname}),tiny.append(spacer),tiny.append(jsArea)}const scriptsToInsert=requireList.filter((scriptUrl=>{var _jsArea;if(!scriptUrl.endsWith(".js"))return!1;const realSrc=(0,_util.addBaseToUrl)(jsBaseUrl,scriptUrl);return null===(null===(_jsArea=jsArea)||void 0===_jsArea?void 0:_jsArea.querySelector(`script[src="${realSrc}"]`))}));jsArea&&scriptsToInsert.length>0&&scriptsToInsert.forEach((scriptUrl=>{const realSrc=(0,_util.addBaseToUrl)(jsBaseUrl,scriptUrl),scriptNode=editor.dom.create("script",{src:realSrc,type:"mce-no/type","data-mce-src":realSrc});jsArea.append(scriptNode),dependenciesUpdated++}))}catch(ex){console.error("A problem occurred adding dependencies:",ex)}return dependenciesUpdated}function anyMatchesSelectors(tiny,selectors){"string"==typeof selectors&&(selectors=[selectors]);let anyFound=!1;try{anyFound=[...tiny.querySelectorAll(selectors[0]??"")].some((e=>{if(1===selectors.length)return!0;let match=!0;for(let i=1;i<selectors.length&&(match=match&&null!==e.querySelector(selectors[i]),match);i++);return match}))}catch(ex){console.error("Error in anyMatchesSelectors:",ex)}return anyFound}function cleanUnusedRequires(editor,affectedWidgets){let changes=0;try{const tiny=editor.getBody(),jsArea=tiny.querySelector(`div.${jsAreaClassname}`);if(!jsArea)return 0;affectedWidgets||(affectedWidgets=Object.values((0,_options.getWidgetDict)(editor)).filter((w=>w.selectors&&w.prop("requires"))));const imgBaseUrl=(0,_options.getGlobalConfig)(editor,"imgBaseUrl",jsURL),jsBaseUrl=(0,_options.getGlobalConfig)(editor,"jsBaseUrl",imgBaseUrl);jsArea.querySelectorAll("script").forEach((scriptElem=>{const src=(scriptElem.src||"").trim();if(!src)return scriptElem.remove(),void changes++;const widgetFound=affectedWidgets.find((w=>{var _w$prop2;return(0,_util.addBaseToUrl)(jsBaseUrl,(null===(_w$prop2=w.prop("requires"))||void 0===_w$prop2?void 0:_w$prop2.trim())||"")===src}));if(!widgetFound)return scriptElem.remove(),void changes++;anyMatchesSelectors(tiny,widgetFound.selectors??[])||(scriptElem.remove(),changes++)})),jsArea.querySelectorAll("script").length||(jsArea.remove(),changes++)}catch(ex){console.error("Error while removing unused dependencies:",ex)}return changes}function withErrorHandling(fn){return function(){try{return fn(...arguments)}catch(err){return console.error(err),null}}}(0,_extension.subscribe)("contentSet",withErrorHandling(addRequires)),(0,_extension.subscribe)("widgetInserted",withErrorHandling((function(editor,widget,ctxFromDialogue){const requireList=[];if(widget.prop("requires")){const parts=widget.prop("requires").split("|");let conditionFullfilled=!0;var _parts$;if(parts.length>1&&(conditionFullfilled=(0,_util.evalInContext)(ctxFromDialogue,parts[1])),conditionFullfilled)requireList.push(null===(_parts$=parts[0])||void 0===_parts$?void 0:_parts$.trim())}let changes=0;requireList.length>0?changes+=addRequires(editor,requireList):changes+=cleanUnusedRequires(editor),changes>0&&editor.setDirty(!0)}))),(0,_extension.subscribe)("widgetRemoved",withErrorHandling(cleanUnusedRequires)),(0,_extension.subscribe)("ctxAction",withErrorHandling(cleanUnusedRequires))}));

//# sourceMappingURL=dependencies.min.js.map