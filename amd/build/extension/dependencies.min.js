define("tiny_widgethub/extension/dependencies",["exports","../extension","../util"],(function(_exports,_extension,_util){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.addRequires=addRequires,_exports.cleanUnusedRequires=cleanUnusedRequires;function addRequires(editor,requireList){let dependenciesUpdated=!1;const tiny=editor.getBody();let sdArea=tiny.querySelector("div.iedib-sd-area");if(!requireList){requireList=[];let found=tiny.querySelector('[role="snptd_zoom"],[data-snptd="zoom"],[role="snptd_lightbox"],[data-snptd="lightbox"]');found&&requireList.push("sd/images.min.js"),found=tiny.querySelector('[role="snptd_presentacio"],[data-snptd="presentacio"]'),found&&requireList.push("sd/presentacio.min.js"),found=tiny.querySelector('a[href^="#speak_"]'),found&&requireList.push("sd/speak.min.js"),found=tiny.querySelector('[role="snptd_talea"],[data-snptd="talea"]'),found&&requireList.push("sd/talea.min.js"),found=tiny.querySelector('[role="snptd_narracio"],[data-snptd="narracio"]'),found&&requireList.push("sd/narracio.min.js"),found=tiny.querySelector("div[data-quizz-group]"),found&&requireList.push("sd/quizz.min.js"),found=tiny.querySelector("pre.iedib-code"),found&&requireList.push("sd/programacio.min.js")}if(cleanUnusedRequires(editor),sdArea=tiny.querySelector("div.iedib-sd-area"),!sdArea&&requireList.length>0){const spacer=editor.dom.create("p",{},"<br>");sdArea=editor.dom.create("div",{class:"iedib-sd-area"}),tiny.append(spacer),tiny.append(sdArea)}const scriptsToInsert=requireList.filter((requireScript=>{var _sdArea;if(!requireScript.endsWith(".js"))return!1;return!(null!==(null===(_sdArea=sdArea)||void 0===_sdArea?void 0:_sdArea.querySelector('script[src$="'+requireScript+'"]')))}));return sdArea&&scriptsToInsert.length>0&&(scriptsToInsert.forEach((scriptUrl=>{const depen=(0,_util.addBaseToUrl)("https://iedib.net/assets",scriptUrl),scriptNode=editor.dom.create("script",{src:depen});scriptNode.setAttribute("type","mce-no/type"),scriptNode.setAttribute("data-mce-src",depen),sdArea.append(scriptNode)})),dependenciesUpdated=!0),dependenciesUpdated}function cleanUnusedRequires(editor){console.log("Removing unused requires...");const tiny=editor.getBody(),sdArea=tiny.querySelector("div.iedib-sd-area");if(!sdArea)return void console.log("No sdArea found");sdArea.querySelectorAll("script").forEach((scriptElem=>{const src=(scriptElem.src||"").trim();let found=null;src.endsWith("sd/zoom.min.js")||src.endsWith("sd/lightbox.min.js")?scriptElem.remove():src.endsWith("sd/images.min.js")?(found=tiny.querySelectorAll('[role="snptd_zoom"],[data-snptd="zoom"],[role="snptd_lightbox"],[data-snptd="lightbox"]'),found.length||scriptElem.remove()):src.endsWith("sd/presentacio.min.js")?(found=tiny.querySelectorAll('[role="snptd_presentacio"],[data-snptd="presentacio"]'),found.length||scriptElem.remove()):src.endsWith("sd/speak.min.js")?(found=tiny.querySelectorAll('a[href^="#speak_"]'),found.length||scriptElem.remove()):src.endsWith("sd/talea.min.js")?(found=tiny.querySelectorAll('[role="snptd_talea"],[data-snptd="talea"]'),found.length||scriptElem.remove()):src.endsWith("sd/narracio.min.js")?(found=tiny.querySelectorAll('[role="snptd_narracio"],[data-snptd="narracio"]'),found.length||scriptElem.remove()):src.endsWith("sd/quizz.min.js")?(found=tiny.querySelectorAll("div[data-quizz-group]"),found.length||scriptElem.remove()):src.endsWith("sd/programacio.min.js")&&(found=tiny.querySelectorAll("pre.iedib-code"),found.length||scriptElem.remove())})),sdArea.querySelectorAll("script").length||sdArea.remove()}(0,_extension.subscribe)("contentSet",addRequires),(0,_extension.subscribe)("widgetInserted",(function(editor,widget,ctxFromDialogue){const requireList=[];if(widget.prop("requires")){const parts=widget.prop("requires").split("|");let conditionFullfilled=!0;parts.length>1&&(conditionFullfilled=(0,_util.evalInContext)(ctxFromDialogue,parts[1])),conditionFullfilled&&requireList.push(parts[0].trim())}requireList.length>0?addRequires(editor,requireList):cleanUnusedRequires(editor)})),(0,_extension.subscribe)("widgetRemoved",cleanUnusedRequires),(0,_extension.subscribe)("ctxAction",cleanUnusedRequires)}));

//# sourceMappingURL=dependencies.min.js.map