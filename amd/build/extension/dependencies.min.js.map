{"version":3,"file":"dependencies.min.js","sources":["../../src/extension/dependencies.js"],"sourcesContent":["/* eslint-disable no-console */\nimport {subscribe} from \"../extension\";\nimport {getGlobalConfig} from \"../options\";\nimport {addBaseToUrl, evalInContext} from \"../util\";\n\n/**\n/**\n * Adds the required scripts defined in the list\n * @param {import(\"../plugin\").TinyMCE} editor\n * @param {string[] | undefined} requireList\n * @returns {number}\n */\nexport function addRequires(editor, requireList) {\n    const imgBaseUrl = getGlobalConfig(editor, 'imgBaseUrl', 'https://iedib.net/assets');\n\n    let dependenciesUpdated = 0;\n    const tiny = editor.getBody();\n    let sdArea = tiny.querySelector(\"div.iedib-sd-area\");\n\n    // If no requireList is passed, then analyze the page and add requires that must be there!\n    if (!requireList) {\n        requireList = [];\n        let found = tiny\n            .querySelector('[role=\"snptd_zoom\"],[data-snptd=\"zoom\"],[role=\"snptd_lightbox\"],[data-snptd=\"lightbox\"]');\n        if (found) {\n            requireList.push(\"sd/images.min.js\");\n        }\n        // Elements that require presentacio.min.js\n        found = tiny.querySelector('[role=\"snptd_presentacio\"],[data-snptd=\"presentacio\"]');\n        if (found) {\n            requireList.push(\"sd/presentacio.min.js\");\n        }\n        // Elements that require presentacio.min.js\n        found = tiny.querySelector('a[href^=\"#speak_\"]');\n        if (found) {\n            requireList.push(\"sd/speak.min.js\");\n        }\n        // Elements that require talea.min.js\n        found = tiny.querySelector('[role=\"snptd_talea\"],[data-snptd=\"talea\"]');\n        if (found) {\n            requireList.push(\"sd/talea.min.js\");\n        }\n        // Elements that require narracio.min.js\n        found = tiny.querySelector('[role=\"snptd_narracio\"],[data-snptd=\"narracio\"]');\n        if (found) {\n            requireList.push(\"sd/narracio.min.js\");\n        }\n        // Elements that require quizz.min.js\n        found = tiny.querySelector('div[data-quizz-group]');\n        if (found) {\n            requireList.push(\"sd/quizz.min.js\");\n        }\n        // Elements that require programacio.min.js\n        found = tiny.querySelector('pre.iedib-code');\n        if (found) {\n             requireList.push(\"sd/programacio.min.js\");\n        }\n    }\n\n    // Clear unused requires first\n    cleanUnusedRequires(editor);\n    sdArea = tiny.querySelector(\"div.iedib-sd-area\");\n\n    if (!sdArea && requireList.length > 0) {\n        const spacer = editor.dom.create('p', {}, '<br>');\n        sdArea = editor.dom.create('div', {\"class\": 'iedib-sd-area'});\n        tiny.append(spacer);\n        tiny.append(sdArea);\n    }\n\n    // Check the existence of script area\n    const scriptsToInsert = requireList.filter((requireScript) => {\n        // S'ha de mirar dins la pàgina si ja té la dependència inclosa\n        if (!requireScript.endsWith(\".js\")) {\n            return false;\n        }\n        const found = sdArea?.querySelector('script[src$=\"' + requireScript + '\"]') !== null;\n        return !found;\n    });\n\n    if (sdArea && scriptsToInsert.length > 0) {\n        // Insert the scripts in the area\n        scriptsToInsert.forEach(scriptUrl => {\n            const depen = addBaseToUrl(imgBaseUrl, scriptUrl);\n            const scriptNode = editor.dom.create(\"script\", {src: depen});\n            scriptNode.setAttribute(\"type\", \"mce-no/type\");\n            scriptNode.setAttribute(\"data-mce-src\", depen);\n            sdArea.append(scriptNode);\n            dependenciesUpdated++;\n        });\n    }\n    return dependenciesUpdated;\n}\n\n/**\n * Removes those scripts that are not longer required\n * @param {import(\"../plugin\").TinyMCE} editor\n * @returns {number}\n */\nexport function cleanUnusedRequires(editor) {\n    console.log(\"Removing unused requires...\");\n    const tiny = editor.getBody();\n    const sdArea = tiny.querySelector(\"div.iedib-sd-area\");\n    if (!sdArea) {\n        console.log(\"No sdArea found\");\n        return 0;\n    }\n    // All scripts in sdArea\n    /** @type {NodeListOf<HTMLScriptElement>} */\n    const allScripts = sdArea.querySelectorAll(\"script\");\n    let changes = 0;\n    allScripts.forEach((scriptElem) => {\n        const src = (scriptElem.src || '').trim();\n        let found = null;\n        if (src.endsWith('sd/zoom.min.js') || src.endsWith('sd/lightbox.min.js')) {\n            // No longer supported; always remove them\n            scriptElem.remove();\n            changes++;\n        } else if (src.endsWith('sd/images.min.js')) {\n            // Elements that require images.min.js\n            found =\n            tiny.querySelectorAll('[role=\"snptd_zoom\"],[data-snptd=\"zoom\"],[role=\"snptd_lightbox\"],[data-snptd=\"lightbox\"]');\n            if (!found.length) {\n                scriptElem.remove();\n                changes++;\n            }\n        } else if (src.endsWith('sd/presentacio.min.js')) {\n            // Elements that require presentacio.min.js\n            found = tiny.querySelectorAll('[role=\"snptd_presentacio\"],[data-snptd=\"presentacio\"]');\n            if (!found.length) {\n                scriptElem.remove();\n                changes++;\n            }\n        } else if (src.endsWith('sd/speak.min.js')) {\n            // Elements that require presentacio.min.js\n            found = tiny.querySelectorAll('a[href^=\"#speak_\"]');\n            if (!found.length) {\n                scriptElem.remove();\n                changes++;\n            }\n        } else if (src.endsWith('sd/talea.min.js')) {\n            // Elements that require talea.min.js\n            found = tiny.querySelectorAll('[role=\"snptd_talea\"],[data-snptd=\"talea\"]');\n            if (!found.length) {\n                scriptElem.remove();\n                changes++;\n            }\n        } else if (src.endsWith('sd/narracio.min.js')) {\n            // Elements that require narracio.min.js\n            found = tiny.querySelectorAll('[role=\"snptd_narracio\"],[data-snptd=\"narracio\"]');\n            if (!found.length) {\n                scriptElem.remove();\n                changes++;\n            }\n        } else if (src.endsWith('sd/quizz.min.js')) {\n            // Elements that require quizz.min.js\n            found = tiny.querySelectorAll('div[data-quizz-group]');\n            if (!found.length) {\n                scriptElem.remove();\n                changes++;\n            }\n        } else if (src.endsWith('sd/programacio.min.js')) {\n            found = tiny.querySelectorAll('pre.iedib-code');\n            if (!found.length) {\n                scriptElem.remove();\n                changes++;\n            }\n        }\n    });\n\n    // Get rid of sdArea if no scripts are left\n    if (!sdArea.querySelectorAll(\"script\").length) {\n        sdArea.remove();\n        changes++;\n    }\n    return changes;\n}\n/**\n * @param {import(\"../plugin\").TinyMCE} editor\n * @param {import(\"../options\").Widget} widget\n * @param {Record<string, any>} ctxFromDialogue\n */\nfunction widgetInserted(editor, widget, ctxFromDialogue) {\n      // Determine if should add any requires\n      const requireList = [];\n      // Treat the case of requires being an object (keys are the conditions to be met)\n      if (widget.prop('requires')) {\n         const parts = widget.prop('requires').split(\"|\");\n         let conditionFullfilled = true;\n            if (parts.length > 1) {\n               conditionFullfilled = evalInContext(ctxFromDialogue, parts[1]);\n            }\n         if (conditionFullfilled) {\n            requireList.push(parts[0].trim());\n         }\n      }\n      let changes = 0;\n      if (requireList.length > 0) {\n          // Now handle the filtered list of requires\n          changes += addRequires(editor, requireList);\n      } else {\n          // Always try to remove unused requires\n          changes += cleanUnusedRequires(editor);\n      }\n      if (changes > 0) {\n        editor.setDirty(true);\n      }\n}\n\n/**\n * @param {import(\"../plugin\").TinyMCE} editor\n * @param {string} query\n * @param {string} attr\n * @param {boolean} ishash\n * @param {string} prefix\n * @param {(ele: HTMLElement) => void} [changesWorker]\n * @returns {number}\n */\nfunction alphaWalker(editor, query, attr, ishash, prefix, changesWorker) {\n    /** @type {NodeListOf<HTMLElement>} */\n    const all = editor.getBody().querySelectorAll(query);\n    let casos = 0;\n    all.forEach((/** @type{HTMLElement} */ ele) => {\n        let localChange = 0;\n        let old = ele.getAttribute(attr) || \"\";\n        if (ishash) {\n            // It starts with # and after that the actual id value\n            if (attr === 'href') {\n                old = '#' + old.split('#')[1];\n            }\n            if (RegExp(/^#\\d/).exec(old)) {\n                old = '#' + prefix + old.substring(1);\n                ele.setAttribute(attr, old);\n                if (attr === 'href') {\n                    ele.dataset.mceHref = old;\n                }\n                localChange += 1;\n            }\n        } else if (RegExp(/^\\d/).exec(old)) {\n                old = prefix + old;\n                ele.setAttribute(attr, old);\n                if (attr === 'href') {\n                    ele.dataset.mceHref = old;\n                }\n                localChange += 1;\n        }\n        if (localChange && changesWorker) {\n            changesWorker(ele);\n        }\n        casos += localChange;\n    });\n    return casos;\n}\n\n/**\n * @param {HTMLElement} ele\n */\nfunction changesWorker(ele) {\n    const newId = ele.getAttribute(\"id\");\n    /** @type {NodeListOf<HTMLElement>} */\n    const allAs = ele.querySelectorAll('a.accordion-toggle[data-toggle=\"collapse\"]');\n    allAs.forEach((asel) => {\n        asel.setAttribute(\"data-parent\", '#' + newId);\n    });\n}\n/**\n *\n * @param {import(\"../plugin\").TinyMCE} editor\n */\nexport function alphaFixingRefractor(editor) {\n    console.log(\"alphaFixingRefractor\", editor, editor.dom, editor.getElement());\n    const prefix = 'f_';\n    let casos = 0;\n    try {\n        casos += alphaWalker(editor, '.accordion.iedib-accordion', 'id', false, prefix, changesWorker);\n        const casos2 = alphaWalker(editor, 'ul.nav.nav-tabs>li>a', 'href', true, prefix);\n        if (casos2 > 0) {\n            casos += casos2 + alphaWalker(editor, '.tab-pane.iedib-tabpane', 'id', false, prefix);\n        }\n    } catch (ex) {\n        console.error(ex);\n    }\n    // Show a message\n    if (casos > 0) {\n        editor.notificationManager.open({\n            text: \"S'ha millorat la configuració d'alguns snippets. Desau els canvis de la pàgina.\",\n            type: 'info'\n        });\n        editor.setDirty(true);\n    }\n}\n\n/**\n *\n * @param {import(\"../plugin\").TinyMCE} editor\n */\nfunction injectCssFromDynamicSnippets(editor) {\n    const imgBaseUrl = getGlobalConfig(editor, 'imgBaseUrl', 'https://iedib.net/assets');\n    editor.dom.loadCSS(addBaseToUrl(imgBaseUrl, 'sd/all.css'));\n}\n\nsubscribe('onInit', injectCssFromDynamicSnippets);\nsubscribe('contentSet', addRequires);\nsubscribe('contentSet', alphaFixingRefractor);\nsubscribe('widgetInserted', widgetInserted);\nsubscribe('widgetRemoved', cleanUnusedRequires);\nsubscribe('ctxAction', cleanUnusedRequires);"],"names":["addRequires","editor","requireList","imgBaseUrl","dependenciesUpdated","tiny","getBody","sdArea","querySelector","found","push","cleanUnusedRequires","length","spacer","dom","create","append","scriptsToInsert","filter","requireScript","endsWith","forEach","scriptUrl","depen","scriptNode","src","setAttribute","console","log","allScripts","querySelectorAll","changes","scriptElem","trim","remove","alphaWalker","query","attr","ishash","prefix","changesWorker","all","casos","ele","localChange","old","getAttribute","split","RegExp","exec","substring","dataset","mceHref","newId","asel","alphaFixingRefractor","getElement","casos2","ex","error","notificationManager","open","text","type","setDirty","loadCSS","widget","ctxFromDialogue","prop","parts","conditionFullfilled"],"mappings":"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"}