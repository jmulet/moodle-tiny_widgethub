{"version":3,"file":"dependencies.min.js","sources":["../../src/extension/dependencies.js"],"sourcesContent":["/* eslint-disable no-console */\nimport { evalInContext } from \"../../../tests/jsunit/src/util\";\nimport {subscribe} from \"../extension\";\nimport {addBaseToUrl} from \"../util\";\n\nconst IMG_BASE_URL = \"https://iedib.net/assets\";\n\n/**\n/**\n * Adds the required scripts defined in the list\n * @param {import(\"../plugin\").TinyMCE} editor\n * @param {string[] | undefined} requireList\n * @returns {boolean}\n */\nexport function addRequires(editor, requireList) {\n    let dependenciesUpdated = false;\n    const tiny = editor.getBody();\n    let sdArea = tiny.querySelector(\"div.iedib-sd-area\");\n\n    // If no requireList is passed, then analyze the page and add requires that must be there!\n    if (!requireList) {\n        requireList = [];\n        let found = tiny\n            .querySelector('[role=\"snptd_zoom\"],[data-snptd=\"zoom\"],[role=\"snptd_lightbox\"],[data-snptd=\"lightbox\"]');\n        if (found) {\n            requireList.push(\"sd/images.min.js\");\n        }\n        // Elements that require presentacio.min.js\n        found = tiny.querySelector('[role=\"snptd_presentacio\"],[data-snptd=\"presentacio\"]');\n        if (found) {\n            requireList.push(\"sd/presentacio.min.js\");\n        }\n        // Elements that require presentacio.min.js\n        found = tiny.querySelector('a[href^=\"#speak_\"]');\n        if (found) {\n            requireList.push(\"sd/speak.min.js\");\n        }\n        // Elements that require talea.min.js\n        found = tiny.querySelector('[role=\"snptd_talea\"],[data-snptd=\"talea\"]');\n        if (found) {\n            requireList.push(\"sd/talea.min.js\");\n        }\n        // Elements that require narracio.min.js\n        found = tiny.querySelector('[role=\"snptd_narracio\"],[data-snptd=\"narracio\"]');\n        if (found) {\n            requireList.push(\"sd/narracio.min.js\");\n        }\n        // Elements that require quizz.min.js\n        found = tiny.querySelector('div[data-quizz-group]');\n        if (found) {\n            requireList.push(\"sd/quizz.min.js\");\n        }\n        // Elements that require programacio.min.js\n        found = tiny.querySelector('pre.iedib-code');\n        if (found) {\n             requireList.push(\"sd/programacio.min.js\");\n        }\n    }\n\n    // Clear unused requires first\n    cleanUnusedRequires(editor);\n    sdArea = tiny.querySelector(\"div.iedib-sd-area\");\n\n    if (!sdArea && requireList.length > 0) {\n        const spacer = editor.dom.create('p', {}, '<br>');\n        sdArea = editor.dom.create('div', {\"class\": 'iedib-sd-area'});\n        tiny.append(spacer);\n        tiny.append(sdArea);\n    }\n\n    // Check the existence of script area\n    const scriptsToInsert = requireList.filter((requireScript) => {\n        // S'ha de mirar dins la pàgina si ja té la dependència inclosa\n        if (!requireScript.endsWith(\".js\")) {\n            return false;\n        }\n        const found = sdArea?.querySelector('script[src$=\"' + requireScript + '\"]') !== null;\n        return !found;\n    });\n\n    if (sdArea && scriptsToInsert.length > 0) {\n        // Insert the scripts in the area\n        scriptsToInsert.forEach(scriptUrl => {\n            const depen = addBaseToUrl(IMG_BASE_URL, scriptUrl);\n            const scriptNode = editor.dom.create(\"script\", {src: depen});\n            scriptNode.setAttribute(\"type\", \"mce-no/type\");\n            scriptNode.setAttribute(\"data-mce-src\", depen);\n            sdArea.append(scriptNode);\n        });\n        dependenciesUpdated = true;\n    }\n    return dependenciesUpdated;\n}\n\n/**\n * Removes those scripts that are not longer required\n * @param {import(\"../plugin\").TinyMCE} editor\n */\nexport function cleanUnusedRequires(editor) {\n    console.log(\"Removing unused requires...\");\n    const tiny = editor.getBody();\n    const sdArea = tiny.querySelector(\"div.iedib-sd-area\");\n    if (!sdArea) {\n        console.log(\"No sdArea found\");\n        return;\n    }\n    // All scripts in sdArea\n    /** @type {HTMLScriptElement[]} */\n    const allScripts = sdArea.querySelectorAll(\"script\");\n    allScripts.forEach((scriptElem) => {\n        const src = (scriptElem.src || '').trim();\n        let found = null;\n        if (src.endsWith('sd/zoom.min.js') || src.endsWith('sd/lightbox.min.js')) {\n            // No longer supported; always remove them\n            scriptElem.remove();\n        } else if (src.endsWith('sd/images.min.js')) {\n            // Elements that require images.min.js\n            found =\n            tiny.querySelectorAll('[role=\"snptd_zoom\"],[data-snptd=\"zoom\"],[role=\"snptd_lightbox\"],[data-snptd=\"lightbox\"]');\n            if (!found.length) {\n                scriptElem.remove();\n            }\n        } else if (src.endsWith('sd/presentacio.min.js')) {\n            // Elements that require presentacio.min.js\n            found = tiny.querySelectorAll('[role=\"snptd_presentacio\"],[data-snptd=\"presentacio\"]');\n            if (!found.length) {\n                scriptElem.remove();\n            }\n        } else if (src.endsWith('sd/speak.min.js')) {\n            // Elements that require presentacio.min.js\n            found = tiny.querySelectorAll('a[href^=\"#speak_\"]');\n            if (!found.length) {\n                scriptElem.remove();\n            }\n        } else if (src.endsWith('sd/talea.min.js')) {\n            // Elements that require talea.min.js\n            found = tiny.querySelectorAll('[role=\"snptd_talea\"],[data-snptd=\"talea\"]');\n            if (!found.length) {\n                scriptElem.remove();\n            }\n        } else if (src.endsWith('sd/narracio.min.js')) {\n            // Elements that require narracio.min.js\n            found = tiny.querySelectorAll('[role=\"snptd_narracio\"],[data-snptd=\"narracio\"]');\n            if (!found.length) {\n                scriptElem.remove();\n            }\n        } else if (src.endsWith('sd/quizz.min.js')) {\n            // Elements that require quizz.min.js\n            found = tiny.querySelectorAll('div[data-quizz-group]');\n            if (!found.length) {\n                scriptElem.remove();\n            }\n        } else if (src.endsWith('sd/programacio.min.js')) {\n            found = tiny.querySelectorAll('pre.iedib-code');\n            if (!found.length) {\n                scriptElem.remove();\n            }\n        }\n    });\n\n    // Get rid of sdArea if no scripts are left\n    if (!sdArea.querySelectorAll(\"script\").length) {\n        sdArea.remove();\n    }\n}\n/**\n * @param {import(\"../plugin\").TinyMCE} editor\n * @param {import(\"../options\").Widget} widget\n * @param {Record<string, any>} ctxFromDialogue\n */\nfunction widgetInserted(editor, widget, ctxFromDialogue) {\n      // Determine if should add any requires\n      const requireList = [];\n      // Treat the case of requires being an object (keys are the conditions to be met)\n      if (widget.prop('requires')) {\n         const parts = widget.prop('requires').split(\"|\");\n         let conditionFullfilled = true;\n            if (parts.length > 1) {\n               conditionFullfilled = evalInContext(ctxFromDialogue, parts[1]);\n            }\n         if (conditionFullfilled) {\n            requireList.push(parts[0].trim());\n         }\n      }\n      if (requireList.length > 0) {\n          // Now handle the filtered list of requires\n          addRequires(editor, requireList);\n      } else {\n          // Always try to remove unused requires\n          cleanUnusedRequires(editor);\n      }\n}\n\nsubscribe('contentSet', addRequires);\nsubscribe('widgetInserted', widgetInserted);\nsubscribe('widgetRemoved', cleanUnusedRequires);\nsubscribe('ctxAction', cleanUnusedRequires);\n"],"names":["addRequires","editor","requireList","dependenciesUpdated","tiny","getBody","sdArea","querySelector","found","push","cleanUnusedRequires","length","spacer","dom","create","append","scriptsToInsert","filter","requireScript","endsWith","forEach","scriptUrl","depen","scriptNode","src","setAttribute","console","log","querySelectorAll","scriptElem","trim","remove","widget","ctxFromDialogue","prop","parts","split","conditionFullfilled"],"mappings":"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"}