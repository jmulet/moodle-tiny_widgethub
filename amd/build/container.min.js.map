{"version":3,"file":"container.min.js","sources":["../src/container.js"],"sourcesContent":["import {WidgetParamsCtrl} from \"./controller/widgetParamsCtrl\";\nimport {WidgetPickerCtrl} from \"./controller/widgetPickerCtrl\";\nimport {FormCtrl} from \"./controller/formCtrl\";\nimport _modalSrv from \"./service/modalSrv\";\nimport _mustache from \"core/mustache\";\nimport TemplateSrv from \"./service/templateSrv\";\nimport UserStorageSrv from \"./service/userStorageSrv\";\nimport _jQuery from \"jquery\";\nimport { displayFilepicker } from \"editor_tiny/utils\";\nimport { getFilePicker } from \"editor_tiny/options\";\nimport WidgetPropertiesCtrl from \"./controller/widgetPropertiesCtrl\";\nimport { EditorOptions } from \"./options\";\n\n// Singleton instances (shared among editors)\n/**\n * @type {TemplateSrv | undefined}\n */\nlet _templateSrv;\n/**\n * Load on demand the template engine EJS\n * @typedef {Object} EJS\n * @property {(template: string, ctx: Object.<string,any>) => string} render\n */\n/** @type {EJS | undefined} */\nlet _ejs;\nexport const ejsLoader = () => {\n    if (_ejs) {\n    return Promise.resolve(_ejs);\n    }\n    return new Promise((resolve, reject) => {\n        // @ts-ignore\n        window.require(['tiny_widgethub/ejs-lazy'], (ejsModule) => {\n            _ejs = ejsModule;\n            if (_ejs) {\n                resolve(_ejs);\n            } else {\n                reject();\n            }\n        }, reject);\n    });\n};\n\n/**\n * Container for dependency injection\n * @member {TinyMCE} _editor\n * @member {WidgetPickerCtrl} _widgetPickCtrl\n */\nexport class DIContainer {\n    /**\n     * @type {import(\"./plugin\").TinyMCE}\n     */\n    editor;\n    /**\n     * @type { WidgetPickerCtrl | undefined}\n     */\n    _widgetPickCtrl;\n\n    /**\n     * @type {Record<string, UserStorageSrv>}\n     */\n    _userStorageInstances = {};\n\n    /**\n     * @type {EditorOptions | undefined}\n     */\n    _editorOptions;\n\n    /**\n     * @type {FormCtrl | undefined}\n     */\n    _formCtrl;\n\n    /**\n     * @param {import(\"./plugin\").TinyMCE} editor\n     */\n    constructor(editor) {\n        this.editor = editor;\n    }\n\n    get editorOptions() {\n        this._editorOptions = this._editorOptions ?? new EditorOptions(this);\n        return this._editorOptions;\n    }\n\n    get widgetParamsFactory() {\n        /**\n         * @param {import('./util').WidgetWrapper} widget\n         */\n        return (widget) => {\n            // Creates multiple instances of the service\n            return new WidgetParamsCtrl(this, widget);\n        };\n    }\n    /**\n     * @scope {editor}\n     */\n    get widgetPickCtrl() {\n        this._widgetPickCtrl = this._widgetPickCtrl ?? new WidgetPickerCtrl(this);\n        return this._widgetPickCtrl;\n    }\n\n    get widgetPropertiesCtrl() {\n        this._widgetPropertiesCtrl = this._widgetPropertiesCtrl ?? new WidgetPropertiesCtrl(this);\n        return this._widgetPropertiesCtrl;\n    }\n\n    get formCtrl() {\n        this._formCtrl = this._formCtrl ?? new FormCtrl(this);\n        return this._formCtrl;\n    }\n\n    /**\n     * @scope {singleton}\n     */\n    get modalSrv() {\n        return _modalSrv;\n    }\n\n    /**\n     * @scope {singleton}\n     */\n    get templateSrv() {\n        _templateSrv = _templateSrv || new TemplateSrv(this);\n        return _templateSrv;\n    }\n\n    /**\n     * Provides an implementation based on browser storage\n     */\n    get iStorage() {\n        return {\n            localStorage,\n            sessionStorage\n        };\n    }\n\n    /**\n     * @scope {singleton} for each user and course\n     */\n    get userStorage() {\n        const userId = this.editorOptions.userId;\n        const courseId = this.editorOptions.courseId;\n        const key =  userId + \"_\" + courseId;\n        // @ts-ignore\n        if (!this._userStorageInstances[key]) {\n            this._userStorageInstances[key] = new UserStorageSrv(this, userId, courseId);\n        }\n        return this._userStorageInstances[key];\n    }\n\n    get mustache() {\n        return _mustache;\n    }\n\n    /**\n     * @returns {() => Promise<EJS>}\n     */\n    get ejsLoader() {\n        return ejsLoader;\n    }\n\n    get fileSrv() {\n        this._fileSrv = this._fileSrv || {\n            getImagePicker: () => {\n                return getFilePicker(this.editor, 'image');\n            },\n            displayImagePicker: () => {\n                return displayFilepicker(this.editor, 'image');\n            }\n        };\n        return this._fileSrv;\n    }\n\n    get jQuery() {\n        return _jQuery;\n    }\n}"],"names":["_templateSrv","_ejs","ejsLoader","Promise","resolve","reject","window","require","ejsModule","editor","_widgetPickCtrl","_userStorageInstances","_editorOptions","_formCtrl","constructor","editorOptions","this","EditorOptions","widgetParamsFactory","widget","WidgetParamsCtrl","widgetPickCtrl","WidgetPickerCtrl","widgetPropertiesCtrl","_widgetPropertiesCtrl","WidgetPropertiesCtrl","formCtrl","FormCtrl","modalSrv","_modalSrv","templateSrv","TemplateSrv","iStorage","localStorage","sessionStorage","userStorage","userId","courseId","key","UserStorageSrv","mustache","_mustache","fileSrv","_fileSrv","getImagePicker","displayImagePicker","jQuery","_jQuery"],"mappings":"qkBAiBIA,aAOAC,saACSC,UAAY,IACjBD,KACGE,QAAQC,QAAQH,MAEhB,IAAIE,SAAQ,CAACC,QAASC,UAEzBC,OAAOC,QAAQ,CAAC,4BAA6BC,YACzCP,KAAOO,UACHP,KACAG,QAAQH,MAERI,WAELA,mEAaPI,OAIAC,gBAKAC,sBAAwB,GAKxBC,eAKAC,UAKAC,YAAYL,aACHA,OAASA,OAGdM,gCACKH,eAAiBI,KAAKJ,gBAAkB,IAAIK,wBAAcD,MACxDA,KAAKJ,eAGZM,iCAIQC,QAEG,IAAIC,mCAAiBJ,KAAMG,QAMtCE,iCACKX,gBAAkBM,KAAKN,iBAAmB,IAAIY,mCAAiBN,MAC7DA,KAAKN,gBAGZa,uCACKC,sBAAwBR,KAAKQ,uBAAyB,IAAIC,8BAAqBT,MAC7EA,KAAKQ,sBAGZE,2BACKb,UAAYG,KAAKH,WAAa,IAAIc,mBAASX,MACzCA,KAAKH,UAMZe,sBACOC,mBAMPC,yBACA9B,aAAeA,cAAgB,IAAI+B,sBAAYf,MACxChB,aAMPgC,qBACO,CACHC,aAAAA,aACAC,eAAAA,gBAOJC,wBACMC,OAASpB,KAAKD,cAAcqB,OAC5BC,SAAWrB,KAAKD,cAAcsB,SAC9BC,IAAOF,OAAS,IAAMC,gBAEvBrB,KAAKL,sBAAsB2B,YACvB3B,sBAAsB2B,KAAO,IAAIC,wBAAevB,KAAMoB,OAAQC,WAEhErB,KAAKL,sBAAsB2B,KAGlCE,sBACOC,mBAMPvC,uBACOA,UAGPwC,0BACKC,SAAW3B,KAAK2B,UAAY,CAC7BC,eAAgB,KACL,0BAAc5B,KAAKP,OAAQ,SAEtCoC,mBAAoB,KACT,4BAAkB7B,KAAKP,OAAQ,UAGvCO,KAAK2B,SAGZG,oBACOC"}