define("tiny_widgethub/commands",["exports","editor_tiny/utils","core/str","./common","core/config","./contextactions","./options","./controller/widgetpicker_ctrl","./extension","./service/userstorage_service","./util"],(function(_exports,_utils,coreStr,_common,cfg,_contextactions,_options,_widgetpicker_ctrl,_extension,_userstorage_service,_util){var obj;function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}
/**
   * Tiny WidgetHub plugin.
   *
   * @module      tiny_widgethub/plugin
   * @copyright   2024 Josep Mulet Pol <pep.mulet@gmail.com>
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.getSetup=void 0,coreStr=_interopRequireWildcard(coreStr),_common=(obj=_common)&&obj.__esModule?obj:{default:obj},cfg=_interopRequireWildcard(cfg);_exports.getSetup=async()=>{const[widgetNameTitle,buttonImage]=await Promise.all([coreStr.get_string("settings",_common.default.component),(0,_utils.getButtonImage)("icon",_common.default.component)]);return editor=>{if(!(0,_options.isPluginVisible)(editor))return;(0,_extension.getListeners)("setup").forEach((listener=>listener(editor)));const page=_options.Shared.currentScope;if((0,_options.getGlobalConfig)(editor,"disable.plugin.pages","").split(",").map((p=>p.trim())).filter(Boolean).includes(page))return void console.warn(`${_common.default.component} plugin is disabled on this page.`);const regexPattern=(0,_options.getGlobalConfig)(editor,"disable.plugin.pages.regex","");if(regexPattern)try{if(new RegExp(regexPattern).test(page))return void console.warn(`${_common.default.component} plugin is disabled on this page.`)}catch(ex){console.error("Please check disable.plugin.pages.regex: Invalid regular expression:",ex.message)}editor.ui.registry.addIcon(_common.default.icon,buttonImage.html);const storage=(0,_userstorage_service.getUserStorage)(editor),widgetsDict=(0,_options.getWidgetDict)(editor),contextMerger=(widget,behavior,includeRepeatable)=>{let ctx=widget.defaultsWithRepeatable(includeRepeatable)||{};if("lastused"===behavior){var _storage$getRecentUse;const ctxStored=(null===(_storage$getRecentUse=storage.getRecentUsed().find((e=>e.key===widget.key)))||void 0===_storage$getRecentUse?void 0:_storage$getRecentUse.p)||{};ctx={...ctx,...(0,_util.removeRndFromCtx)(ctxStored,widget.parameters)}}return ctx},defaultAction=()=>{(0,_widgetpicker_ctrl.getWidgetPickCtrl)(editor).handleAction()},toolbarButtonSpec={icon:_common.default.icon,tooltip:widgetNameTitle,onAction:defaultAction},splitButtonBehavior=(0,_options.getGlobalConfig)(editor,"insert.splitbutton.behavior","lastused");if("none"===splitButtonBehavior)editor.ui.registry.addButton(_common.default.component,toolbarButtonSpec);else{const splitbuttonFetch=callback=>{const isSelectMode=editor.selection.getContent().trim().length>0;callback(storage.getRecentUsed().filter((e=>{const widget=widgetsDict[e.key];return(null==widget?void 0:widget.name)&&(!isSelectMode||widget.isSelectCapable())})).map((e=>{var _widgetsDict$e$key;return{type:"choiceitem",text:null===(_widgetsDict$e$key=widgetsDict[e.key])||void 0===_widgetsDict$e$key?void 0:_widgetsDict$e$key.name,value:e.key}})))},splitbuttonAction=(api,key)=>{const widgetPickCtrl=(0,_widgetpicker_ctrl.getWidgetPickCtrl)(editor),widget=widgetsDict[key];if(!widget)return;const ctx=contextMerger(widget,splitButtonBehavior,!0);widgetPickCtrl.handlePickModalAction(widget,!0,ctx)};editor.ui.registry.addSplitButton(_common.default.component,{...toolbarButtonSpec,columns:1,fetch:splitbuttonFetch,onItemAction:splitbuttonAction})}editor.ui.registry.addMenuItem(_common.default.component,{icon:_common.default.icon,text:widgetNameTitle,onAction:defaultAction});const autoCompleteBehavior=(0,_options.getGlobalConfig)(editor,"insert.autocomplete.behavior","lastused"),autoCompleteTrigger=(0,_options.getGlobalConfig)(editor,"insert.autocomplete.symbol","@");if("none"!==autoCompleteBehavior&&autoCompleteTrigger){const autocompleterFetch=pattern=>{const results=[];return(pattern=>Object.values(widgetsDict).filter((w=>!w.isFilter()&&(0,_util.searchComp)(w.name,pattern))))(pattern).forEach((w=>{var _w$prop;const varname=null===(_w$prop=w.prop("autocomplete"))||void 0===_w$prop?void 0:_w$prop.trim(),param=(0,_util.findVariableByName)(varname,w.parameters);null!=param&&param.options?param.options.forEach((opt=>{let value=opt,label=opt;"object"==typeof opt&&(value=opt.v,label=opt.l),results.push({type:"autocompleteitem",value:`${w.key}|${varname}:${value}`,text:w.name+" "+label})})):results.push({type:"autocompleteitem",value:w.key,text:w.name})})),Promise.resolve(results)},autocompleterAction=(api,rng,value)=>{api.hide(),rng=rng||api.getRange();const pair=value.split("|"),key=pair[0].trim(),widget=widgetsDict[key];if(!widget)return;const ctx=contextMerger(widget,autoCompleteBehavior,!0);if(2===pair.length){const[varname,varvalue]=pair[1].split(":");ctx[varname]=varvalue}editor.selection.setRng(rng),editor.insertContent("");(0,_widgetpicker_ctrl.getWidgetPickCtrl)(editor).handlePickModalAction(widget,!0,ctx)};editor.ui.registry.addAutocompleter(_common.default.component+"_autocompleter",{trigger:autoCompleteTrigger,columns:1,minChars:3,fetch:autocompleterFetch,onAction:autocompleterAction})}!function(editor){editor.once("SetContent",(()=>{(editor=>{const requiresFilter=(0,_userstorage_service.getUserStorage)(editor).getFromLocal("startup.filters","").split(",");if(requiresFilter.length>0){const editorOptions=(0,_options.getEditorOptions)(editor),widgetsFound=requiresFilter.map((key=>editorOptions.widgetDict[key])).filter((w=>void 0!==w)),applyWidgetFilter=(0,_util.applyWidgetFilterFactory)(editor,coreStr);widgetsFound.forEach((w=>applyWidgetFilter(w.template??"",!0)));const pageForm=document.querySelector("form.mform");pageForm&&pageForm.querySelector('div[data-fieldtype="editor"]')&&pageForm.addEventListener("submit",(()=>(widgetsFound.forEach((w=>applyWidgetFilter(w.template??"",!0))),!0)))}})(editor),(0,_extension.getListeners)("contentSet").forEach((listener=>listener(editor)))})),editor.on("init",(async()=>{var _window$M,_window$M$cfg,_window$M$cfg$version;if((0,_options.isShareCss)(editor)){const subversion=1,allCss=`${cfg.wwwroot}/theme/styles.php/${cfg.theme}/${cfg.themerev}_${subversion}/all`;editor.dom.loadCSS(allCss)}let adminCss=((0,_options.getAdditionalCss)(editor)??"").trim();if(adminCss){const regex=/\/\*{2}\s+(http(s?):\/\/.*)\s+\*{2}\//gm;adminCss=adminCss.replace(regex,((_,$1)=>(editor.dom.loadCSS($1),""))),adminCss.trim()&&editor.dom.addStyle(adminCss)}parseInt((0,_options.getGlobalConfig)(editor,"enable.contextmenu.level","1"))>0&&await(0,_contextactions.getContextMenuManager)(editor).init();const defaultBsVersion=null!==(_window$M=window.M)&&void 0!==_window$M&&null!==(_window$M$cfg=_window$M.cfg)&&void 0!==_window$M$cfg&&null!==(_window$M$cfg$version=_window$M$cfg.version)&&void 0!==_window$M$cfg$version&&_window$M$cfg$version.startsWith("5.")?"5.3.8":"4.6.2",bsVersion=(0,_options.getGlobalConfig)(editor,"tiny.iframe.jsbootstrap.version",defaultBsVersion),defaultJqVersion=bsVersion.startsWith("5.")?"none":"3.6.1";let jqVersion=(0,_options.getGlobalConfig)(editor,"tiny.iframe.jquery.version",defaultJqVersion);"none"===jqVersion&&bsVersion.startsWith("4.")&&(jqVersion="3.6.1");const requiresJquery="none"!==jqVersion,head=editor.getDoc().querySelector("head");try{if(requiresJquery&&await(0,_util.loadScriptAsync)(editor,`https://code.jquery.com/jquery-${jqVersion}.min.js`),"none"!==bsVersion&&await(0,_util.loadScriptAsync)(editor,`https://cdn.jsdelivr.net/npm/bootstrap@${bsVersion}/dist/js/bootstrap.bundle.min.js`),bsVersion.startsWith("5.")){const initScript=editor.dom.create("script");initScript.id="init_bs_comp",initScript.innerHTML="\n                    document.querySelectorAll('[data-bs-toggle=\"popover\"]').forEach(el => {\n                        new bootstrap.Popover(el, { trigger: 'hover' });\n                    });\n                ",head.appendChild(initScript)}else if(requiresJquery&&bsVersion.startsWith("4.")){const initScript=editor.dom.create("script");initScript.id="init_bs_comp",initScript.innerHTML="\n                    $(document).ready(function() {\n                        $('body').popover({\n                            selector: '[data-toggle=\"popover\"]',\n                            trigger: 'hover'\n                        });\n                    });\n                ",head.appendChild(initScript)}}catch(ex){console.error("Error loading scripts into editor's iframe: ",ex)}(0,_extension.getListeners)("onInit").forEach((listener=>listener(editor)))}))}(editor)}}}));

//# sourceMappingURL=commands.min.js.map