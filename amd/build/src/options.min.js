define("tiny_widgethub/options",["exports","editor_tiny/options","./common"],(function(_exports,_options,_common){var obj,_document$querySelect;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.Widget=_exports.Shared=_exports.EditorOptions=void 0,_exports.applyPartials=applyPartials,_exports.expandPartial=expandPartial,_exports.fixMissingParamProperties=fixMissingParamProperties,_exports.getAdditionalCss=void 0,_exports.getEditorOptions=function(editor){let instance=editorOptionsInstances.get(editor);instance||(instance=new EditorOptions(editor),editorOptionsInstances.set(editor,instance));return instance},_exports.register=_exports.isPluginVisible=_exports.getWidgetDict=void 0;const pluginName=(_common=(obj=_common)&&obj.__esModule?obj:{default:obj}).default.pluginName,showPlugin=(0,_options.getPluginOptionName)(pluginName,"showplugin"),userId=(0,_options.getPluginOptionName)(pluginName,"userid"),courseId=(0,_options.getPluginOptionName)(pluginName,"courseid"),widgetList=(0,_options.getPluginOptionName)(pluginName,"widgetlist"),shareStyles=(0,_options.getPluginOptionName)(pluginName,"sharestyles"),additionalCss=(0,_options.getPluginOptionName)(pluginName,"additionalcss");_exports.register=editor=>{const registerOption=editor.options.register;registerOption(showPlugin,{processor:"boolean",default:!0}),registerOption(userId,{processor:"string",default:"-1"}),registerOption(courseId,{processor:"string",default:"-1"}),registerOption(widgetList,{processor:"array",default:[]}),registerOption(shareStyles,{processor:"boolean",default:!0}),registerOption(additionalCss,{processor:"string",default:""})};_exports.isPluginVisible=editor=>editor.options.get(showPlugin);let _widgetDict;_exports.getAdditionalCss=editor=>editor.options.get(additionalCss);const getWidgetDict=editor=>{if(_widgetDict)return _widgetDict;let rawWidgets=editor.options.get(widgetList)??[];_widgetDict={};let partials=rawWidgets.filter((e=>"partials"===e.key))[0];partials&&(rawWidgets=rawWidgets.filter((e=>"partials"!==e.key)));const wrappedWidgets=rawWidgets.map((w=>new Widget(w,partials||{}))),id=editor.options.get(userId);return wrappedWidgets.filter((w=>w.isFor(id))).forEach((w=>{_widgetDict&&(_widgetDict[w.key]=w)})),_widgetDict};_exports.getWidgetDict=getWidgetDict;class EditorOptions{constructor(editor){this.editor=editor}get userId(){return parseInt(this.editor.options.get(userId))}get courseId(){return parseInt(this.editor.options.get(courseId))}get widgetDict(){return getWidgetDict(this.editor)}}_exports.EditorOptions=EditorOptions;const Shared={currentScope:null===(_document$querySelect=document.querySelector("body"))||void 0===_document$querySelect?void 0:_document$querySelect.id,activatePopup:!0,globalConfig:{}};function fixMissingParamProperties(param){var _param$options;if(param.type||(param.options?param.type="select":"boolean"==typeof param.value?param.type="checkbox":"number"==typeof param.value?param.type="numeric":"string"==typeof param.value&&(param.type=param.options?"select":"textfield")),!param.value)switch(param.type){case"checkbox":param.value=!1;break;case"numeric":param.value=0;break;case"select":param.value=null===(_param$options=param.options)||void 0===_param$options?void 0:_param$options[0],"object"==typeof param.value&&(param.value=param.value.v);break;case"color":param.value="#ffffff";break;default:param.value=""}}function expandPartial(obj,partials){if(null===(obj??null))return obj;let partialKey;return"string"==typeof obj&&obj.startsWith("__")&&obj.endsWith("__")?(partialKey=obj,obj={}):"object"==typeof obj&&obj.partial&&(partialKey=obj.partial,delete obj.partial),partialKey&&(partialKey=partialKey.replace(/__/g,""),partials[partialKey]?obj={...partials[partialKey],...obj}:console.error(`Cannot find partial for ${partialKey}`)),obj}function applyPartials(widget,partials){const regex=/__([\w\d]+)__/g;widget.template&&(widget.template=widget.template.replace(regex,((s0,s1)=>partials[s1]??s0)));const parameters=widget.parameters;parameters&&parameters.forEach(((param,i)=>{param=expandPartial(param,partials),parameters[i]=param;let prop=expandPartial(param.bind,partials);prop&&(param.bind=prop),prop=expandPartial(param.transform,partials),prop&&(param.transform=prop),fixMissingParamProperties(param)}))}_exports.Shared=Shared;class Widget{#widget;#instructionsParsed=!1;constructor(widget,partials){applyPartials(widget,partials=partials??{}),this.#widget=widget}get name(){return this.#widget.name}get key(){return this.#widget.key}get I18n(){return this.#widget.I18n||{}}get template(){return this.#widget.template??this.#widget.filter??""}get category(){return this.#widget.category??"MISC"}get insertquery(){return this.#widget.insertquery}get selectors(){return this.#widget.selectors}get unwrap(){return this.#widget.unwrap}get version(){return this.#widget.version||"1.0.0"}get instructions(){return this.#widget.instructions&&!this.#instructionsParsed&&(this.#widget.instructions=decodeURIComponent(this.#widget.instructions),this.#instructionsParsed=!0),this.#widget.instructions??""}get parameters(){return this.#widget.parameters??[]}get defaults(){const obj={};return(this.#widget.parameters??[]).forEach((param=>{obj[param.name]=param.value})),obj}isFor(userId){if(!0===this.#widget.hidden)return!1;let grantStr=(this.#widget.for||"").trim();if(""===grantStr||"*"===grantStr)return!0;let allowMode=!0;grantStr.startsWith("-")&&(allowMode=!1),grantStr=grantStr.replace(/[+\- ]/g,"");const grantList=grantStr.split(","),isAllowed=allowMode&&grantList.indexOf(userId+"")>=0||!allowMode&&grantList.indexOf(userId+"")<0;return isAllowed||console.warn(`Widget ${this.#widget.key} not allowed to user ${userId}: ${grantList}`),isAllowed}isFilter(){return void 0===this.#widget.template&&void 0!==this.#widget.filter}isUsableInScope(scope){scope=scope??Shared.currentScope??"";const widgetScopes=this.#widget.scope;if(!scope||!widgetScopes||"*"===widgetScopes)return!0;return null!==(new RegExp(widgetScopes).exec(scope)??null)}hasBindings(){return(this.#widget.parameters??[]).some((param=>void 0!==param.bind))}prop(name){return this.#widget[name]}}_exports.Widget=Widget;const editorOptionsInstances=new Map}));

//# sourceMappingURL=options.min.js.map