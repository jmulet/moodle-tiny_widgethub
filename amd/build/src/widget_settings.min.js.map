{"version":3,"file":"widget_settings.min.js","sources":["../../src/src/widget_settings.js"],"sourcesContent":["/* eslint-disable no-console */\n/* eslint-disable no-alert */\nimport jQuery from 'jquery';\nimport CodeProEditor from './libs/cm6pro-lazy';\nimport {load, dump} from './libs/js_yaml-lazy';\nimport {get_strings as getStrings} from 'core/str';\nimport {getTemplateSrv} from './service/templateSrv';\nimport {applyPartials} from './options';\n\nconst templateSrv = getTemplateSrv();\n\n/**\n * @class\n * @member {any[]} presetdata\n * */\nexport default {\n    /**\n     * @param {number} id\n     * @returns {{\n     *     $ymlArea: JQuery<HTMLTextAreaElement>,\n     *     $jsonArea: JQuery<HTMLTextAreaElement>,\n     *     $partialInput: JQuery<HTMLInputElement>,\n     * }}\n     */\n    getAreas: function(id) {\n        /** @type {*} */\n        const $ymlArea = jQuery(`#id_s_tiny_widgethub_defyml_${id}`);\n        /** @type {*} */\n        const $jsonArea = jQuery(`#id_s_tiny_widgethub_def_${id}`);\n        /** @type {*} */\n        const $partialInput = jQuery(`#id_s_tiny_widgethub_partials_${id}`);\n        return {\n            $ymlArea, $jsonArea, $partialInput\n        };\n    },\n    /**\n     * @param {number} id\n     * @param {*} codeProEditor\n     * @returns\n     */\n    updateYaml: function(id, codeProEditor) {\n        const {$jsonArea} = this.getAreas(id);\n        const json = (($jsonArea.val() ?? '') + '').trim();\n        if (!json) {\n            codeProEditor.setValue('');\n            return;\n        }\n        try {\n            const obj = JSON.parse(json);\n            const yml = dump(obj, {});\n            codeProEditor.setValue(yml);\n        } catch (ex) {\n            console.error(ex);\n            $jsonArea.val('');\n            codeProEditor.setValue('');\n        }\n    },\n    /**\n     * @param {string} yml\n     * @param {{id: number, keys: string[]}} opts\n     * @param {Record<string, *>} partials\n     * @returns {Promise<{msg: string, json?: string, html?: string}>}\n     */\n    validate: async function(yml, opts, partials) {\n        /**\n         * @type {{\n         *     msg: string,\n         *  html: string,\n         *  json: string | undefined\n         * }}\n         * */\n        const validation = {msg: '', html: '', json: undefined};\n        try {\n            // Check if the code is a valid Yaml\n            /** @type {import('./options').RawWidget} */\n            let jsonObj;\n            try {\n                jsonObj = load(yml, null) ?? {};\n            } catch (ex) {\n                validation.msg = \"Yaml syntax error:: \" + ex;\n                return validation;\n            }\n            validation.json = JSON.stringify(jsonObj, null, 0);\n\n            // Check if the structure is correct\n            if (!jsonObj?.key) {\n                validation.msg = \"Yaml file must contain a 'key' property. \";\n            } else if (jsonObj.key === \"partials\") {\n                return validation;\n            } else if (jsonObj.key !== 'partials' && (!jsonObj.name || !(jsonObj.template && jsonObj.filter))) {\n                validation.msg += \"Widgets must have 'name' and 'template or filter' properties. \";\n            }\n            // Check for duplicated keys\n            if (opts.id === 0 && jsonObj?.key) {\n                const keys = opts.keys || [];\n                if (keys.includes(jsonObj.key)) {\n                    validation.msg += `Key ${jsonObj.key} is already in use. Please rename it. `;\n                }\n            }\n            // Handle partials in parameters\n            applyPartials(jsonObj, partials);\n            // Try to parse the template with the correct renderer\n            const translations = jsonObj?.I18n ?? {};\n            /** @type {Object.<string, any>} */\n            const ctx = {};\n            (jsonObj.parameters ?? []).forEach(param => {\n                ctx[param.name] = param.value;\n            });\n            const engine = jsonObj?.engine;\n            const html = await templateSrv.render(jsonObj?.template || '', ctx, translations, engine);\n            validation.html = html;\n        } catch (ex) {\n            validation.msg = \"Renderer error:: \" + ex;\n        }\n        return validation;\n    },\n\n    /**\n     * Load all widgets\n     * @param {{id: number, keys: string[], partials: any}} opts\n     * @returns\n     */\n    init: async function(opts) {\n        const i18n = await getStrings([\n            {key: 'preview', component: 'tiny_widgethub'},\n            {key: 'delete', component: 'tiny_widgethub'},\n            {key: 'savechanges', component: 'tiny_widgethub'}\n        ]);\n\n        const {$ymlArea, $jsonArea, $partialInput} = this.getAreas(opts.id);\n        // Partials are passed through a hidden input element\n        const partials = JSON.parse($partialInput.val() || '{}');\n\n        // Hide the control that handles JSON and it is actually saved\n        $jsonArea.css(\"display\", \"none\");\n        const $target = $jsonArea.parent();\n        const $form = $jsonArea.closest(\"form\");\n        // Hide any submit button if found\n        $form.find('button[type=\"submit\"], input[type=\"submit\"]').hide();\n        // Add submit buttons and manually trigger form submit.\n        const $formButtons = jQuery(`<div class=\"row\"><div class=\"form-buttons offset-sm-3 col-sm-3\">\n            <button type=\"button\" class=\"btn btn-primary form-submit\">${i18n[2]}</button></div></div>`);\n        $form.append($formButtons);\n        const $saveBtn = $formButtons.find(\"button\");\n\n        // Create a preview panel\n        const $previewPanel = jQuery(`<div id=\"tiny_widgethub_pp_${opts.id}\" class=\"tiny_widgethub-previewpanel d-none\"></div>`);\n        $target.append($previewPanel);\n\n        const $previewBtn = jQuery(`<button type=\"button\" class=\"btn btn-secondary m-1\">\n            <i class=\"fas fa fa-magnifying-glass\"></i> ${i18n[0]}</button>`);\n        $previewBtn.on('click', async() => {\n            const yml = codeProEditor.getValue();\n            const validation = await this.validate(yml, opts, partials);\n            if (validation.msg) {\n                alert(validation.msg);\n            } else if (validation.html) {\n                $previewPanel.removeClass('d-none');\n                $jsonArea.trigger('focusin');\n                $jsonArea.val(validation.json ?? '');\n                $jsonArea.trigger('change');\n                $previewPanel.html(validation.html);\n            }\n        });\n        $target.append($previewBtn);\n\n        if (opts.id > 0) {\n            // Only show delete button on saved widgets (id=0 is reserved for new ones)\n            const $deleteBtn = jQuery(`<button type=\"button\" class=\"btn btn-danger m-1\">\n                <i class=\"fas fa fa-trash\"></i> ${i18n[1]}</button>`);\n            $deleteBtn.on('click', async() => {\n                // Ask confirmation\n                const answer = confirm('Do you want to delete this widget?');\n                if (!answer) {\n                    return;\n                }\n                // Clear all the controls\n                $jsonArea.trigger('focusin');\n                $jsonArea.val('');\n                $jsonArea.trigger('change');\n                $ymlArea.html('');\n                $previewPanel.html('');\n                // Send form by skipping validation\n                $form.trigger('submit');\n            });\n            $target.append($deleteBtn);\n        }\n\n        const codeProEditor = new CodeProEditor($ymlArea[0]);\n\n        $saveBtn.on(\"click\",\n            async() => {\n            // Must update the content from the Yaml control\n            const yml = codeProEditor.getValue();\n            // First validate the definition of the widget\n            const validation = await this.validate(yml, opts, partials);\n            if (validation.msg) {\n                alert(validation.msg);\n            } else {\n                // Ensure that there is a change in the form value to force\n                // the set_updatedcallback to be called\n                $jsonArea.trigger('focusin');\n                $jsonArea.val((validation.json ?? '') + ' ');\n                $jsonArea.trigger('change');\n                // Submit form\n                $form.trigger('submit');\n            }\n        });\n\n        this.updateYaml(opts.id, codeProEditor);\n    }\n};\n"],"names":["templateSrv","getAreas","id","$ymlArea","$jsonArea","$partialInput","updateYaml","codeProEditor","this","json","val","trim","obj","JSON","parse","yml","setValue","ex","console","error","validate","async","opts","partials","validation","msg","html","undefined","jsonObj","stringify","_jsonObj","key","name","template","filter","_jsonObj2","keys","includes","translations","I18n","ctx","parameters","forEach","param","value","engine","_jsonObj4","render","init","i18n","component","css","$target","parent","$form","closest","find","hide","$formButtons","append","$saveBtn","$previewPanel","$previewBtn","on","getValue","alert","removeClass","trigger","$deleteBtn","confirm","CodeProEditor"],"mappings":"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"}