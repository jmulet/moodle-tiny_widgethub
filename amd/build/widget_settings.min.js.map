{"version":3,"file":"widget_settings.min.js","sources":["../src/widget_settings.js"],"sourcesContent":["/* eslint-disable no-console */\n/* eslint-disable no-tabs */\n/* eslint-disable no-alert */\nimport jQuery from 'jquery';\nimport {templateRenderer} from './util';\nimport CodeProEditor from './cm6pro-lazy';\nimport {load, dump} from './js-yaml-lazy';\nimport {get_strings as getStrings} from 'core/str';\n\nexport default {\n\tfetchcontrols: function(id) {\n\t\tconst controls = {};\n\t\tcontrols.json = document.getElementById('id_s_tiny_widgethub_def_' + id);\n\t\treturn controls;\n\t},\n\tpopulateform: function(id, presetindex, presetdata) {\n\t\t// Get all our html controls\n\t\tconst controls = this.fetchcontrols(id);\n\n\t\t// What a rip off there was no selection!!!\n\t\tif (!presetindex && !presetdata) {\n\t\t\treturn;\n\t\t}\n\t\tif (presetindex == 0 && presetdata) {\n\t\t\t// This is good, we have something from dopopulate\n\t\t} else {\n\t\t\t// This is a normal selection\n\t\t\tpresetdata = this.presetdata;\n\t\t}\n\t\tconst snpt = presetdata[presetindex];\n\n\t\tcontrols.key.value = snpt.key;\n\t\t// Try to see JSON is valid\n\t\ttry {\n\t\t\tJSON.parse(snpt.json);\n\t\t\tcontrols.json.value = snpt.json;\n\t\t} catch (ex) {\n\t\t\tconsole.error(ex);\n\t\t\tcontrols.json.value = '';\n\t\t}\n\t},\n\tupdateYaml: function(id, codeProEditor) {\n\t\tconst controls = this.fetchcontrols(id);\n\t\tif (!controls.json.value.trim()) {\n\t\t\tcodeProEditor.setValue('');\n\t\t\treturn;\n\t\t}\n\t\ttry {\n\t\t\tconst obj = JSON.parse(controls.json.value);\n\t\t\tconst yml = dump(obj);\n\t\t\tcodeProEditor.setValue(yml);\n\t\t} catch (ex) {\n\t\t\tconsole.error(ex);\n\t\t\tcontrols.json.value = '';\n\t\t\tcodeProEditor.setValue('');\n\t\t}\n\t},\n\tdopopulate: function(id, templatedata) {\n\t\tconsole.info(\"dopopulate\", id, templatedata);\n\t\tthis.populateform(id, 0, new Array(templatedata));\n\t},\n\n\tvalidate: async function(yml, opts) {\n\t\tconst validation = {msg: '', html: ''};\n\t\ttry {\n\t\t\t// The code is a valid Yaml\n\t\t\tlet jsonObj = {};\n\t\t\ttry {\n\t\t\t\tjsonObj = load(yml) ?? {};\n\t\t\t} catch (ex) {\n\t\t\t\tvalidation.msg = \"Yaml syntax error:: \" + ex;\n\t\t\t}\n\t\t\tvalidation.json = JSON.stringify(jsonObj, null, 0);\n\t\t\t// The structure is correct\n\t\t\tif (!jsonObj.key) {\n\t\t\t\tvalidation.msg = \"Yaml file must contain a 'key' property. \";\n\t\t\t} else if (jsonObj.key === \"partials\") {\n\t\t\t\treturn validation;\n\t\t\t} else {\n\t\t\t\tif (jsonObj.key !== 'partials' && (!jsonObj.name || !jsonObj.template)) {\n\t\t\t\t\tvalidation.msg += \"Widgets must have 'name' and 'template' properties. \";\n\t\t\t\t}\n\t\t\t\tif (jsonObj.requires && typeof jsonObj.requires !== \"string\") {\n\t\t\t\t\tvalidation.msg += \"The property 'requires' must be a string. \";\n\t\t\t\t}\n\t\t\t}\n\t\t\t// Check for duplicated keys\n\t\t\tif (opts.id === 0) {\n\t\t\t\tconst keys = opts.keys || [];\n\t\t\t\tif (keys.includes(jsonObj.key)) {\n\t\t\t\t\tvalidation.msg += `Key ${jsonObj.key} is already in use. Please rename it. `;\n\t\t\t\t}\n\t\t\t}\n\t\t\t// Handle partials in parameters\n\t\t\tconst partials = this.getPartials();\n\t\t\tconst paramsCopy = (jsonObj?.parameters || []).map(param => {\n\t\t\t\tlet pc = {...param};\n\t\t\t\tif (pc.partial && partials[pc.partial]) {\n\t\t\t\t\tpc = Object.assign(pc, partials[pc.partial]);\n\t\t\t\t}\n\t\t\t\treturn pc;\n\t\t\t});\n\t\t\t// Try to parse the template with mustache renderer\n\t\t\tconst translations = jsonObj?.I18n?.en || {};\n\t\t\tconst ctx = {};\n\t\t\tparamsCopy.forEach(param => {\n\t\t\t\tctx[param.name] = param.value;\n\t\t\t});\n\t\t\tconst engine = jsonObj.engine;\n\t\t\tconst htmlRendered = await templateRenderer(jsonObj.template, ctx, translations, engine);\n\t\t\tvalidation.html = htmlRendered;\n\t\t} catch (ex) {\n\t\t\tvalidation.msg = \"Renderer error:: \" + ex;\n\t\t}\n\t\treturn validation;\n\t},\n\n\tgetPartials: function() {\n\t\tlet partials = null;\n\t\tlet i = 0;\n\t\tconst len = (this.presetdata || []).length;\n\t\twhile (partials === null && i < len) {\n\t\t\tif (this.presetdata[i].key === \"partials\") {\n\t\t\t\tpartials = this.presetdata[i];\n\t\t\t}\n\t\t\ti++;\n\t\t}\n\t\treturn partials || {};\n\t},\n\n\t// Load all widget stuff and stash all our constiables\n\tinit: async function(opts) {\n\t\tconsole.info(\"Init AMD called with opts \", JSON.stringify(opts));\n\t\tconst i18n = await getStrings([\n\t\t\t{key: 'preview', component: 'tiny_widgethub'},\n\t\t\t{key: 'delete', component: 'tiny_widgethub'}\n\t\t]);\n\n\t\tthis.presetdata = [];\n\t\t// Hide the control that handles JSON and it is actually saved\n\t\tconst $controlMain = jQuery('#id_s_tiny_widgethub_def_' + opts.id);\n\t\t$controlMain.css(\"display\", \"none\");\n\t\tconst $target = $controlMain.parent();\n\n\t\t// Display the secondary editor for Yaml syntax\n\t\tconst $controlSecondary = jQuery(`<div id=\"tiny_widgethub_yc_${opts.id}\" class=\"tiny_widgethub-ymlcontrol\"></div>`);\n\t\t$target.append($controlSecondary);\n\n\t\tconst $previewPanel = jQuery(`<div id=\"tiny_widgethub_pp_${opts.id}\" class=\"tiny_widgethub-previewpanel d-none\"></div>`);\n\t\t$target.append($previewPanel);\n\n\t\tconst $previewBtn = jQuery(`<button type=\"button\" class=\"btn btn-secondary m-1\">${i18n[0]}</button>`);\n\t\t$previewBtn.on('click', async() => {\n\t\t\tconst yml = codeProEditor.getValue();\n\t\t\tconst validation = await this.validate(yml, opts);\n\t\t\tif (validation.msg) {\n\t\t\t\talert(validation.msg);\n\t\t\t} else {\n\t\t\t\t$previewPanel.removeClass('d-none');\n\t\t\t\t$controlMain.val(validation.json);\n\t\t\t\t$previewPanel.html(validation.html);\n\t\t\t}\n\t\t});\n\t\t$target.append($previewBtn);\n\n\t\tif (opts.id > 0) {\n\t\t\tconst $deleteBtn = jQuery(`<button type=\"button\" class=\"btn btn-danger m-1\">${i18n[1]}</button>`);\n\t\t\t$deleteBtn.on('click', async() => {\n\t\t\t\t// Clear all the controls\n\t\t\t\t$controlMain.val('');\n\t\t\t\t$controlSecondary.html('');\n\t\t\t\t$previewPanel.html('');\n\t\t\t\t// Send form by skipping validation\n\t\t\t\t$controlMain.closest(\"form\").trigger('submit', {skipValidation: true});\n\t\t\t});\n\t\t\t$target.append($deleteBtn);\n\t\t}\n\n\t\tconst codeProEditor = new CodeProEditor($controlSecondary[0]);\n\n\t\tconst self = this;\n\n\t\t// Handle the select box change event\n\t\tjQuery(\"select[name='tiny_widgethub/hub']\").on('change', function() {\n\t\t\tconsole.info(jQuery(this).val());\n\t\t\tself.populateform(opts.id, jQuery(this).val());\n\t\t\tself.updateYaml(opts.id, codeProEditor);\n\t\t});\n\n\t\t$controlMain.closest(\"form\").on(\"submit\", async(ev) => {\n\t\t\t// Must update the content from the Yaml control\n\t\t\tconst yml = codeProEditor.getValue();\n\t\t\t// First validate the definition of the widget\n\t\t\tif (!ev.skipValidation) {\n\t\t\t\tconst validation = await this.validate(yml, opts);\n\t\t\t\tif (validation.msg) {\n\t\t\t\t\talert(validation.msg);\n\t\t\t\t\tev.preventDefault();\n\t\t\t\t} else {\n\t\t\t\t\t$controlMain.val(validation.json);\n\t\t\t\t}\n\t\t\t\treturn validation.msg === '';\n\t\t\t}\n\t\t\treturn true;\n\t\t});\n\n\t\tthis.updateYaml(opts.id, codeProEditor);\n\t}\n};\n"],"names":["fetchcontrols","id","controls","json","document","getElementById","populateform","presetindex","presetdata","this","snpt","key","value","JSON","parse","ex","console","error","updateYaml","codeProEditor","trim","obj","yml","setValue","dopopulate","templatedata","info","Array","validate","async","opts","validation","msg","html","jsonObj","stringify","name","template","requires","keys","includes","partials","getPartials","paramsCopy","parameters","map","param","pc","partial","Object","assign","translations","I18n","en","ctx","forEach","engine","htmlRendered","i","len","length","init","i18n","component","$controlMain","css","$target","parent","$controlSecondary","append","$previewPanel","$previewBtn","on","getValue","alert","removeClass","val","$deleteBtn","closest","trigger","skipValidation","CodeProEditor","self","ev","preventDefault"],"mappings":"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"}