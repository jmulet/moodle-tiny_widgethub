define("tiny_widgethub/widget_settings",["exports","jquery","./util","./cm6pro-lazy","./js_yaml-lazy","core/str"],(function(_exports,_jquery,_util,_cm6proLazy,_js_yamlLazy,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_cm6proLazy=_interopRequireDefault(_cm6proLazy);var _default={presetdata:[],fetchcontrols:function(id){return{json:document.getElementById(`id_s_tiny_widgethub_def_${id}`)}},populateform:function(id,presetindex,presetdata){const controls=this.fetchcontrols(id);if(!controls.json)return;if(!presetindex&&!presetdata)return;0==presetindex&&presetdata||(presetdata=this.presetdata);const snpt=presetdata[presetindex];try{JSON.parse(snpt.json),controls.json.value=snpt.json}catch(ex){console.error(ex),controls.json.value=""}},updateYaml:function(id,codeProEditor){var _controls$json,_controls$json$value;const controls=this.fetchcontrols(id);if(null!==(_controls$json=controls.json)&&void 0!==_controls$json&&null!==(_controls$json$value=_controls$json.value)&&void 0!==_controls$json$value&&_controls$json$value.trim())try{const obj=JSON.parse(controls.json.value),yml=(0,_js_yamlLazy.dump)(obj,{});codeProEditor.setValue(yml)}catch(ex){console.error(ex),controls.json.value="",codeProEditor.setValue("")}else codeProEditor.setValue("")},dopopulate:function(id,templatedata){console.info("dopopulate",id,templatedata),this.populateform(id,0,new Array(templatedata))},validate:async function(yml,opts){const validation={msg:"",html:"",json:void 0};try{var _jsonObj,_jsonObj2,_jsonObj3,_jsonObj4,_jsonObj5,_jsonObj6;let jsonObj;try{jsonObj=(0,_js_yamlLazy.load)(yml,null)??{}}catch(ex){validation.msg="Yaml syntax error:: "+ex}if(validation.json=JSON.stringify(jsonObj,null,0),null!==(_jsonObj=jsonObj)&&void 0!==_jsonObj&&_jsonObj.key){if("partials"===jsonObj.key)return validation;"partials"===jsonObj.key||jsonObj.name&&jsonObj.template||(validation.msg+="Widgets must have 'name' and 'template' properties. ")}else validation.msg="Yaml file must contain a 'key' property. ";if(0===opts.id&&null!==(_jsonObj2=jsonObj)&&void 0!==_jsonObj2&&_jsonObj2.key){(opts.keys||[]).includes(jsonObj.key)&&(validation.msg+=`Key ${jsonObj.key} is already in use. Please rename it. `)}const partials=opts.partials,paramsCopy=((null===(_jsonObj3=jsonObj)||void 0===_jsonObj3?void 0:_jsonObj3.parameters)||[]).map((param=>{let pc={...param};return pc.partial&&partials[pc.partial]&&(pc=Object.assign(pc,partials[pc.partial])),pc})),translations=(null===(_jsonObj4=jsonObj)||void 0===_jsonObj4?void 0:_jsonObj4.I18n)||{},ctx={};paramsCopy.forEach((param=>{ctx[param.name]=param.value}));const engine=null===(_jsonObj5=jsonObj)||void 0===_jsonObj5?void 0:_jsonObj5.engine,html=await(0,_util.templateRenderer)((null===(_jsonObj6=jsonObj)||void 0===_jsonObj6?void 0:_jsonObj6.template)||"",ctx,translations,engine);validation.html=html}catch(ex){validation.msg="Renderer error:: "+ex}return validation},init:async function(opts){console.info("Init AMD called with opts ",JSON.stringify(opts));const i18n=await(0,_str.get_strings)([{key:"preview",component:"tiny_widgethub"},{key:"delete",component:"tiny_widgethub"}]),$controlMain=(0,_jquery.default)("#id_s_tiny_widgethub_def_"+opts.id);$controlMain.css("display","none");const $target=$controlMain.parent(),$form=$controlMain.closest("form"),$submitBtn=$form.find('button[type="submit"]'),$saveBtn=$submitBtn.clone().attr("type","button").removeAttr("id");$submitBtn.css("display","none"),$submitBtn.parent().append($saveBtn);const $controlSecondary=(0,_jquery.default)(`<div id="tiny_widgethub_yc_${opts.id}" class="tiny_widgethub-ymlcontrol"></div>`);$target.append($controlSecondary);const $previewPanel=(0,_jquery.default)(`<div id="tiny_widgethub_pp_${opts.id}" class="tiny_widgethub-previewpanel d-none"></div>`);$target.append($previewPanel);const $previewBtn=(0,_jquery.default)(`<button type="button" class="btn btn-secondary m-1">${i18n[0]}</button>`);if($previewBtn.on("click",(async()=>{const yml=codeProEditor.getValue(),validation=await this.validate(yml,opts);validation.msg?alert(validation.msg):validation.html&&($previewPanel.removeClass("d-none"),$controlMain.trigger("focusin"),$controlMain.val(validation.json??""),$controlMain.trigger("change"),$previewPanel.html(validation.html))})),$target.append($previewBtn),opts.id>0){const $deleteBtn=(0,_jquery.default)(`<button type="button" class="btn btn-danger m-1">${i18n[1]}</button>`);$deleteBtn.on("click",(async()=>{$controlMain.trigger("focusin"),$controlMain.val(""),$controlMain.trigger("change"),$controlSecondary.html(""),$previewPanel.html(""),$form.trigger("submit")})),$target.append($deleteBtn)}const codeProEditor=new _cm6proLazy.default($controlSecondary[0]),self=this;(0,_jquery.default)("select[name='tiny_widgethub/hub']").on("change",(function(){const choosen=(0,_jquery.default)(this).val();console.info(choosen),choosen&&(self.populateform(opts.id,choosen),self.updateYaml(opts.id,codeProEditor))})),$saveBtn.on("click",(async()=>{const yml=codeProEditor.getValue(),validation=await this.validate(yml,opts);validation.msg?alert(validation.msg):($controlMain.trigger("focusin"),$controlMain.val((validation.json??"")+" "),$controlMain.trigger("change"),$form.trigger("submit"))})),this.updateYaml(opts.id,codeProEditor)}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=widget_settings.min.js.map