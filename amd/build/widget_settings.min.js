define("tiny_widgethub/widget_settings",["exports","jquery","./util","./cm6pro-lazy","./js-yaml-lazy","core/str"],(function(_exports,_jquery,_util,_cm6proLazy,_jsYamlLazy,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_cm6proLazy=_interopRequireDefault(_cm6proLazy);var _default={fetchcontrols:function(id){const controls={};return controls.json=document.getElementById("id_s_tiny_widgethub_def_"+id),controls},populateform:function(id,presetindex,presetdata){const controls=this.fetchcontrols(id);if(!presetindex&&!presetdata)return;0==presetindex&&presetdata||(presetdata=this.presetdata);const snpt=presetdata[presetindex];controls.key.value=snpt.key;try{JSON.parse(snpt.json),controls.json.value=snpt.json}catch(ex){console.error(ex),controls.json.value=""}},updateYaml:function(id,codeProEditor){const controls=this.fetchcontrols(id);if(controls.json.value.trim())try{const obj=JSON.parse(controls.json.value),yml=(0,_jsYamlLazy.dump)(obj);codeProEditor.setValue(yml)}catch(ex){console.error(ex),controls.json.value="",codeProEditor.setValue("")}else codeProEditor.setValue("")},dopopulate:function(id,templatedata){console.info("dopopulate",id,templatedata),this.populateform(id,0,new Array(templatedata))},validate:async function(yml,opts){const validation={msg:"",html:""};try{var _jsonObj,_jsonObj2,_jsonObj2$I18n;let jsonObj={};try{var _load;jsonObj=null!==(_load=(0,_jsYamlLazy.load)(yml))&&void 0!==_load?_load:{}}catch(ex){validation.msg="Yaml syntax error:: "+ex}if(validation.json=JSON.stringify(jsonObj,null,0),jsonObj.key){if("partials"===jsonObj.key)return validation;"partials"===jsonObj.key||jsonObj.name&&jsonObj.template||(validation.msg+="Widgets must have 'name' and 'template' properties. "),jsonObj.requires&&"string"!=typeof jsonObj.requires&&(validation.msg+="The property 'requires' must be a string. ")}else validation.msg="Yaml file must contain a 'key' property. ";if(0===opts.id){(opts.keys||[]).includes(jsonObj.key)&&(validation.msg+="Key ".concat(jsonObj.key," is already in use. Please rename it. "))}const partials=this.getPartials(),paramsCopy=((null===(_jsonObj=jsonObj)||void 0===_jsonObj?void 0:_jsonObj.parameters)||[]).map((param=>{let pc={...param};return pc.partial&&partials[pc.partial]&&(pc=Object.assign(pc,partials[pc.partial])),pc})),translations=(null===(_jsonObj2=jsonObj)||void 0===_jsonObj2||null===(_jsonObj2$I18n=_jsonObj2.I18n)||void 0===_jsonObj2$I18n?void 0:_jsonObj2$I18n.en)||{},ctx={};paramsCopy.forEach((param=>{ctx[param.name]=param.value}));const engine=jsonObj.engine,htmlRendered=await(0,_util.templateRenderer)(jsonObj.template,ctx,translations,engine);validation.html=htmlRendered}catch(ex){validation.msg="Renderer error:: "+ex}return validation},getPartials:function(){let partials=null,i=0;const len=(this.presetdata||[]).length;for(;null===partials&&i<len;)"partials"===this.presetdata[i].key&&(partials=this.presetdata[i]),i++;return partials||{}},init:async function(opts){console.info("Init AMD called with opts ",JSON.stringify(opts));const i18n=await(0,_str.get_strings)([{key:"preview",component:"tiny_widgethub"},{key:"delete",component:"tiny_widgethub"}]);this.presetdata=[];const $controlMain=(0,_jquery.default)("#id_s_tiny_widgethub_def_"+opts.id);$controlMain.css("display","none");const $target=$controlMain.parent(),$controlSecondary=(0,_jquery.default)('<div id="tiny_widgethub_yc_'.concat(opts.id,'" class="tiny_widgethub-ymlcontrol"></div>'));$target.append($controlSecondary);const $previewPanel=(0,_jquery.default)('<div id="tiny_widgethub_pp_'.concat(opts.id,'" class="tiny_widgethub-previewpanel d-none"></div>'));$target.append($previewPanel);const $previewBtn=(0,_jquery.default)('<button type="button" class="btn btn-secondary m-1">'.concat(i18n[0],"</button>"));if($previewBtn.on("click",(async()=>{const yml=codeProEditor.getValue(),validation=await this.validate(yml,opts);validation.msg?alert(validation.msg):($previewPanel.removeClass("d-none"),$controlMain.val(validation.json),$previewPanel.html(validation.html))})),$target.append($previewBtn),opts.id>0){const $deleteBtn=(0,_jquery.default)('<button type="button" class="btn btn-danger m-1">'.concat(i18n[1],"</button>"));$deleteBtn.on("click",(async()=>{$controlMain.val(""),$controlSecondary.html(""),$previewPanel.html(""),$controlMain.closest("form").trigger("submit",{skipValidation:!0})})),$target.append($deleteBtn)}const codeProEditor=new _cm6proLazy.default($controlSecondary[0]),self=this;(0,_jquery.default)("select[name='tiny_widgethub/hub']").on("change",(function(){console.info((0,_jquery.default)(this).val()),self.populateform(opts.id,(0,_jquery.default)(this).val()),self.updateYaml(opts.id,codeProEditor)})),$controlMain.closest("form").on("submit",(async ev=>{const yml=codeProEditor.getValue();if(!ev.skipValidation){const validation=await this.validate(yml,opts);return validation.msg?(alert(validation.msg),ev.preventDefault()):$controlMain.val(validation.json),""===validation.msg}return!0})),this.updateYaml(opts.id,codeProEditor)}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=widget_settings.min.js.map