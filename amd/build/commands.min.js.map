{"version":3,"file":"commands.min.js","sources":["../src/commands.js"],"sourcesContent":["/* eslint-disable no-console */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny WidgetHub plugin.\n *\n * @module      tiny_widgethub/plugin\n * @copyright   2024 Josep Mulet Pol <pep.mulet@gmail.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {getButtonImage} from 'editor_tiny/utils';\nimport {get_string as getString} from 'core/str';\nimport Common from './common';\nimport * as cfg from 'core/config';\nimport {isPluginVisible} from './options';\nimport jQuery from 'jquery';\nimport {initContextActions} from './contextInit';\nimport {DIContainer} from './container';\n\n\nexport const getSetup = async() => {\n    // Get some translations\n    const [widgetNameTitle, buttonImage] = await Promise.all([\n        // @ts-ignore\n        getString('settings', Common.component),\n        getButtonImage('icon', Common.component),\n    ]);\n\n    /** @param {import('./plugin').TinyMCE} editor */\n    return (editor) => {\n        // Create DI container scoped to this editor instance\n        const container = new DIContainer(editor);\n\n        if (isPluginVisible(editor)) {\n            // Register the Icon.\n            editor.ui.registry.addIcon(Common.icon, buttonImage.html);\n\n            // Register the Toolbar Button.\n            editor.ui.registry.addButton(Common.component, {\n                icon: Common.icon,\n                tooltip: widgetNameTitle,\n                onAction: () => container.widgetPickCtrl.handleAction(),\n            });\n\n            // Add the Menu Item.\n            // This allows it to be added to a standard menu, or a context menu.\n            editor.ui.registry.addMenuItem(Common.component, {\n                icon: Common.icon,\n                text: widgetNameTitle,\n                onAction: () => container.widgetPickCtrl.handleAction(),\n            });\n        }\n        // Initialize styles and scripts into editor's iframe\n        initializer(container);\n    };\n};\n\n\n/**\n * Inject styles and scripts into editor's iframe\n * @param {import('./container').DIContainer} container\n */\nfunction initializer(container) {\n    const { editor, editorOptions } = container;\n    // Add the bootstrap, CSS, etc... into the editor's iframe\n    editor.on('init', () => {\n        // On init editor.dom is ready\n        // Inject css all generated by Moodle into the editor's iframe\n        // http://localhost:4141/theme/styles.php/boost/1721728984_1/all\n        // TODO: Missing themesubrevision\n        const subversion = 1;\n        // @ts-ignore\n        const allCss = `${cfg.wwwroot}/theme/styles.php/${cfg.theme}/${cfg.themerev}_${subversion}/all`;\n        editor.dom.loadCSS(allCss);\n\n        // Inject styles and Javascript into the editor's iframe\n        // editor.dom.loadCSS(`${baseUrl}/libs/fontawesome/css/font-awesome.min.css`);\n        // Discover the jQuery version\n        const jQueryVersion = jQuery.fn.jquery ?? '3.6.1';\n        const scriptJQ = editor.dom.create(\"script\", { src: `https://code.jquery.com/jquery-${jQueryVersion}.min.js` });\n        const head = editor.getDoc().querySelector(\"head\");\n        scriptJQ.onload = () => {\n            // Cannot load BS until JQ is fully loaded\n            // @ts-ignore\n            const bsVersion = jQuery.fn.tooltip?.Constructor?.VERSION ?? '4.6.2';\n            const scriptBS = editor.dom.create(\"script\",\n                { src: `https://cdn.jsdelivr.net/npm/bootstrap@${bsVersion}/dist/js/bootstrap.bundle.min.js` });\n            head.appendChild(scriptBS);\n\n            // Activate popover and tooltips\n            scriptBS.onload = () => {\n                const scriptInitBS = editor.dom.create(\"script\");\n                scriptInitBS.innerHTML = `\n                $(document).ready(function() {\n                    $('body').tooltip({\n                        selector: '[data-toggle=\"tooltip\"]',\n                        trigger: 'hover'\n                    });\n                    $('body').popover({\n                        selector: '[data-toggle=\"popover\"]',\n                        trigger: 'hover'\n                    });\n                });`;\n                head.appendChild(scriptInitBS);\n            };\n            // Initialize context toolbars and menus\n            initContextActions(container);\n        };\n\n        head.appendChild(scriptJQ);\n        // Inject css from site Admin\n        const adminCss = editorOptions.additionalCss || '';\n        if (adminCss.trim()) {\n            editor.dom.addStyle(adminCss);\n        }\n    });\n}\n"],"names":["async","widgetNameTitle","buttonImage","Promise","all","Common","component","editor","container","DIContainer","ui","registry","addIcon","icon","html","addButton","tooltip","onAction","widgetPickCtrl","handleAction","addMenuItem","text","editorOptions","on","subversion","allCss","cfg","wwwroot","theme","themerev","dom","loadCSS","jQueryVersion","jQuery","fn","jquery","scriptJQ","create","src","head","getDoc","querySelector","onload","bsVersion","Constructor","VERSION","scriptBS","appendChild","scriptInitBS","innerHTML","adminCss","additionalCss","trim","addStyle","initializer"],"mappings":";;;;;;;80BAkCwBA,gBAEbC,gBAAiBC,mBAAqBC,QAAQC,IAAI,EAErD,mBAAU,WAAYC,gBAAOC,YAC7B,yBAAe,OAAQD,gBAAOC,oBAI1BC,eAEEC,UAAY,IAAIC,uBAAYF,SAE9B,4BAAgBA,UAEhBA,OAAOG,GAAGC,SAASC,QAAQP,gBAAOQ,KAAMX,YAAYY,MAGpDP,OAAOG,GAAGC,SAASI,UAAUV,gBAAOC,UAAW,CAC3CO,KAAMR,gBAAOQ,KACbG,QAASf,gBACTgB,SAAU,IAAMT,UAAUU,eAAeC,iBAK7CZ,OAAOG,GAAGC,SAASS,YAAYf,gBAAOC,UAAW,CAC7CO,KAAMR,gBAAOQ,KACbQ,KAAMpB,gBACNgB,SAAU,IAAMT,UAAUU,eAAeC,2BAapCX,iBACXD,OAAEA,OAAFe,cAAUA,eAAkBd,UAElCD,OAAOgB,GAAG,QAAQ,WAKRC,WAAa,EAEbC,OAAU,GAAEC,IAAIC,4BAA4BD,IAAIE,SAASF,IAAIG,YAAYL,iBAC/EjB,OAAOuB,IAAIC,QAAQN,cAKbO,cAAgBC,gBAAOC,GAAGC,QAAU,QACpCC,SAAW7B,OAAOuB,IAAIO,OAAO,SAAU,CAAEC,IAAM,kCAAiCN,yBAChFO,KAAOhC,OAAOiC,SAASC,cAAc,QAC3CL,SAASM,OAAS,wDAGRC,sDAAmBT,GAAGlB,wFAAS4B,0EAAaC,UAAW,QACvDC,SAAWvC,OAAOuB,IAAIO,OAAO,SAC/B,CAAEC,IAAM,0CAAyCK,8CACrDJ,KAAKQ,YAAYD,UAGjBA,SAASJ,OAAS,WACRM,aAAezC,OAAOuB,IAAIO,OAAO,UACvCW,aAAaC,UAAa,gaAW1BV,KAAKQ,YAAYC,mDAGFxC,YAGvB+B,KAAKQ,YAAYX,gBAEXc,SAAW5B,cAAc6B,eAAiB,GAC5CD,SAASE,QACT7C,OAAOuB,IAAIuB,SAASH,aA5DxBI,CAAY9C"}