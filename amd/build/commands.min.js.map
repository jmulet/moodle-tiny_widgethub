{"version":3,"file":"commands.min.js","sources":["../src/commands.js"],"sourcesContent":["\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny WidgetHub plugin.\n *\n * @module      tiny_widgethub/plugin\n * @copyright   2024 Josep Mulet Pol <pep.mulet@gmail.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {displayFilepicker, getButtonImage} from 'editor_tiny/utils';\nimport {get_string as getString} from 'core/str';\nimport Common from './common';\nimport * as cfg from 'core/config';\nimport {DIContainer} from './container';\nimport {initContextActions} from './contextInit';\nimport {EditorOptions, getAdditionalCss, isPluginVisible} from './options';\nimport {getFilePicker} from 'editor_tiny/options';\nimport {FormCtrl} from './controller/formCtrl';\nimport {WidgetParamsCtrl} from './controller/widgetParamsCtrl';\nimport {WidgetPickerCtrl} from './controller/widgetPickerCtrl';\nimport WidgetPropertiesCtrl from './controller/widgetPropertiesCtrl';\nimport {DomSrv} from './service/domSrv';\nimport {ModalSrv} from './service/modalSrv';\nimport {TemplateSrv} from './service/templateSrv';\nimport {UserStorageSrv} from './service/userStorageSrv';\nimport {applyWidgetFilterFactory} from './util';\nimport * as coreStr from \"core/str\";\nimport jQuery from \"jquery\";\nimport Mustache from 'core/mustache';\n\nexport const getSetup = async() => {\n    // Get some translations\n    const [widgetNameTitle, buttonImage] = await Promise.all([\n        // @ts-ignore\n        getString('settings', Common.component),\n        getButtonImage('icon', Common.component),\n    ]);\n\n    /** @param {import('./plugin').TinyMCE} editor */\n    return (editor) => {\n        // Check if the option visible is set.\n        if (!isPluginVisible(editor)) {\n            return;\n        }\n        // Register the Icon.\n        editor.ui.registry.addIcon(Common.icon, buttonImage.html);\n\n        const defaultAction = () => {\n            const container = DIContainer.init(editor);\n            const widgetPickCtrl = container.get(\"widgetPickCtrl\");\n            widgetPickCtrl.handleAction();\n        };\n\n        // Register the Toolbar Button.\n        editor.ui.registry.addButton(Common.component, {\n            icon: Common.icon,\n            tooltip: widgetNameTitle,\n            onAction: defaultAction,\n        });\n\n        // Add the Menu Item.\n        // This allows it to be added to a standard menu, or a context menu.\n        editor.ui.registry.addMenuItem(Common.component, {\n            icon: Common.icon,\n            text: widgetNameTitle,\n            onAction: defaultAction,\n        });\n\n        // Initialize context menus, styles and scripts into editor's iframe\n        initializer(editor);\n    };\n};\n\n\n/**\n * Inject styles and scripts into editor's iframe\n * @param {import('./plugin').TinyMCE} editor\n */\nfunction initializer(editor) {\n    // Add the bootstrap, CSS, etc... into the editor's iframe\n    editor.on('init', () => {\n        const jQuery = DIContainer.get(\"jQuery\");\n        // On init editor.dom is ready\n        // Inject css all generated by Moodle into the editor's iframe\n        // http://localhost:4141/theme/styles.php/boost/1721728984_1/all\n        // TODO: Missing themesubrevision\n        const subversion = 1;\n        // @ts-ignore\n        const allCss = `${cfg.wwwroot}/theme/styles.php/${cfg.theme}/${cfg.themerev}_${subversion}/all`;\n        editor.dom.loadCSS(allCss);\n\n        // Inject styles and Javascript into the editor's iframe\n        // editor.dom.loadCSS(`${baseUrl}/libs/fontawesome/css/font-awesome.min.css`);\n        // Discover the jQuery version\n        const jQueryVersion = jQuery.fn.jquery ?? '3.6.1';\n        const scriptJQ = editor.dom.create(\"script\", {src: `https://code.jquery.com/jquery-${jQueryVersion}.min.js`});\n        const head = editor.getDoc().querySelector(\"head\");\n        scriptJQ.onload = () => {\n            // Cannot load BS until JQ is fully loaded on editor's iframe\n            // @ts-ignore\n            const bsVersion = jQuery.fn.tooltip?.Constructor?.VERSION ?? '4.6.2';\n            const scriptBS = editor.dom.create(\"script\",\n                {src: `https://cdn.jsdelivr.net/npm/bootstrap@${bsVersion}/dist/js/bootstrap.bundle.min.js`});\n            head.appendChild(scriptBS);\n\n            // Activate popover and tooltips\n            scriptBS.onload = () => {\n                const scriptInitBS = editor.dom.create(\"script\");\n                scriptInitBS.innerHTML = `\n                $(document).ready(function() {\n                    $('body').tooltip({\n                        selector: '[data-toggle=\"tooltip\"]',\n                        trigger: 'hover'\n                    });\n                    $('body').popover({\n                        selector: '[data-toggle=\"popover\"]',\n                        trigger: 'hover'\n                    });\n                });`;\n                head.appendChild(scriptInitBS);\n            };\n            // Initialize context toolbars and menus\n            initContextActions(editor);\n        };\n\n        head.appendChild(scriptJQ);\n        // Inject css from site Admin\n        const adminCss = getAdditionalCss(editor) || '';\n        if (adminCss.trim()) {\n            editor.dom.addStyle(adminCss);\n        }\n    });\n}\n\nexport class FileSrv {\n    /**\n     * @param {import('./plugin').TinyMCE} editor\n     */\n    constructor(editor) {\n        this.editor = editor;\n    }\n    getImagePicker() {\n        return getFilePicker(this.editor, 'image');\n    }\n    displayImagePicker() {\n        return displayFilepicker(this.editor, 'image');\n    }\n}\n\n/**\n * Load on demand the template engine EJS\n * @typedef {Object} EJS\n * @property {(template: string, ctx: Object.<string,any>) => string} render\n */\n/** @type {EJS | undefined} */\nlet _ejs;\nexport const ejsLoader = () => {\n    if (_ejs) {\n        return Promise.resolve(_ejs);\n    }\n    return new Promise((resolve, reject) => {\n        // @ts-ignore\n        window.require(['tiny_widgethub/ejs-lazy'], (ejsModule) => {\n            _ejs = ejsModule;\n            if (_ejs) {\n                resolve(_ejs);\n            } else {\n                reject();\n            }\n        }, reject);\n    });\n};\n\n// Setup container for usage\n/** @typedef {{localStorage: Storage, sessionStorage: Storage}} IStorage */\nDIContainer.registerSingleton(\"jQuery\", jQuery);\nDIContainer.registerSingleton(\"coreStr\", coreStr);\nDIContainer.registerSingleton(\"modalSrv\", ModalSrv);\nDIContainer.registerSingleton(\"mustache\", Mustache);\nDIContainer.registerSingleton(\"ejsLoader\", ejsLoader);\nDIContainer.registerSingleton(\"iStorage\", {localStorage, sessionStorage});\nDIContainer.registerSingleton(\"domSrv\", DomSrv, \"jQuery\");\nDIContainer.registerSingleton(\"templateSrv\", TemplateSrv, \"mustache, ejsLoader\");\nDIContainer.registerSingleton(\"userStorage\", UserStorageSrv, \"editorOptions, iStorage\");\nDIContainer.registerSingleton(\"applyWidgetFilter\", applyWidgetFilterFactory, \"editor, coreStr\");\n\nDIContainer.registerFactory(\"widgetParamsFactory\", WidgetParamsCtrl, \"editor, userStorage, templateSrv, modalSrv, formCtrl\");\nDIContainer.registerService(\"editorOptions\", EditorOptions, \"editor\");\nDIContainer.registerService(\"widgetPickCtrl\", WidgetPickerCtrl,\n    \"editor, editorOptions, widgetParamsFactory, modalSrv, templateSrv, userStorage\");\nDIContainer.registerService(\"widgetPropertiesCtrl\", WidgetPropertiesCtrl, \"editor, formCtrl, modalSrv\");\nDIContainer.registerService(\"formCtrl\", FormCtrl, \"editor, userStorage, templateSrv, fileSrv, jQuery\");\nDIContainer.registerService(\"fileSrv\", FileSrv, \"editor\");"],"names":["async","widgetNameTitle","buttonImage","Promise","all","Common","component","editor","ui","registry","addIcon","icon","html","defaultAction","DIContainer","init","get","handleAction","addButton","tooltip","onAction","addMenuItem","text","on","jQuery","subversion","allCss","cfg","wwwroot","theme","themerev","dom","loadCSS","jQueryVersion","fn","jquery","scriptJQ","create","src","head","getDoc","querySelector","onload","bsVersion","Constructor","VERSION","scriptBS","appendChild","scriptInitBS","innerHTML","adminCss","trim","addStyle","initializer","FileSrv","constructor","getImagePicker","this","displayImagePicker","_ejs","ejsLoader","resolve","reject","window","require","ejsModule","registerSingleton","coreStr","ModalSrv","Mustache","localStorage","sessionStorage","DomSrv","TemplateSrv","UserStorageSrv","applyWidgetFilterFactory","registerFactory","WidgetParamsCtrl","registerService","EditorOptions","WidgetPickerCtrl","WidgetPropertiesCtrl","FormCtrl"],"mappings":";;;;;;;sZA6CwBA,gBAEbC,gBAAiBC,mBAAqBC,QAAQC,IAAI,EAErD,sBAAU,WAAYC,gBAAOC,YAC7B,yBAAe,OAAQD,gBAAOC,oBAI1BC,cAEC,4BAAgBA,eAIrBA,OAAOC,GAAGC,SAASC,QAAQL,gBAAOM,KAAMT,YAAYU,YAE9CC,cAAgB,KACAC,uBAAYC,KAAKR,QACFS,IAAI,kBACtBC,gBAInBV,OAAOC,GAAGC,SAASS,UAAUb,gBAAOC,UAAW,CAC3CK,KAAMN,gBAAOM,KACbQ,QAASlB,gBACTmB,SAAUP,gBAKdN,OAAOC,GAAGC,SAASY,YAAYhB,gBAAOC,UAAW,CAC7CK,KAAMN,gBAAOM,KACbW,KAAMrB,gBACNmB,SAAUP,yBAaDN,QAEjBA,OAAOgB,GAAG,QAAQ,WACRC,OAASV,uBAAYE,IAAI,UAKzBS,WAAa,EAEbC,OAAU,GAAEC,IAAIC,4BAA4BD,IAAIE,SAASF,IAAIG,YAAYL,iBAC/ElB,OAAOwB,IAAIC,QAAQN,cAKbO,cAAgBT,OAAOU,GAAGC,QAAU,QACpCC,SAAW7B,OAAOwB,IAAIM,OAAO,SAAU,CAACC,IAAM,kCAAiCL,yBAC/EM,KAAOhC,OAAOiC,SAASC,cAAc,QAC3CL,SAASM,OAAS,wDAGRC,sCAAYnB,OAAOU,GAAGf,wFAASyB,0EAAaC,UAAW,QACvDC,SAAWvC,OAAOwB,IAAIM,OAAO,SAC/B,CAACC,IAAM,0CAAyCK,8CACpDJ,KAAKQ,YAAYD,UAGjBA,SAASJ,OAAS,WACRM,aAAezC,OAAOwB,IAAIM,OAAO,UACvCW,aAAaC,UAAa,gaAW1BV,KAAKQ,YAAYC,mDAGFzC,SAGvBgC,KAAKQ,YAAYX,gBAEXc,UAAW,6BAAiB3C,SAAW,GACzC2C,SAASC,QACT5C,OAAOwB,IAAIqB,SAASF,aA5DxBG,CAAY9C,gBAiEP+C,QAITC,YAAYhD,aACHA,OAASA,OAElBiD,wBACW,2BAAcC,KAAKlD,OAAQ,SAEtCmD,4BACW,4BAAkBD,KAAKlD,OAAQ,cAU1CoD,oCACSC,UAAY,IACjBD,KACOxD,QAAQ0D,QAAQF,MAEpB,IAAIxD,SAAQ,CAAC0D,QAASC,UAEzBC,OAAOC,QAAQ,CAAC,4BAA6BC,YACzCN,KAAOM,UACHN,KACAE,QAAQF,MAERG,WAELA,+DAMCI,kBAAkB,SAAU1C,wCAC5B0C,kBAAkB,UAAWC,gCAC7BD,kBAAkB,WAAYE,2CAC9BF,kBAAkB,WAAYG,0CAC9BH,kBAAkB,YAAaN,kCAC/BM,kBAAkB,WAAY,CAACI,aAAAA,aAAcC,eAAAA,wCAC7CL,kBAAkB,SAAUM,eAAQ,iCACpCN,kBAAkB,cAAeO,yBAAa,8CAC9CP,kBAAkB,cAAeQ,+BAAgB,kDACjDR,kBAAkB,oBAAqBS,+BAA0B,0CAEjEC,gBAAgB,sBAAuBC,mCAAkB,+EACzDC,gBAAgB,gBAAiBC,uBAAe,iCAChDD,gBAAgB,iBAAkBE,mCAC1C,yGACQF,gBAAgB,uBAAwBG,8BAAsB,qDAC9DH,gBAAgB,WAAYI,mBAAU,4EACtCJ,gBAAgB,UAAWxB,QAAS"}