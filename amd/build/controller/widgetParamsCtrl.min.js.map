{"version":3,"file":"widgetParamsCtrl.min.js","sources":["../../src/controller/widgetParamsCtrl.js"],"sourcesContent":["/* eslint-disable max-len */\n/* eslint-disable no-eq-null */\n/* eslint-disable no-console */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny WidgetHub plugin.\n *\n * @module      tiny_widgethub/plugin\n * @copyright   2024 Josep Mulet Pol <pep.mulet@gmail.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport { applyWidgetFilter } from '../util';\n\nexport class WidgetParamsCtrl {\n   /**\n    * @type {import('./widgetPickerCtrl').WidgetPickerCtrl | undefined }\n    */\n   parentCtrl;\n   /**\n    * @param {import('../container').DIContainer} container\n    * @param {import('../util').WidgetWrapper} widget\n    */\n   constructor({ editor, userStorage, templateSrv, modalSrv, formCtrl }, widget) {\n      this.editor = editor;\n      this.storage = userStorage;\n      this.templateSrv = templateSrv;\n      this.modalSrv = modalSrv;\n      this.formCtrl = formCtrl;\n      this.widget = widget;\n   }\n   /**\n    * Displays a dialogue for configuring the parameters of the selected snpt\n    */\n   async handleAction() {\n      // Show modal with buttons.\n      const data = this.formCtrl.createParametersContext(this.widget);\n      const modal = await this.modalSrv.create('picker', data, { destroyOnHidden: true });\n      this.modal = modal;\n      modal.body.find(`a[href=\"#${data.idTabpane}_1\"`).on(\"click\", async () => {\n         // Handle preview;\n         const ctxFromDialogue = this.formCtrl.parameterExtractor(this.widget, modal.body.find(\"form\"));\n         await this.updatePreview(data.idTabpane, ctxFromDialogue);\n      });\n      this.formCtrl.attachImagePickers(modal.body);\n      modal.footer.show();\n      modal.footer.find(\"button.btn-secondary\").on(\"click\", async() => {\n         // Go back to main menú\n         modal.destroy();\n         if (this.parentCtrl) {\n            await this.parentCtrl.handleAction();\n         }\n      });\n      modal.footer.find(\"button.btn-primary\").on(\"click\", async () => {\n         // Go back to main menú\n         const ctxFromDialogue = this.formCtrl.parameterExtractor(this.widget, modal.body.find(\"form\"));\n         modal.hide();\n         await this.insertWidget(ctxFromDialogue);\n         modal.destroy();\n      });\n\n      // Change input fields visibilities upon conditions\n      const selectMode = this.editor.selection.getContent().trim() != '';\n      this.formCtrl.applyFieldWatchers(modal.body, this.widget.defaults, this.widget, selectMode);\n\n      modal.show();\n   }\n\n   destroy() {\n      if (this.modal) {\n         this.modal.destroy();\n      }\n   }\n\n   /**\n     * @param {object} ctx\n     * @returns {Promise<string>} The rendered template\n     */\n    render(ctx) {\n        const defaultsCopy = {...this.widget.defaults};\n        const toInterpolate = Object.assign(defaultsCopy, ctx || {});\n        // Decide which template engine to use\n        let engine = this.widget.prop('engine');\n        return this.templateSrv.render(this.widget.template ?? \"\", toInterpolate,\n            this.widget.I18n, engine);\n   }\n\n   /**\n    * @param {Object.<string, any>} ctxFromDialogue\n    * @returns {Promise<string>}\n    */\n   async generateInterpolatedCode(ctxFromDialogue) {\n      const sel = this.editor.selection.getContent();\n      // Decideix quin mode de selecció estam\n      console.log(\"Selection\", this.editor.selection, sel);\n      let interpoledComponentCode = await this.render(ctxFromDialogue);\n      if (sel.trim() && this.widget.insertquery) {\n         let query = this.widget.insertquery.trim();\n         let replaceMode = query.startsWith('r!');\n         if (replaceMode) {\n            query = query.substring(2).trim();\n         }\n         // We are in selection mode\n         const tmpDiv = document.createElement(\"div\");\n         tmpDiv.innerHTML = interpoledComponentCode;\n         const insertPoint = tmpDiv.querySelector(this.widget.insertquery);\n         if (insertPoint) {\n            if (replaceMode) {\n               // Replace the insertPoint by the interpolated HTML\n               insertPoint.outerHTML = sel;\n            } else {\n               // Inserts the interpolated HTML into the insertPoint\n               insertPoint.innerHTML = sel;\n            }\n            interpoledComponentCode = tmpDiv.innerHTML;\n         }\n      }\n      return interpoledComponentCode;\n   }\n\n   /**\n    * @param {number} idTabpane\n    * @param {Object.<string, any>} ctxFromDialogue\n    * @returns\n    */\n   async updatePreview(idTabpane, ctxFromDialogue) {\n      const interpoledCode = await this.generateInterpolatedCode(ctxFromDialogue);\n      const $previewPanel = this.modal.body.find(`#${idTabpane}_1`);\n      $previewPanel.html(interpoledCode);\n   }\n\n   /**\n    * @param {Object.<string, any>} ctxFromDialogue\n    * @returns\n    */\n   async insertWidget(ctxFromDialogue) {\n      const recentWidgets = this.storage.getFromSession(\"recentsnpt\", \"\").split(\",\")\n         .filter((/** @type{string}**/ e) => e.trim());\n      const pos = recentWidgets.indexOf(this.widget.key);\n      if (pos >= 0) {\n         recentWidgets.splice(pos, 1);\n      }\n      recentWidgets.unshift(this.widget.key);\n      if (recentWidgets.length > 4) {\n         recentWidgets.splice(5, recentWidgets.length - 4);\n      }\n\n      this.storage.setToSession(\"recentsnpt\", recentWidgets.join(\",\"), true);\n\n      if (this.widget.isFilter()) {\n         applyWidgetFilter(this.editor, this.widget.template || '', false, ctxFromDialogue);\n         return;\n      }\n      const interpoledCode = await this.generateInterpolatedCode(ctxFromDialogue);\n      // Normal insert mode\n      this.editor.selection.setContent(interpoledCode);\n      this.editor.focus();\n   }\n\n}\n"],"names":["parentCtrl","constructor","widget","editor","userStorage","templateSrv","modalSrv","formCtrl","storage","data","this","createParametersContext","modal","create","destroyOnHidden","body","find","idTabpane","on","async","ctxFromDialogue","parameterExtractor","updatePreview","attachImagePickers","footer","show","destroy","handleAction","hide","insertWidget","selectMode","selection","getContent","trim","applyFieldWatchers","defaults","render","ctx","defaultsCopy","toInterpolate","Object","assign","engine","prop","template","I18n","sel","console","log","interpoledComponentCode","insertquery","query","replaceMode","startsWith","substring","tmpDiv","document","createElement","innerHTML","insertPoint","querySelector","outerHTML","interpoledCode","generateInterpolatedCode","html","recentWidgets","getFromSession","split","filter","e","pos","indexOf","key","splice","unshift","length","setToSession","join","isFilter","setContent","focus"],"mappings":"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"}