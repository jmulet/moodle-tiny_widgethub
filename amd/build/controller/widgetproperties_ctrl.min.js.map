{"version":3,"file":"widgetproperties_ctrl.min.js","sources":["../../src/controller/widgetproperties_ctrl.js"],"sourcesContent":["/* eslint-disable no-console */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny WidgetHub plugin.\n *\n * @module      tiny_widgethub/plugin\n * @copyright   2024 Josep Mulet Pol <pep.mulet@gmail.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {getFormCtrl} from '../controller/form_ctrl';\nimport {getModalSrv} from '../service/modal_service';\nimport {createBinding} from '../util';\nimport jQuery from 'jquery';\n\n/**\n * @typedef {JQuery<HTMLElement>} ModalDialogue\n * @property {JQuery<HTMLElement>} header\n * @property {JQuery<HTMLElement>} body\n * @property {JQuery<HTMLElement>} footer\n * @property {() => void} destroy\n * @property {() => void} show\n */\n\n/**\n * @class\n * @classdesc Defines a generic editor dialogue based on widget definition fields\n */\nexport class WidgetPropertiesCtrl {\n    /** @type {import('../service/modal_service').ModalDialogue | null} */\n    modal = null;\n\n    /**\n     * @param {import('../plugin').TinyMCE} editor\n     * @param {import('../controller/form_ctrl').FormCtrl} formCtrl\n     * @param {import('../service/modal_service').ModalSrv} modalSrv\n     * @param {JQueryStatic} jQuery\n     **/\n    constructor(editor, formCtrl, modalSrv, jQuery) {\n        /** @type {import('../plugin').TinyMCE} */\n        this.editor = editor;\n        /** @type {import('../controller/form_ctrl').FormCtrl} */\n        this.formCtrl = formCtrl;\n        /** @type {import('../service/modal_service').ModalSrv} */\n        this.modalSrv = modalSrv;\n        /** @type {JQueryStatic} */\n        this.jQuery = jQuery;\n    }\n\n    /**\n     * Displays a modal dialog for editing the currentContext\n     * based on contextual\n     * @param {import('../contextinit').PathResult} currentContext\n     * @returns\n     */\n    async show(currentContext) {\n        if (!currentContext.widget) {\n            console.error(\"Missing widget on currentContext\");\n            return;\n        }\n        const widget = currentContext.widget;\n        const hostId = this.editor.id;\n        // The DOM element for the root of the widget\n        const elem = currentContext.elem;\n\n        if (!elem || !widget?.hasBindings()) {\n            console.error(\"Invalid widget definition \", widget);\n            return;\n        }\n\n        // Create bindings\n        /** @type {Object.<string, any>} */\n        const bindingsDOM = {};\n        // Extract param values from DOM\n        /** @type {Object.<string, any>} */\n        const paramValues = {};\n        // Parameters that contain bindings\n        const parametersWithBindings = widget.parameters.filter(param => {\n            if (param.type === 'repeatable') {\n                const fieldsWithBindings = param.fields?.some(f => f.bind !== undefined);\n                return (fieldsWithBindings && param.item_selector !== undefined) || (typeof param.bind === 'object');\n            } else {\n                return param.bind != undefined;\n            }\n        });\n        parametersWithBindings.forEach((param) => {\n            if (param.bind && param.type !== 'repeatable') {\n                // A simple control binding\n                const binding = createBinding(param.bind, elem, typeof (param.value));\n                if (binding) {\n                    const pname = param.name;\n                    bindingsDOM[pname] = binding;\n                    paramValues[pname] = binding.getValue();\n                }\n            } else if (param.type === 'repeatable') {\n                if (typeof param.item_selector === 'string') {\n                    /** @type {any[]} */\n                    const lst = [];\n                    paramValues[param.name] = lst;\n                    // Strategy 1. Searching DOM items and creating a binding per input\n                    // Find all item containers in DOM (param.bind is a query to every item element)\n                    elem.find(param.item_selector).each((_, /** @type {Node} */ itemRoot) => {\n                        const $itemRoot = this.jQuery(itemRoot);\n                        // For every field in parameter which has binding, create it\n                        /** @type {Record<string, any>} */\n                        const obj = {};\n                        param.fields?.filter(f => f.bind !== undefined).forEach((f, i) => {\n                            // @ts-ignore\n                            const binding = createBinding(f.bind, $itemRoot, typeof (f.value));\n                            if (binding) {\n                                const pname = `${param.name}[${i}].${f.name}`;\n                                bindingsDOM[pname] = binding;\n                                obj[f.name] = binding.getValue();\n                            }\n                        });\n                        lst.push(obj);\n                    });\n                } else if (typeof param.bind === 'object') {\n                    // Strategy 2. A single binding for the whole array of objects\n                    const binding = createBinding(param.bind, elem);\n                    if (binding) {\n                        const pname = param.name;\n                        bindingsDOM[pname] = binding;\n                        paramValues[pname] = binding.getValue();\n                    }\n                }\n            }\n        });\n\n        // Create parameters form controls\n        /** @type {string[]} */\n        const controls = parametersWithBindings\n            .map(param => this.formCtrl.createControlHTML(hostId, param, paramValues[param.name]));\n\n        const ctxData = {\n            name: widget.name,\n            controls: controls\n        };\n\n        // Create the modal\n        // @ts-ignore\n        this.modal = await this.modalSrv.create('context', ctxData, () => {\n            this.modal?.destroy();\n            this.modal = null;\n        });\n        // Bind actions on image and color pickers\n        this.formCtrl.attachPickers(this.modal.body);\n        // Applying watchers to the form elements\n        this.formCtrl.applyFieldWatchers(this.modal.body, paramValues, widget, false);\n\n        // Bind accept action to modal\n        this.modal.footer.find(\"button.tiny_widgethub-btn-secondary\").on(\"click\", () => {\n            this.modal?.destroy();\n        });\n        this.modal.footer.find(\"button.tiny_widgethub-btn-primary\").on(\"click\", () => {\n            const form = this.modal?.body?.find(\"form\");\n            let updatedValues = paramValues;\n            if (form) {\n                updatedValues = this.formCtrl.extractFormParameters(widget, form, true);\n            }\n            this.modal?.destroy();\n            // Update parameter values back to DOM\n            Object.keys(bindingsDOM).forEach(key => {\n                const val = updatedValues[key];\n                if (Array.isArray(val) && bindingsDOM[key] === undefined) {\n                    // Follow stategy 1 for repeatable.\n                    val.forEach((obj, i) => {\n                        if (typeof obj !== 'object') {\n                            return;\n                        }\n                        Object.keys(obj).forEach(objKey => {\n                            const realKey = `${key}[${i}].${objKey}`;\n                            bindingsDOM[realKey].setValue(obj[objKey]);\n                        });\n                    });\n                } else {\n                    // Regular binding or strategy 2 for repeatable.\n                    bindingsDOM[key].setValue(val);\n                }\n            });\n        });\n\n        // Help circles require popover\n        try {\n            // @ts-ignore\n            this.modal.body.popover({\n            container: \"body\",\n            selector: \"[data-toggle=popover][data-trigger=hover]\",\n            trigger: \"hover\"\n            });\n        } catch (ex) {\n            console.error(ex);\n        }\n\n        this.modal.show();\n    }\n\n    close() {\n        this.modal?.destroy();\n    }\n}\n\nconst widgetPropertiesCtrlInstances = new Map();\n/**\n * @param {import('../plugin').TinyMCE} editor\n * @returns {WidgetPropertiesCtrl}\n */\nexport function getWidgetPropertiesCtrl(editor) {\n    let instance = widgetPropertiesCtrlInstances.get(editor);\n    if (!instance) {\n        instance = new WidgetPropertiesCtrl(editor, getFormCtrl(editor), getModalSrv(), jQuery);\n        widgetPropertiesCtrlInstances.set(editor, instance);\n    }\n    return instance;\n}\n"],"names":["editor","instance","widgetPropertiesCtrlInstances","get","WidgetPropertiesCtrl","jQuery","set","modal","constructor","formCtrl","modalSrv","currentContext","widget","console","error","hostId","this","id","elem","hasBindings","bindingsDOM","paramValues","parametersWithBindings","parameters","filter","param","type","fields","_param$fields","some","f","undefined","bind","item_selector","forEach","binding","value","pname","name","getValue","lst","find","each","_","itemRoot","$itemRoot","obj","i","push","controls","map","createControlHTML","ctxData","create","destroy","attachPickers","body","applyFieldWatchers","footer","on","form","_this$modal3","_this$modal3$body","updatedValues","extractFormParameters","Object","keys","key","val","Array","isArray","objKey","setValue","popover","container","selector","trigger","ex","show","close","Map"],"mappings":"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"}