{"version":3,"file":"formCtrl.min.js","sources":["../../src/controller/formCtrl.js"],"sourcesContent":["/* eslint-disable max-len */\n/* eslint-disable no-console */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny WidgetHub plugin.\n *\n * @module      tiny_widgethub/plugin\n * @copyright   2024 Josep Mulet Pol <pep.mulet@gmail.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport {getFileSrv} from '../service/fileSrv';\nimport {getTemplateSrv} from '../service/templateSrv';\nimport {getUserStorage} from '../service/userStorageSrv';\nimport {capitalize, cleanParameterName, evalInContext, genID, stream, toHexAlphaColor, toRgba} from '../util';\nimport jquery from \"jquery\";\n\nconst questionPopover = '{{#tooltip}}<a href=\"javascript:void(0)\" data-toggle=\"popover\" data-trigger=\"hover\" data-content=\"{{tooltip}}\"><i class=\"fa fas fa-question-circle text-info\"></i></a>{{/tooltip}}';\n\nexport const Templates = {\n   TEXTFIELDTEMPLATE: `<div id=\"{{elementid}}\" class=\"form-group row{{#hidden}} tiny_widgethub-hidden{{/hidden}}\"><label class=\"col-sm-5 col-form-label\" for=\"{{elementid}}_ftmpl\" title=\"{{varname}}\">{{vartitle}} ${questionPopover}</label>\n   <div class=\"col-sm-7\"><input type=\"text\" id=\"{{elementid}}_ftmpl\" class=\"form-control\" data-bar=\"{{varname}}\" {{#disabled}}disabled{{/disabled}} value=\"{{defaultvalue}}\"/></div>\n   </div>`,\n\n   IMAGETEMPLATE: `<div id=\"{{elementid}}\" class=\"form-group row{{#hidden}} tiny_widgethub-hidden{{/hidden}}\"><label class=\"col-sm-5 col-form-label\" for=\"{{elementid}}_ftmpl\" title=\"{{varname}}\">{{vartitle}} ${questionPopover}</label>\n   <div class=\"col-sm-7\">\n   <input type=\"text\" id=\"{{elementid}}_ftmpl\" class=\"form-control d-inline-block w-75\" data-bar=\"{{varname}}\" {{#disabled}}disabled{{/disabled}} value=\"{{defaultvalue}}\"/>\n   <button class=\"whb-image-picker btn btn-sm btn-secondary d-inline-block\" title=\"Search\"><i class=\"fas fa fa-search\"></i></button>\n   </div>\n   </div>`,\n\n   NUMERICTEMPLATE: `<div id=\"{{elementid}}\" class=\"form-group row{{#hidden}} tiny_widgethub-hidden{{/hidden}}\"><label class=\"col-sm-5 col-form-label\"  for=\"{{elementid}}_fntmpl\" title=\"{{varname}}\">{{vartitle}} ${questionPopover}</label>\n   <div class=\"col-sm-7\"><input type=\"number\" id=\"{{elementid}}_fntmpl\" class=\"form-control\" data-bar=\"{{varname}}\" {{{minMax}}} {{#disabled}}disabled{{/disabled}} value=\"{{defaultvalue}}\"/></div>\n   </div>`,\n\n   COLORTEMPLATE: `<div id=\"{{elementid}}\" class=\"form-group row{{#hidden}} tiny_widgethub-hidden{{/hidden}}\"><label class=\"col-sm-5 col-form-label\"  for=\"{{elementid}}_fntmpl\" title=\"{{varname}}\">{{vartitle}} ${questionPopover}</label>\n   <div class=\"col-sm-7\">\n   <span class=\"w-50 tiny_widgethub-pattern\">\n      <input type=\"color\" id=\"{{elementid}}_fctmpl\" data-bar=\"{{varname}}\" {{#disabled}}disabled{{/disabled}} value=\"{{defaultvalue}}\"/>\n   </span>\n   <input type=\"range\" id=\"{{elementid}}_fcatmpl\" title=\"Opacity\" data-bar=\"{{varname}}_alpha\" {{#disabled}}disabled{{/disabled}} value=\"{{defaultvalueAlpha}}\" min=\"0\" max=\"1\" step=\"0.01\"/>\n   </div></div>`,\n\n   TEXTAREATEMPLATE: `<div id=\"{{elementid}}\" class=\"form-group{{#hidden}} tiny_widgethub-hidden{{/hidden}}\"><label for=\"{{elementid}}_tatmpl\" title=\"{{varname}}\">{{vartitle}} ${questionPopover}</label>\n   <textarea id=\"{{elementid}}_tatmpl\" rows=\"3\" class=\"form-control\" data-bar=\"{{varname}}\" {{#disabled}}disabled{{/disabled}} {{#tooltip}}title=\"{{tooltip}}\"{{/tooltip}}>{{defaultvalue}}</textarea>\n   </div>`,\n\n   CHECKBOXTEMPLATE: `<div id=\"{{elementid}}\" class=\"d-table w-75 m-2{{#hidden}} tiny_widgethub-hidden{{/hidden}}\">\n   <label>\n   <input title=\"{{varname}}\" id=\"{{elementid}}_cbtmpl\" {{#disabled}}disabled{{/disabled}} type=\"checkbox\" data-bar=\"{{varname}}\" value=\"{{defaultvalue}}\" {{#defaultvalue}}checked{{/defaultvalue}}/></span>\n   {{vartitle}}</label> <span>&nbsp;&nbsp;  ${questionPopover}</span>\n   </div>`,\n\n   SELECTTEMPLATE: `<div id=\"{{elementid}}\" class=\"form-group row{{#hidden}} tiny_widgethub-hidden{{/hidden}}\">\n   <label class=\"col-sm-5 col-form-label\" for=\"{{elementid}}_stmpl\" title=\"{{varname}}\">{{vartitle}} ${questionPopover}</label>\n   <div class=\"col-sm-7\">\n   <select id=\"{{elementid}}_stmpl\" class=\"form-control\" data-bar=\"{{varname}}\" {{#if disabled}}disabled{{/if}} {{#if tooltip}}title=\"{{tooltip}}\"{{/if}}>\n   {{#options}}\n   <option value=\"{{optionValue}}\"{{#selected}} selected{{/selected}}>{{optionLabel}}</option>\n   {{/options}}\n   </select>\n   </div>\n   </div>`\n};\n\n\nexport class FormCtrl {\n  /**\n   * @param {import('../plugin').TinyMCE} editor\n   * @param {import('../service/userStorageSrv').UserStorageSrv} userStorage\n   * @param {import('../service/templateSrv').TemplateSrv} templateSrv\n   * @param {import('../service/fileSrv').FileSrv} fileSrv\n   * @param {JQueryStatic} jQuery\n   */\n   constructor(editor, userStorage, templateSrv, fileSrv, jQuery) {\n      /** @type {import('../plugin').TinyMCE} */\n      this.editor = editor;\n      /** @type {import('../service/userStorageSrv').UserStorageSrv} */\n      this.storage = userStorage;\n      /** @type {import('../service/templateSrv').TemplateSrv} */\n      this.templateSrv = templateSrv;\n      /** @type {import('../service/fileSrv').FileSrv} */\n      this.fileSrv = fileSrv;\n      /** @type {JQueryStatic} */\n      this.jQuery = jQuery;\n   }\n\n   /**\n    * @param {import('../options').Widget} widget\n    * @returns {*} - The generated context\n    */\n   createContext(widget) {\n      /** @type {boolean} */\n      const mustSaveAll = this.storage.getFromLocal('saveall', false);\n      /** @type {Object.<string, any>} */\n      const saveAllData = this.storage.getFromLocal('saveall_data', {});\n      /** @type {Object.<string, any>} */\n      const values = this.storage.getFromLocal(\"values\", {});\n      const defaults = widget.defaults;\n\n      /**\n       * @param {import('../options').Param} param\n       * @returns {any}\n       */\n      const obtainCurrentValue = (param) => {\n         const sname = widget.name;\n         const pname = param.name;\n         let currentval = defaults[pname];\n         if (mustSaveAll) {\n            // Search the last used value of this parameter\n            if ((saveAllData[sname]?.[pname] ?? null) !== null) {\n               currentval = saveAllData[sname][pname];\n            }\n         }\n         if (pname.startsWith(\"$\") && values[pname]) {\n            currentval = values[pname];\n         }\n         return currentval;\n      };\n\n      const controls = widget.parameters.map(param => this.createControlHTML(this.editor.id, param, obtainCurrentValue(param)));\n\n      const ctx = {\n         idTabpane: genID(),\n         selectMode: this.editor.selection.getContent().trim().length > 0,\n         name: widget.name,\n         instructions: widget.instructions,\n         filter: widget.isFilter(),\n         controls: controls\n      };\n      return ctx;\n   }\n\n   /**\n    * @param {string} hostId - The id of the editor\n    * @param {import('../options').Param} param - The parameter object defining the control\n    * @param {any} defaultValue - Default values for the parameter\n    * @returns {string} - The generated HTML for this control\n    */\n   createControlHTML(hostId, param, defaultValue) {\n      let markup = '';\n      const pname = cleanParameterName(param.name);\n      const generalCtx = {\n         elementid: hostId + \"_\" + pname,\n         varname: pname,\n         vartitle: param.title,\n         defaultvalue: defaultValue,\n         tooltip: param.tip || param.tooltip,\n         disabled: param.editable === false,\n         hidden: param.hidden === true\n      };\n      if (param.type === 'textarea') {\n         markup = this.templateSrv.renderMustache(Templates.TEXTAREATEMPLATE, generalCtx);\n      } else if (param.type === 'numeric') {\n         let minMax = \"\";\n         if (param.min) {\n            minMax += `min=\"${param.min}\"`;\n         }\n         if (param.max) {\n            minMax += ` max=\"${param.max}\"`;\n         }\n         markup = this.templateSrv.renderMustache(Templates.NUMERICTEMPLATE, {minMax: minMax, ...generalCtx});\n      } else if (param.type === 'checkbox') {\n         markup = this.templateSrv.renderMustache(Templates.CHECKBOXTEMPLATE, generalCtx);\n      } else if (param.type === 'select') {\n         const options = (param.options ?? []).map(opt => {\n            let label;\n            let value;\n            if (typeof opt === 'string') {\n               label = capitalize(opt);\n               value = opt;\n            } else {\n               label = opt.l;\n               value = opt.v;\n            }\n            return {optionLabel: label, optionValue: value, selected: value === defaultValue};\n         });\n         markup = this.templateSrv.renderMustache(Templates.SELECTTEMPLATE, {options, ...generalCtx});\n      } else if (param.type === 'color') {\n         // Value must be in hex form and must find alpha (0-1)\n         const [hex, alpha] = toHexAlphaColor(generalCtx.defaultvalue);\n         generalCtx.defaultvalue = hex;\n         /** @ts-ignore */\n         generalCtx.defaultvalueAlpha = alpha;\n         markup = this.templateSrv.renderMustache(Templates.COLORTEMPLATE, generalCtx);\n      } else if (param.type === 'image') {\n         markup = this.templateSrv.renderMustache(Templates.IMAGETEMPLATE, generalCtx);\n      } else {\n         // Assume textfield\n         markup = this.templateSrv.renderMustache(Templates.TEXTFIELDTEMPLATE, generalCtx);\n      }\n      return markup;\n   }\n\n\n   /**\n    * Obtains the updated parameter values from the modal\n    * This is used in insertWidget\n    * @param {import('../options').Widget} widget\n    * @param {JQuery<HTMLElement>} form\n    * @returns {Record<string, any>} - The updated parameters dict\n    */\n   extractFormParameters(widget, form) {\n      /** @type {Object.<string, any>}  */\n      const ctx = {};\n      /** @type {Object.<string, any>}  */\n      const toPersist = {};\n      const defaults = widget.defaults;\n      widget.parameters.forEach(param => {\n         const pname = param.name;\n         const cleanPname = cleanParameterName(pname);\n         const $elem = form.find(`[data-bar=\"${cleanPname}\"]`);\n         if (!$elem.length) {\n            ctx[pname] = defaults[pname];\n            return;\n         }\n         /** @type {*} */\n         let value = $elem.val() ?? \"\";\n         if ($elem.prop(\"tagName\") === \"INPUT\" && $elem.attr(\"type\") === \"checkbox\") {\n            value = $elem.is(':checked');\n         } else if ($elem.prop(\"tagName\") === \"INPUT\" && $elem.attr(\"type\") === \"number\") {\n            if (value.indexOf(\".\") >= 0) {\n               value = parseFloat(value);\n            } else {\n               value = parseInt(value);\n            }\n         } else if ($elem.prop(\"tagName\") === \"INPUT\" && $elem.attr(\"type\") === \"color\") {\n            // Must also find the corresponding alpha channel value\n            const $slider = form.find(`[data-bar=\"${cleanPname}_alpha\"]`);\n            const alpha = $slider.val() ?? 1;\n            value = toRgba(value, +alpha);\n         }\n\n         if (param.transform) {\n            value = stream(param.transform).reduce(value);\n         }\n         ctx[pname] = value;\n         if (pname.trim().startsWith(\"$\")) {\n            toPersist[pname] = value;\n         }\n      });\n      if (this.storage) {\n         if (Object.keys(toPersist).length) {\n            // Only those starting with $\n            this.storage.setToLocal('valors', toPersist, true);\n         }\n         // Should all values be persisted?\n         const mustSaveAll = this.storage.getFromLocal('saveall', false);\n         if (mustSaveAll) {\n            /** @type {Object.<string, any>}  */\n            const previousAllData = this.storage.getFromLocal('saveall_data', {});\n            previousAllData[widget.name] = {...ctx};\n            this.storage.setToLocal('saveall_data', previousAllData, true);\n         }\n      }\n      return ctx;\n   }\n\n   /**\n    * @param {JQuery<HTMLElement>} body - The modal body\n    */\n   attachPickers(body) {\n      // Find all file pickers\n      const canShowFilePicker = typeof this.fileSrv.getImagePicker() !== 'undefined';\n      const picker = body.find('button.whb-image-picker').prop('disabled', !canShowFilePicker);\n      if (canShowFilePicker) {\n         // Attach a click handler to any image-picker buttons\n         picker.on(\"click\", /** @param {any} evt */ async(evt) => {\n            evt.preventDefault();\n            try {\n               /** @type {any} */\n               const params = await this.fileSrv.displayImagePicker();\n               if (params?.url) {\n                  this.jQuery(evt.currentTarget).parent().find('input').val(params.url);\n               }\n            } catch (ex) {\n               console.error(ex);\n            }\n         });\n      }\n\n      // Find all color pickers\n      body.find('input[type=\"color\"]').each((_, e) => {\n         const $inputColor = this.jQuery(e);\n         const bar = ($inputColor.attr('data-bar') ?? '');\n         // Find corresponding range slider\n         const $inputRange = body.find(`input[data-bar=\"${bar}_alpha\"]`);\n         const opacity = $inputRange.val() ?? 1;\n         $inputColor.css('opacity', '' + opacity);\n         // Bind envent change\n         $inputRange.on('change', () => {\n            const opacity = $inputRange.val() ?? 1;\n            $inputColor.css('opacity', '' + opacity);\n         });\n      });\n   }\n\n   /**\n    * @param {JQuery<HTMLElement>} $formElem\n    * @param {Object.<string, any>} defaultsData\n    * @param {import('../options').Widget} widget\n    * @param {boolean} selectMode\n    */\n   applyFieldWatchers($formElem, defaultsData, widget, selectMode) {\n      /** @type {string[]} */\n      const watchedvars = []; // All these variable names must be watched\n      /**\n       * all these components must be updated when one watcher changes\n       *  @type {{\n       *    condition: string,\n       *    component: JQuery<HTMLElement>,\n       *    type: string,\n       *    indx: number\n       *  }[]}\n       */\n      const updatableComponents = [];\n\n      const regex = /\\{{2}([^}]*)\\}{2}/gm;\n      for (let indx = 0, len = widget.parameters.length; indx < len; indx++) {\n\n         const varobj = widget.parameters[indx];\n\n         if (varobj.when) {\n            const condition = varobj.when;\n            const t = varobj.type;\n            const control = $formElem.find(`[data-bar=\"${cleanParameterName(varobj.name)}\"]`);\n            if (!control.length || !t) {\n               continue;\n            }\n            updatableComponents.push({\n               condition: condition.replace(/[{}]{2}/g, ''),\n               component: control,\n               indx: indx,\n               type: t\n            });\n            const varsInvolved = condition.match(regex);\n            varsInvolved?.forEach(evar => {\n               evar = evar.replace(/[{}]*/g, '').trim();\n               // Can only watch real variables SELECT_MODE is not a variable\n               console.log(\"evar\", evar, defaultsData);\n               if (watchedvars.indexOf(evar) < 0 && (defaultsData[evar] ?? null) !== null) {\n                  console.log(\"ADDED AS WATCH\");\n                  watchedvars.push(evar);\n               }\n            });\n         }\n         watchedvars.push(varobj.name);\n      }\n\n      console.log(watchedvars);\n      console.log(updatableComponents);\n\n\n      const doUpdateVisibilities = () => {\n         updatableComponents.forEach(cc => {\n            // Evaluate condition\n            console.log(\"Amagant \", cc);\n            const condicio = cc.condition;\n            const novesVariables = this.extractFormParameters(widget, $formElem);\n            console.log(\"Obtained the new variables from the form \", novesVariables);\n            // Add to the new variables the internal variables\n            novesVariables.SELECT_MODE = selectMode;\n            // Eval JS condition for new variables\n            const showme = evalInContext(novesVariables, condicio);\n            let theComponent = cc.component;\n            if (theComponent) {\n               theComponent = theComponent.parent();\n               if (cc.type === 'checkbox') {\n                  theComponent = theComponent.parent();\n               }\n               // Only change visibilities of nodes not hidden from user\n               console.log(\"Changing visibilities of \", theComponent, \" condition \", condicio, \" evals to \", showme);\n               if (!theComponent.attr('data-amagat')) {\n                  if (showme) {\n                     theComponent.show();\n                  } else {\n                     theComponent.hide();\n                  }\n               }\n            }\n         });\n      };\n\n      // Apply the watchers\n      widget.parameters.forEach((varobj) => {\n         const control = $formElem.find(`[data-bar=\"${cleanParameterName(varobj.name)}\"]`);\n         if (watchedvars.indexOf(varobj.name) < 0 || !control) {\n            return;\n         }\n         console.log(\"that must be watched\", varobj);\n         let evtName = \"change\";\n         if (varobj.type === 'textfield' || varobj.type === 'textarea') {\n            evtName = \"keyup\";\n         }\n         control.on(evtName, () => {\n            doUpdateVisibilities();\n         });\n      });\n\n      // Decide which form elements are visible accoding to the current values of the parameters.\n      doUpdateVisibilities();\n   }\n}\n\n\nconst formCtrlInstances = new Map();\n/**\n * @param {import('../plugin').TinyMCE} editor\n * @returns {FormCtrl}\n */\nexport function getFormCtrl(editor) {\n    let instance = formCtrlInstances.get(editor);\n    if (!instance) {\n        // @ts-ignore\n        instance = new FormCtrl(editor, getUserStorage(editor), getTemplateSrv(), getFileSrv(editor), jquery);\n        formCtrlInstances.set(editor, instance);\n    }\n    return instance;\n}\n"],"names":["editor","instance","formCtrlInstances","get","FormCtrl","jquery","set","questionPopover","Templates","TEXTFIELDTEMPLATE","IMAGETEMPLATE","NUMERICTEMPLATE","COLORTEMPLATE","TEXTAREATEMPLATE","CHECKBOXTEMPLATE","SELECTTEMPLATE","constructor","userStorage","templateSrv","fileSrv","jQuery","storage","createContext","widget","mustSaveAll","this","getFromLocal","saveAllData","values","defaults","controls","parameters","map","param","createControlHTML","id","sname","name","pname","currentval","startsWith","obtainCurrentValue","idTabpane","selectMode","selection","getContent","trim","length","instructions","filter","isFilter","hostId","defaultValue","markup","generalCtx","elementid","varname","vartitle","title","defaultvalue","tooltip","tip","disabled","editable","hidden","type","renderMustache","minMax","min","max","options","opt","label","value","l","v","optionLabel","optionValue","selected","hex","alpha","defaultvalueAlpha","extractFormParameters","form","ctx","toPersist","forEach","cleanPname","$elem","find","val","prop","attr","is","indexOf","parseFloat","parseInt","transform","reduce","Object","keys","setToLocal","previousAllData","attachPickers","body","canShowFilePicker","getImagePicker","picker","on","async","evt","preventDefault","params","displayImagePicker","url","currentTarget","parent","ex","console","error","each","_","e","$inputColor","bar","$inputRange","opacity","css","applyFieldWatchers","$formElem","defaultsData","watchedvars","updatableComponents","regex","indx","len","varobj","when","condition","t","control","push","replace","component","varsInvolved","match","evar","log","doUpdateVisibilities","cc","condicio","novesVariables","SELECT_MODE","showme","theComponent","show","hide","evtName","Map"],"mappings":"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"}