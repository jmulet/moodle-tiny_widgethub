{"version":3,"file":"widgetpicker_ctrl.min.js","sources":["../../src/controller/widgetpicker_ctrl.js"],"sourcesContent":["/* eslint-disable complexity */\n/* eslint-disable max-len */\n/* eslint-disable no-eq-null */\n/* eslint-disable no-console */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny WidgetHub plugin.\n *\n * @module      tiny_widgethub/plugin\n * @copyright   2024 Josep Mulet Pol <pep.mulet@gmail.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n// eslint-disable-next-line camelcase\nimport {get_string} from 'core/str';\nimport {getWidgetParamsFactory} from '../controller/widgetparams_ctrl';\nimport {getEditorOptions, getGlobalConfig} from '../options';\nimport {getModalSrv} from '../service/modal_service';\nimport {getTemplateSrv} from '../service/template_service';\nimport {getUserStorage} from '../service/userstorage_service';\nimport {debounce, genID, hashCode, removeRndFromCtx, searchComp, toggleClass} from '../util';\n\n/**\n * @param {HTMLElement} el\n * @param {boolean} visible\n */\nexport const setVisibility = function(el, visible) {\n    if (!el) {\n        return;\n    }\n    if (visible) {\n        el.classList.remove(\"d-none\");\n    } else {\n        el.classList.add(\"d-none\");\n    }\n};\n\nexport class WidgetPickerCtrl {\n    /** @type {import('../service/modal_service').ModalDialogue} */\n    // @ts-ignore\n    modal;\n\n    /**\n     * @param {import('../plugin').TinyMCE} editor\n     * @param {import('../options').EditorOptions} editorOptions\n     * @param {(widget: import('../options').Widget) => import('../controller/widgetparams_ctrl').WidgetParamsCtrl} widgetParamsFactory\n     * @param {import('../service/modal_service').ModalSrv} modalSrv\n     * @param {import('../service/template_service').TemplateSrv} templateSrv\n     * @param {import('../service/userstorage_service').UserStorageSrv} userStorage\n     */\n    constructor(editor, editorOptions, widgetParamsFactory, modalSrv, templateSrv, userStorage) {\n        /** @type {import('../plugin').TinyMCE} */\n        this.editor = editor;\n        /** @type {import('../options').EditorOptions} */\n        this.editorOptions = editorOptions;\n        /** @type {(widget: import('../options').Widget) => import('../controller/widgetparams_ctrl').WidgetParamsCtrl} */\n        this.widgetParamsFactory = widgetParamsFactory;\n        /** @type {import('../service/modal_service').ModalSrv} */\n        this.modalSrv = modalSrv;\n        /** @type {import('../service/template_service').TemplateSrv} */\n        this.templateSrv = templateSrv;\n        /** @type {import('../service/userstorage_service').UserStorageSrv} */\n        this.storage = userStorage;\n        /** @type {number} */\n        this.scrollPos = 0;\n    }\n\n    isSelectMode() {\n        return this.editor.selection.getContent().trim().length > 0;\n    }\n\n    /**\n     * Shows or hides buttons according to the search text condition\n     * When text == '', all non-hidden buttons should be displayed\n     * @param {JQuery<HTMLElement>} bodyForm\n     * @param {string} searchtext\n     * @returns {number}\n     */\n    setWidgetButtonsVisibility(bodyForm, searchtext) {\n        let numshown = 0;\n        const selectmode = this.isSelectMode();\n        /** @type {JQuery<HTMLDivElement>} */\n        const allbtns = bodyForm.find(\".tiny_widgethub-btn-group\");\n        allbtns.each((i, el) => {\n            // Is supported in select mode?\n            let visible = !selectmode || (selectmode && el.dataset.selectable === \"true\");\n            const el2 = el.querySelector('button');\n            // Does fullfill the search criteria?\n            visible = visible && (el2 !== null) && (searchtext.trim() === '' || searchComp(el2.textContent ?? '', searchtext) ||\n                searchComp(el2.dataset.title ?? '', searchtext));\n            setVisibility(el, visible);\n            if (visible) {\n                numshown++;\n            }\n        });\n        return numshown;\n    }\n\n    /**\n     * Callback on keyup event\n     */\n    onSearchKeyup() {\n        const searchtext = this.modal.body.find(\"input\").val() ?? '';\n        this.storage.setToSession('searchtext', searchtext, true);\n\n        // Are we in selectmode, does the widget support it? insertquery\n        const numshown = this.setWidgetButtonsVisibility(this.modal.body, searchtext);\n        // If no button visible, show emptyList message\n        setVisibility(this.modal.body.find(\".tiny_widgethub-emptylist\")[0], numshown == 0);\n\n        // Hide categories without any button visible\n        /** @type {JQuery<HTMLElement>} */\n        const allcatgs = this.modal.body.find(\".tiny_widgethub-category\");\n        allcatgs.each((_, el) => {\n            const count = el.querySelectorAll(\".tiny_widgethub-btn-group:not(.d-none)\").length;\n            setVisibility(el, count > 0);\n        });\n    }\n\n    /**\n     * @param {*} evt\n     */\n    async onMouseEnterButton(evt) {\n        const widgetTable = this.editorOptions.widgetDict;\n        const key = evt.target?.closest('.tiny_widgethub-btn-group')?.dataset?.key ?? '';\n        const widget = widgetTable[key];\n        if (!widget || widget.isFilter()) {\n            // Filters do not offer preview\n            return;\n        }\n        /** @type {string | undefined} */\n        let html = widget._preview;\n        if (!html) {\n            // Generate preview with default parameters\n            html = await this.generatePreview(widget);\n            widget._preview = html;\n        }\n        this.modal.body.find(\"div.tiny_widgethub-preview\")\n            .html(html)\n            .css(\"display\", \"block\");\n    }\n\n    async createModal() {\n        /** @type {string} */\n        const searchtext = this.storage.getFromSession(\"searchtext\", \"\");\n        const miscStr = await get_string('misc', 'tiny_widgethub');\n        const data = {\n            ...this.getPickTemplateContext({misc: miscStr}),\n            searchtext\n        };\n\n        this.modal = await this.modalSrv.create('picker', data);\n\n        // Add select mode identifier to the header\n        const blinkElem = document.createElement(\"SPAN\");\n        blinkElem.classList.add(\"tiny_widgethub-blink\", \"d-none\");\n        const selectModeStr = await get_string('selectmode', 'tiny_widgethub');\n        blinkElem.innerHTML = `<span class=\"twh-icon\">\n        <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 576 512\"><path d=\"M48 115.8C38.2 107 32 94.2 32 80c0-26.5 21.5-48 48-48c14.2 0 27 6.2 35.8 16l344.4 0c8.8-9.8 21.6-16 35.8-16c26.5 0 48 21.5 48 48c0 14.2-6.2 27-16 35.8l0 280.4c9.8 8.8 16 21.6 16 35.8c0 26.5-21.5 48-48 48c-14.2 0-27-6.2-35.8-16l-344.4 0c-8.8 9.8-21.6 16-35.8 16c-26.5 0-48-21.5-48-48c0-14.2 6.2-27 16-35.8l0-280.4zM125.3 96c-4.8 13.6-15.6 24.4-29.3 29.3l0 261.5c13.6 4.8 24.4 15.6 29.3 29.3l325.5 0c4.8-13.6 15.6-24.4 29.3-29.3l0-261.5c-13.6-4.8-24.4-15.6-29.3-29.3L125.3 96zm2.7 64c0-17.7 14.3-32 32-32l128 0c17.7 0 32 14.3 32 32l0 96c0 17.7-14.3 32-32 32l-128 0c-17.7 0-32-14.3-32-32l0-96zM256 320l32 0c35.3 0 64-28.7 64-64l0-32 64 0c17.7 0 32 14.3 32 32l0 96c0 17.7-14.3 32-32 32l-128 0c-17.7 0-32-14.3-32-32l0-32z\"/></svg>\n        </span> ${selectModeStr}`;\n        this.modal.header[0]?.append(blinkElem);\n\n        try {\n            this.modal.body.find(\".tiny_widgethub-categorycontainer\")\n                // @ts-ignore\n                .scrollspy('refresh');\n        } catch (ex) {\n            console.error(\"Problem setting scrollspy\", ex);\n        }\n\n        // Confiure preview panel events\n        /**\n         * @type {any}\n         */\n        let timerEnter = null;\n        /**\n         * @type {any}\n         */\n        let timerOut = null;\n\n        // Event listeners.\n        // Click on clear text\n        const widgetSearchElem = this.modal.body.find(\"input\");\n        widgetSearchElem.val(searchtext);\n        const debouncedKeyup = debounce(this.onSearchKeyup.bind(this), 800);\n        widgetSearchElem.on('keyup', debouncedKeyup);\n\n        this.modal.body.find(`#widget-clearfilter-btn${data.rid}`).on('click', () => {\n            debouncedKeyup.clear();\n            widgetSearchElem.val(\"\");\n            widgetSearchElem.trigger(\"focus\");\n            this.onSearchKeyup();\n        });\n        // Click on any widget button (bubbles)\n        this.modal.body.find('div.tiny_widgethub-categorycontainer, div.tiny_widgethub-recent').on('click',\n            /** @param {JQuery.ClickEvent} event */\n            (event) => {\n                if (timerEnter) {\n                    clearTimeout(timerEnter);\n                    timerEnter = null;\n                }\n                this.modal.body.find(\"div.tiny_widgethub-preview\")\n                    .css(\"display\", \"none\");\n                this.handlePickModalClick(event);\n            });\n\n\n        const funEnter = (/** @type {any} */ evt) => {\n            clearTimeout(timerOut);\n            timerOut = null;\n            timerEnter = setTimeout(() => {\n                this.onMouseEnterButton(evt);\n            }, 500);\n        };\n\n        const funOut = (/** @type {any} */ evt) => {\n            const movedFrom = evt.target;\n            const movedTo = evt.relatedTarget;\n            if (movedFrom.classList.contains(\"tiny_widgethub-btn\") && movedTo.classList.contains(\"tiny_widgethub-btn\")) {\n                const key1 = movedFrom?.parentElement?.dataset?.key;\n                const key2 = movedTo?.parentElement?.dataset?.key;\n                if (key1 != null && key1 == key2) {\n                    // Still on the same row\n                    return;\n                }\n            }\n            clearTimeout(timerEnter);\n            timerEnter = null;\n            timerOut = setTimeout(() => {\n                this.modal.body.find(\"div.tiny_widgethub-preview\")\n                .html('')\n                .css(\"display\", \"none\");\n            }, 500);\n        };\n\n        // Preview panel\n        this.modal.body.find(\".tiny_widgethub-btn-group > button\")\n            .on(\"mouseenter\", funEnter)\n            .on(\"mouseout\", funOut);\n\n        // Store current scroll\n        const scrollPane = this.modal.body.find('.tiny_widgethub-categorycontainer');\n        scrollPane.on('scroll', debounce(() => {\n            this.scrollPos = Math.round(scrollPane.scrollTop() ?? 0);\n        }, 100));\n    }\n\n\n    async handleAction() {\n        this.storage.loadStore();\n        const selectmode = this.isSelectMode();\n        const recentlyUsedBehavior = getGlobalConfig(this.editor, 'insert.recentlyused.behavior', 'lastused');\n        if (!this.modal) {\n            // Create the modal if not exists.\n            await this.createModal();\n        } else if (recentlyUsedBehavior !== 'none') {\n            // Update list of recent\n            const widgetDict = this.editorOptions.widgetDict;\n            const html = this.storage.getRecentUsed()\n                .filter(r => {\n                    const widget = widgetDict[r.key];\n                    if (widget === undefined) {\n                        return false;\n                    }\n                    return !selectmode || (selectmode && widget.isSelectCapable());\n                })\n                .map(r =>\n                    `<a href=\"javascript:void(0)\" data-key=\"${r.key}\" data-insert=\"recent\">\n                    <span class=\"badge badge-secondary text-truncate d-inline-block\" style=\"max-width: 120px;\" title=\"${widgetDict[r.key].name}\">\n                    ${widgetDict[r.key].name}</span></a>`)\n                .join('\\n');\n            this.modal.body.find('.tiny_widgethub-recent').html(html);\n        }\n        // Call filter function to make sure the list is updated.\n        this.onSearchKeyup();\n\n        if (selectmode) {\n            this.modal.header.find(\"span.tiny_widgethub-blink\").removeClass(\"d-none\");\n        } else {\n            this.modal.header.find(\"span.tiny_widgethub-blink\").addClass(\"d-none\");\n        }\n\n        this.modal.show();\n\n        setTimeout(() => {\n            if (!this.modal?.body) {\n                return;\n            }\n            if (this.scrollPos > 0) {\n                this.modal.body.find('.tiny_widgethub-categorycontainer').scrollTop(this.scrollPos);\n            }\n            this.modal.body.find(\"input\").trigger('focus');\n        }, 200);\n    }\n\n\n    show() {\n        this.modal?.show();\n    }\n\n    /**\n     * @param {import('../options').Widget} widget\n     * @returns {Promise<string>}\n     */\n    generatePreview(widget) {\n        const toInterpolate = {...widget.defaultsWithRepeatable(true)};\n        // Decide which template engine to use\n        const engine = widget.prop('engine');\n        return this.templateSrv.render(widget.template ?? \"\", toInterpolate, widget.I18n, engine);\n    }\n\n    /**\n     * @typedef {Object} Button\n     * @property {boolean} hidden\n     * @property {string} category\n     * @property {number} widgetindex\n     * @property {string} widgetkey\n     * @property {string} widgetname\n     * @property {string} widgetorder\n     * @property {string} widgettitle\n     * @property {string} iconname\n     * @property {boolean} disabled\n     * @property {boolean} selectable\n     * @property {boolean} isfilter\n     * @property {boolean} filterset\n     * @property {string} maincolclass\n     */\n    /**\n     * @typedef {Object} Category\n     * @property {string} name\n     * @property {string} order\n     * @property {boolean} hidden\n     * @property {string} color\n     * @property {Button[]} buttons\n     */\n    /**\n     *  @typedef {{rid: string, selectmode: boolean, elementid: string, categories: Category[], recent: *[], showquickbuttons: boolean}} TemplateContext\n     */\n    /**\n     * Get the template context for the dialogue.\n     * @param {Record<string, string>} translations\n     * @returns {TemplateContext} data\n     */\n    getPickTemplateContext(translations) {\n        /** @type {Record<string, string>} */\n        const categoryOrderMap = {};\n        getGlobalConfig(this.editor, 'category.order', '')\n            .split(',')\n            .forEach(item => {\n                const itemOrder = item.split(':');\n                if (itemOrder.length === 2) {\n                    categoryOrderMap[itemOrder[0].trim().toLocaleUpperCase()] = itemOrder[1].trim();\n                }\n            });\n\n        const snptDict = this.editorOptions.widgetDict;\n        const allButtons = Object.values(snptDict);\n        // Parse filters that are autoset by the user.\n        const autoFilters = this.storage.getFromLocal(\"startup.filters\", \"\")\n            .split(\",\").map(f => f.trim());\n\n        const quickbuttonBehavior = getGlobalConfig(this.editor, 'insert.quickbutton.behavior', 'ctrlclick');\n        /**\n         * @type {Object.<string, Category>}\n         **/\n        const categories = {};\n        allButtons.forEach(btn => {\n            const isFilter = btn.isFilter();\n            let catName = (btn.category ?? 'MISC').toUpperCase();\n            if (catName === 'MISC' && translations.misc) {\n                catName = translations.misc.toUpperCase();\n            }\n            let found = categories[catName];\n            if (!found) {\n                const color = hashCode(catName) % 360;\n                let sat = '30%';\n                if (catName.toLowerCase().startsWith('obsolet')) {\n                    sat = '0%'; // Gray\n                }\n                found = {\n                    name: catName,\n                    order: categoryOrderMap[catName] ?? catName,\n                    hidden: false,\n                    color: color + ', ' + sat,\n                    buttons: []\n                };\n                categories[catName] = found;\n            }\n            const colwidth = (quickbuttonBehavior === 'none' ? 12 : 10) - (isFilter ? 2 : 0);\n            found.buttons.push({\n                hidden: false,\n                category: catName,\n                widgetindex: btn.id,\n                widgetkey: btn.key,\n                widgetname: btn.name,\n                widgetorder: btn.prop('order') ?? btn.name ?? btn.key ?? '',\n                widgettitle: btn.name + \" \" + catName,\n                iconname: \"fa fas fa-eye\",\n                disabled: !btn.isUsableInScope(),\n                selectable: btn.insertquery != null,\n                isfilter: isFilter,\n                filterset: isFilter && autoFilters.includes(btn.key),\n                maincolclass: `col-${colwidth}`\n            });\n        });\n        const categoriesList = Object.values(categories);\n        categoriesList.sort((a, b) => (a.order + '').localeCompare((b.order + '')));\n        categoriesList.forEach(cat => {\n            // Sort buttons by the order, not by the name\n            cat.buttons.sort((a, b) => (a.widgetorder + '').localeCompare((b.widgetorder + '')));\n            cat.hidden = cat.buttons.filter(btn => !btn.hidden).length == 0;\n        });\n\n        /** @type {any[]} */\n        let recentList = [];\n\n        const recentlyUsedBehavior = getGlobalConfig(this.editor, 'insert.recentlyused.behavior', 'lastused');\n        if (recentlyUsedBehavior !== 'none') {\n        // Update the list of recently used widgets\n            recentList = this.storage.getRecentUsed().filter((/** @type {any} **/ recent) => {\n                const key = recent.key;\n                const widget = snptDict[key];\n                if (!widget?.isUsableInScope()) {\n                    return false;\n                }\n                // In select mode must filter widgets that do support it\n                const selectable = widget.insertquery !== undefined;\n                const isSelection = this.isSelectMode();\n                return key.length > 0 && (!isSelection || (isSelection && selectable));\n            }).map((/** @type {any} **/ recent) => {\n                    const key = recent.key;\n                    const snpt = snptDict[key];\n                    if (snpt) {\n                        return {\n                            key: key,\n                            name: snpt.name\n                        };\n                    } else {\n                        return {\n                            key: key,\n                            name: \"\"\n                        };\n                    }\n            });\n        }\n\n        return {\n            rid: genID(),\n            selectmode: this.isSelectMode(),\n            elementid: this.editor.id,\n            categories: categoriesList,\n            recent: recentList,\n            showquickbuttons: quickbuttonBehavior !== 'none'\n        };\n    }\n\n    /**\n     * Handle a click within the Modal.\n     *\n     * @param {JQuery.ClickEvent} event The click event\n     */\n    async handlePickModalClick(event) {\n        /** @type {any} */\n        const target = event.target;\n        if (!target) {\n            return;\n        }\n        /** @type {HTMLElement | undefined} */\n        const buttonWrapper = target.closest('[data-key]');\n        /** @type {import('../options').Widget | null} */\n        let widget = null;\n        if (buttonWrapper) {\n            const selectedButton = buttonWrapper?.dataset?.key;\n            if (selectedButton) {\n                widget = this.editorOptions.widgetDict[selectedButton];\n            }\n        }\n        if (!widget) {\n            console.warn('Cannot find widget');\n            return;\n        }\n        /** @type {HTMLElement | undefined} */\n        const button = target.closest('button.tiny_widgethub-btn');\n        // Check if it is a toggle button to autoset a filter\n        if (button?.dataset?.auto) {\n            const isSet = button.dataset.auto !== \"true\";\n            button.dataset.auto = isSet + '';\n            toggleClass(button, 'tiny_widgethub-btn-primary', 'tiny_widgethub-btn-outline-primary');\n            const key = widget.key;\n            // Persist option\n            const autoFilters = new Set(this.storage.getFromLocal('startup.filters', '').split(''));\n            if (isSet) {\n                autoFilters.add(key);\n            } else {\n                autoFilters.delete(key);\n            }\n            this.storage.setToLocal('startup.filters', [...autoFilters].join(\",\"), true);\n            return;\n        }\n\n        // Recently used badges use <a> while real buttons are button[data-key]\n        /** @type {HTMLElement | undefined} */\n        const aRecentBadge = target.closest('a[data-key]');\n\n        // Determine if it is a rayButton\n        const isRayButton = button?.dataset?.insert === 'true';\n\n        /** @type {Record<string, any> | undefined} */\n        let ctx;\n        const bypassParamsModal = aRecentBadge !== null || isRayButton;\n        if (bypassParamsModal) {\n            // Quick insert\n            ctx = widget.defaultsWithRepeatable(true) || {};\n            // Should it load recently used values?\n            const metaActive = event.ctrlKey || event.metaKey;\n            /**\n             * @param {string} key\n             * @param {string} defaultValue\n             * @returns {boolean}\n             */\n            const isBehaviourLastUsed = (key, defaultValue) => {\n                let b = getGlobalConfig(this.editor, `insert.${key}.behavior`, defaultValue);\n                return (b === 'ctrlclick' && metaActive) || b === 'lastused';\n            };\n            const shouldLoadRecentValues = (aRecentBadge && isBehaviourLastUsed('recentlyused', 'lastused')) ||\n                (isRayButton && isBehaviourLastUsed('quickbutton', 'ctrlclick'));\n            if (shouldLoadRecentValues) {\n                const stored = this.storage.getRecentUsed().find(e => e.key === widget.key)?.p || {};\n                ctx = {...ctx, ...removeRndFromCtx(stored, widget.parameters)};\n            }\n        } else {\n            // Normal insert\n            ctx = widget.defaults || {};\n        }\n\n        // Must open a configuration dialogue for the current widget\n        let confirmMsg = null;\n\n        if (!widget.isUsableInScope()) {\n            confirmMsg = await get_string('confirmusage', 'tiny_widgethub');\n        }\n        if (confirmMsg) {\n            this.editor.windowManager.confirm(confirmMsg,\n                /** @param {*} state */\n                (state) => {\n                    if (state) {\n                        this.handlePickModalAction(widget, bypassParamsModal, ctx);\n                    }\n                });\n        } else {\n            this.handlePickModalAction(widget, bypassParamsModal, ctx);\n        }\n    }\n\n    /**\n     * @param {import('../options').Widget} widget\n     * @param {boolean} [forceInsert]\n     * @param {Record<string, *>} [ctx]\n     */\n    handlePickModalAction(widget, forceInsert, ctx) {\n        this.modal?.hide();\n        const paramsController = this.widgetParamsFactory(widget);\n        // Keep reference to the calling parentCtrl\n        paramsController.parentCtrl = this;\n        // Decide whether to show the form or directly doInsert\n        if (forceInsert || ((widget.parameters ?? []).length === 0 && !widget.instructions)) {\n            // Do insert directly\n            paramsController.insertWidget(ctx ?? {}, forceInsert);\n        } else {\n            // Show widget's parameters modal\n            paramsController.handleAction();\n        }\n    }\n}\n\nconst widgetPickerCtrlInstances = new Map();\n/**\n * @param {import('../plugin').TinyMCE} editor\n * @returns {WidgetPickerCtrl}\n */\nexport function getWidgetPickCtrl(editor) {\n    let instance = widgetPickerCtrlInstances.get(editor);\n    if (!instance) {\n        instance = new WidgetPickerCtrl(editor,\n            getEditorOptions(editor), getWidgetParamsFactory(editor),\n            getModalSrv(), getTemplateSrv(), getUserStorage(editor));\n        widgetPickerCtrlInstances.set(editor, instance);\n    }\n    return instance;\n}\n"],"names":["editor","instance","widgetPickerCtrlInstances","get","WidgetPickerCtrl","set","setVisibility","el","visible","classList","remove","add","modal","constructor","editorOptions","widgetParamsFactory","modalSrv","templateSrv","userStorage","storage","scrollPos","isSelectMode","this","selection","getContent","trim","length","setWidgetButtonsVisibility","bodyForm","searchtext","numshown","selectmode","find","each","i","dataset","selectable","el2","querySelector","textContent","title","onSearchKeyup","body","val","setToSession","_","count","querySelectorAll","evt","widget","widgetDict","target","closest","key","isFilter","html","_preview","generatePreview","css","getFromSession","miscStr","data","getPickTemplateContext","misc","create","blinkElem","document","createElement","selectModeStr","innerHTML","header","append","scrollspy","ex","console","error","timerEnter","timerOut","widgetSearchElem","debouncedKeyup","bind","on","rid","clear","trigger","event","clearTimeout","handlePickModalClick","setTimeout","onMouseEnterButton","movedFrom","movedTo","relatedTarget","contains","key1","parentElement","_movedFrom$parentElem","_movedFrom$parentElem2","key2","_movedTo$parentElemen","_movedTo$parentElemen2","scrollPane","Math","round","scrollTop","loadStore","recentlyUsedBehavior","getRecentUsed","filter","r","undefined","isSelectCapable","map","name","join","createModal","removeClass","addClass","show","_this$modal","toInterpolate","defaultsWithRepeatable","engine","prop","render","template","I18n","translations","categoryOrderMap","split","forEach","item","itemOrder","toLocaleUpperCase","snptDict","allButtons","Object","values","autoFilters","getFromLocal","f","quickbuttonBehavior","categories","btn","catName","category","toUpperCase","found","color","sat","toLowerCase","startsWith","order","hidden","buttons","colwidth","push","widgetindex","id","widgetkey","widgetname","widgetorder","widgettitle","iconname","disabled","isUsableInScope","insertquery","isfilter","filterset","includes","maincolclass","categoriesList","sort","a","b","localeCompare","cat","recentList","recent","isSelection","snpt","elementid","showquickbuttons","buttonWrapper","selectedButton","_buttonWrapper$datase","warn","button","_button$dataset","auto","isSet","Set","delete","setToLocal","aRecentBadge","isRayButton","insert","ctx","bypassParamsModal","metaActive","ctrlKey","metaKey","isBehaviourLastUsed","defaultValue","stored","e","p","parameters","defaults","confirmMsg","windowManager","confirm","state","handlePickModalAction","forceInsert","hide","paramsController","parentCtrl","instructions","insertWidget","handleAction","Map"],"mappings":"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"}