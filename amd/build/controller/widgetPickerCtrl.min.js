define("tiny_widgethub/controller/widgetPickerCtrl",["exports","../controller/widgetParamsCtrl","../options","../service/modalSrv","../service/templateSrv","../service/userStorageSrv","../util"],(function(_exports,_widgetParamsCtrl,_options,_modalSrv,_templateSrv,_userStorageSrv,_util){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.WidgetPickerCtrl=void 0,_exports.getWidgetPickCtrl=function(editor){let instance=widgetPickerCtrlInstances.get(editor);instance||(instance=new WidgetPickerCtrl(editor,(0,_options.getEditorOptions)(editor),(0,_widgetParamsCtrl.getWidgetParamsFactory)(editor),(0,_modalSrv.getModalSrv)(),(0,_templateSrv.getTemplateSrv)(),(0,_userStorageSrv.getUserStorage)(editor)),widgetPickerCtrlInstances.set(editor,instance));return instance};
/**
   * Tiny WidgetHub plugin.
   *
   * @module      tiny_widgethub/plugin
   * @copyright   2024 Josep Mulet Pol <pep.mulet@gmail.com>
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */
const toggleVisible=function(el,visible){visible?el.classList.remove("tiny_widgethub-hidden"):el.classList.add("tiny_widgethub-hidden")};class WidgetPickerCtrl{constructor(editor,editorOptions,widgetParamsFactory,modalSrv,templateSrv,userStorage){this.editor=editor,this.editorOptions=editorOptions,this.widgetParamsFactory=widgetParamsFactory,this.modalSrv=modalSrv,this.templateSrv=templateSrv,this.storage=userStorage,this.modalSrv.create("picker",{})}show(){var _this$modal;null===(_this$modal=this.modal)||void 0===_this$modal||_this$modal.show()}isSelectMode(){return this.editor.selection.getContent().trim().length>0}async handleAction(){const selectMode=this.isSelectMode(),onSearchKeyup=()=>{let numshown=0;const searchText=this.modal.body.find("input")[0].value||"";this.storage.setToSession("searchtext",searchText,!0);const allbtns=document.querySelectorAll(".tiny_widgethub-buttons"),allcatgs=document.querySelectorAll(".tiny_widgethub-category");searchText?allbtns.forEach((el=>{let visible=!selectMode||selectMode&&"true"===el.dataset.selectable;const el2=el.querySelector("button");visible=visible&&(0,_util.searchComp)((null==el2?void 0:el2.title)+"",searchText),toggleVisible(el,visible),visible&&numshown++})):allbtns.forEach((el=>{const visible=!selectMode||selectMode&&"true"===el.dataset.selectable;toggleVisible(el,visible),visible&&numshown++})),allcatgs.forEach((el=>{const count=el.querySelectorAll(".tiny_widgethub-buttons:not(.tiny_widgethub-hidden)").length;toggleVisible(el,count>0)})),console.log("Num shown buttons is ",numshown),toggleVisible(this.modal.body.find(".tiny_widgethub-emptylist")[0],0==numshown)};if(this.modal)console.log("Estic en mode selecció? "+selectMode),selectMode?this.modal.header.find("span.ib-blink").removeClass("tiny_widgethub-hidden"):this.modal.header.find("span.ib-blink").addClass("tiny_widgethub-hidden");else{const searchText=this.storage.getFromSession("searchtext",""),data=this.getPickTemplateContext({searchText:searchText});console.log(" data  is  ",data),this.modal=await this.modalSrv.create("picker",data,(()=>{this.modal.destroy(),this.modal=null}));try{this.modal.body.find(".tiny_widgethub-categorycontainer").scrollspy("refresh")}catch(ex){console.error("Problem setting scrollspy",ex)}const previewPanel=this.modal.body.find("div.tiny_widgethub-preview"),widgetTable=this.editorOptions.widgetDict,mouseEnterDebounced=(0,_util.debounce)((async evt=>{var _evt$target,_evt$target$dataset;const key=(null===(_evt$target=evt.target)||void 0===_evt$target||null===(_evt$target$dataset=_evt$target.dataset)||void 0===_evt$target$dataset?void 0:_evt$target$dataset.key)??"",widget=widgetTable[key];if(!widget||widget.isFilter())return;let html=widget._preview;html||(html=await this.generatePreview(widget),widget._preview=html),previewPanel.html(html),previewPanel.css("display","block")}),1e3),oMouseOut=()=>{mouseEnterDebounced.clear(),previewPanel.html(""),previewPanel.css("display","none")},widgetSearchElem=this.modal.body.find("input");widgetSearchElem.val(searchText);const debouncedKeyup=(0,_util.debounce)(onSearchKeyup,800);widgetSearchElem.on("keyup",debouncedKeyup),this.modal.body.find(`#widget-clearfilter-btn${data.rid}`).on("click",(()=>{debouncedKeyup.clear(),widgetSearchElem.val(""),widgetSearchElem.trigger("focus"),onSearchKeyup()})),this.modal.body.find("div.tiny_widgethub-categorycontainer, div.tiny_widgethub-recent").on("click",(event=>{mouseEnterDebounced.clear(),previewPanel.css("display","none"),console.log(event.target),this.handlePickModalClick(event)})),this.modal.body.find(".btn-group").on("mouseenter",mouseEnterDebounced).on("mouseout",oMouseOut)}this.modal.show(),onSearchKeyup(),setTimeout((()=>{var _this$modal2;if(null===(_this$modal2=this.modal)||void 0===_this$modal2||!_this$modal2.body)return;this.modal.body.find("input")[0].focus()}),400)}getPickTemplateContext(data){const snptDict=this.editorOptions.widgetDict,allButtons=Object.values(snptDict),categories={};allButtons.forEach((btn=>{const catName=(btn.category??"MISC").toUpperCase();let found=categories[catName];if(!found){const color=(0,_util.hashCode)(catName)%360;let sat="30%";catName.toLowerCase().startsWith("obsolet")&&(sat="0%"),found={name:catName,hidden:!1,color:color+", "+sat,buttons:[]},categories[catName]=found}found.buttons.push({hidden:!1,category:catName,widgetindex:btn.id,widgetkey:btn.key,widgetname:btn.name,widgettitle:btn.name+" "+catName,iconname:"fa fas fa-eye",disabled:btn.isUsableInScope(),selectable:null!=btn.insertquery,widgetfawesome:""})}));const categoriesList=Object.values(categories);categoriesList.sort(((a,b)=>a.name<b.name?-1:a.name>b.name?1:0)),categoriesList.forEach((cat=>{cat.buttons.sort(),cat.hidden=0==cat.buttons.filter((btn=>!btn.hidden)).length}));const recentList=this.storage.getRecentUsed().filter((recent=>{const key=recent.key,widget=snptDict[key];if(!widget)return!1;const selectable=void 0!==widget.insertquery,isSelection=this.isSelectMode();return key.length>0&&(!isSelection||isSelection&&selectable)})).map((recent=>{const key=recent.key,snpt=snptDict[key];return snpt?{key:key,name:snpt.name}:{key:key,name:""}}));return{rid:(0,_util.genID)(),selectMode:this.isSelectMode(),elementid:this.editor.id,categories:categoriesList,...data??{},recent:recentList}}async handlePickModalClick(event){const target=event.target;if(!target)return;const button=target.closest("button.tiny_widgethub-btn"),aRecent=target.closest("a[data-key]");let widget=null;if(button??aRecent){const selectedButton=(button??aRecent).dataset.key;widget=this.editorOptions.widgetDict[selectedButton]}if(!widget)return;let confirmMsg=null;widget.isUsableInScope()||(confirmMsg="Aquest widget no és adequat per a la pàgina actual. Segur que voleu continuar?"),confirmMsg?this.editor.windowManager.confirm(confirmMsg,(state=>{state&&this.handlePickModalAction(widget)})):this.handlePickModalAction(widget)}handlePickModalAction(widget){this.modal.hide();const paramsController=this.widgetParamsFactory(widget);paramsController.parentCtrl=this,0!==widget.parameters.length||widget.instructions?paramsController.handleAction():paramsController.insertWidget({})}}_exports.WidgetPickerCtrl=WidgetPickerCtrl;const widgetPickerCtrlInstances=new Map}));

//# sourceMappingURL=widgetPickerCtrl.min.js.map