define("tiny_widgethub/controller/widgetPickerCtrl",["exports","../controller/widgetParamsCtrl","../options","../service/modalSrv","../service/templateSrv","../service/userStorageSrv","../util"],(function(_exports,_widgetParamsCtrl,_options,_modalSrv,_templateSrv,_userStorageSrv,_util){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.WidgetPickerCtrl=void 0,_exports.getWidgetPickCtrl=function(editor){let instance=widgetPickerCtrlInstances.get(editor);instance||(instance=new WidgetPickerCtrl(editor,(0,_options.getEditorOptions)(editor),(0,_widgetParamsCtrl.getWidgetParamsFactory)(editor),(0,_modalSrv.getModalSrv)(),(0,_templateSrv.getTemplateSrv)(),(0,_userStorageSrv.getUserStorage)(editor)),widgetPickerCtrlInstances.set(editor,instance));return instance};
/**
   * Tiny WidgetHub plugin.
   *
   * @module      tiny_widgethub/plugin
   * @copyright   2024 Josep Mulet Pol <pep.mulet@gmail.com>
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */
const toggleVisible=function(el,visible){visible?el.classList.remove("tiny_widgethub-hidden"):el.classList.add("tiny_widgethub-hidden")};class WidgetPickerCtrl{modal;constructor(editor,editorOptions,widgetParamsFactory,modalSrv,templateSrv,userStorage){this.editor=editor,this.editorOptions=editorOptions,this.widgetParamsFactory=widgetParamsFactory,this.modalSrv=modalSrv,this.templateSrv=templateSrv,this.storage=userStorage,this.scrollPos=0}show(){var _this$modal;null===(_this$modal=this.modal)||void 0===_this$modal||_this$modal.show()}isSelectMode(){return this.editor.selection.getContent().trim().length>0}onSearchKeyup(){const selectMode=this.isSelectMode();let numshown=0;const searchText=this.modal.body.find("input")[0].value||"";this.storage.setToSession("searchtext",searchText,!0);const allbtns=document.querySelectorAll(".btn-group"),allcatgs=document.querySelectorAll(".tiny_widgethub-category");searchText?allbtns.forEach((el=>{let visible=!selectMode||selectMode&&"true"===el.dataset.selectable;const el2=el.querySelector("button");visible=visible&&(0,_util.searchComp)((null==el2?void 0:el2.title)+"",searchText),toggleVisible(el,visible),visible&&numshown++})):allbtns.forEach((el=>{const visible=!selectMode||selectMode&&"true"===el.dataset.selectable;toggleVisible(el,visible),visible&&numshown++})),allcatgs.forEach((el=>{const count=el.querySelectorAll(".btn-group:not(.tiny_widgethub-hidden)").length;toggleVisible(el,count>0)})),console.log("Num shown buttons is ",numshown),toggleVisible(this.modal.body.find(".tiny_widgethub-emptylist")[0],0==numshown)}async createModal(){const searchText=this.storage.getFromSession("searchtext",""),data=this.getPickTemplateContext({searchText:searchText});console.log(" data  is  ",data),this.modal=await this.modalSrv.create("picker",data);try{this.modal.body.find(".tiny_widgethub-categorycontainer").scrollspy("refresh")}catch(ex){console.error("Problem setting scrollspy",ex)}const previewPanel=this.modal.body.find("div.tiny_widgethub-preview"),widgetTable=this.editorOptions.widgetDict,mouseEnterDebounced=(0,_util.debounce)((async evt=>{var _evt$target,_evt$target$closest,_evt$target$closest$d;const key=(null===(_evt$target=evt.target)||void 0===_evt$target||null===(_evt$target$closest=_evt$target.closest(".btn-group"))||void 0===_evt$target$closest||null===(_evt$target$closest$d=_evt$target$closest.dataset)||void 0===_evt$target$closest$d?void 0:_evt$target$closest$d.key)??"",widget=widgetTable[key];if(!widget||widget.isFilter())return;let html=widget._preview;html||(html=await this.generatePreview(widget),widget._preview=html),previewPanel.html(html),previewPanel.css("display","block")}),1e3),widgetSearchElem=this.modal.body.find("input");widgetSearchElem.val(searchText);const debouncedKeyup=(0,_util.debounce)(this.onSearchKeyup.bind(this),800);widgetSearchElem.on("keyup",debouncedKeyup),this.modal.body.find(`#widget-clearfilter-btn${data.rid}`).on("click",(()=>{debouncedKeyup.clear(),widgetSearchElem.val(""),widgetSearchElem.trigger("focus"),this.onSearchKeyup()})),this.modal.body.find("div.tiny_widgethub-categorycontainer, div.tiny_widgethub-recent").on("click",(event=>{mouseEnterDebounced.clear(),previewPanel.css("display","none"),console.log(event.target),this.handlePickModalClick(event)})),this.modal.body.find(".btn-group").on("mouseenter",mouseEnterDebounced).on("mouseout",(()=>{mouseEnterDebounced.clear(),previewPanel.html(""),previewPanel.css("display","none")}));const scrollPane=this.modal.body.find(".tiny_widgethub-categorycontainer");scrollPane.on("scroll",(0,_util.debounce)((()=>{this.scrollPos=Math.round(scrollPane.scrollTop()??0)}),100))}async handleAction(){if(this.storage.loadStore(),this.modal){const widgetDict=(0,_options.getWidgetDict)(this.editor),html=this.storage.getRecentUsed().filter((r=>void 0!==widgetDict[r.key])).map((r=>`<a href="javascript:void(0)" data-key="${r.key}" data-insert="recent"><span class="badge badge-secondary">${widgetDict[r.key].name}</span></a>`)).join("\n");this.modal.body.find(".tiny_widgethub-recent").html(html)}else await this.createModal();const selectMode=this.isSelectMode();console.log("Estic en mode selecció? "+selectMode),selectMode?this.modal.header.find("span.ib-blink").removeClass("tiny_widgethub-hidden"):this.modal.header.find("span.ib-blink").addClass("tiny_widgethub-hidden"),this.modal.show(),setTimeout((()=>{var _this$modal2;null!==(_this$modal2=this.modal)&&void 0!==_this$modal2&&_this$modal2.body&&(this.scrollPos>0&&(console.log("Setting scroll to ",this.scrollPos),this.modal.body.find(".tiny_widgethub-categorycontainer").scrollTop(this.scrollPos)),this.modal.body.find("input").trigger("focus"))}),200)}generatePreview(widget){const toInterpolate={...widget.defaults},engine=widget.prop("engine");return this.templateSrv.render(widget.template??"",toInterpolate,widget.I18n,engine)}getPickTemplateContext(data){const snptDict=this.editorOptions.widgetDict,allButtons=Object.values(snptDict),autoFilters=this.storage.getFromLocal("startup.filters","").split(",").map((f=>f.trim())),categories={};allButtons.forEach((btn=>{const isFilter=btn.isFilter(),catName=(btn.category??"MISC").toUpperCase();let found=categories[catName];if(!found){const color=(0,_util.hashCode)(catName)%360;let sat="30%";catName.toLowerCase().startsWith("obsolet")&&(sat="0%"),found={name:catName,hidden:!1,color:color+", "+sat,buttons:[]},categories[catName]=found}found.buttons.push({hidden:!1,category:catName,widgetindex:btn.id,widgetkey:btn.key,widgetname:btn.name,widgettitle:btn.name+" "+catName,iconname:"fa fas fa-eye",disabled:!btn.isUsableInScope(),selectable:null!=btn.insertquery,isfilter:isFilter,filterset:isFilter&&autoFilters.includes(btn.key)})}));const categoriesList=Object.values(categories);categoriesList.sort(((a,b)=>a.name<b.name?-1:a.name>b.name?1:0)),categoriesList.forEach((cat=>{cat.buttons.sort(),cat.hidden=0==cat.buttons.filter((btn=>!btn.hidden)).length}));const recentList=this.storage.getRecentUsed().filter((recent=>{const key=recent.key,widget=snptDict[key];if(!widget)return!1;const selectable=void 0!==widget.insertquery,isSelection=this.isSelectMode();return key.length>0&&(!isSelection||isSelection&&selectable)})).map((recent=>{const key=recent.key,snpt=snptDict[key];return snpt?{key:key,name:snpt.name}:{key:key,name:""}}));return{rid:(0,_util.genID)(),selectMode:this.isSelectMode(),elementid:this.editor.id,categories:categoriesList,...data??{},recent:recentList}}async handlePickModalClick(event){var _button$dataset,_button$dataset2;const target=event.target;if(!target)return;const buttonWrapper=target.closest("[data-key]");let widget=null;if(buttonWrapper){var _buttonWrapper$datase;const selectedButton=null==buttonWrapper||null===(_buttonWrapper$datase=buttonWrapper.dataset)||void 0===_buttonWrapper$datase?void 0:_buttonWrapper$datase.key;selectedButton&&(widget=this.editorOptions.widgetDict[selectedButton])}if(!widget)return;const button=target.closest("button.btn");if(null!=button&&null!==(_button$dataset=button.dataset)&&void 0!==_button$dataset&&_button$dataset.auto){const isSet="true"!==button.dataset.auto;button.dataset.auto=isSet+"",(0,_util.toggleClass)(button,"btn-primary","btn-outline-primary");const key=widget.key,autoFilters=new Set(this.storage.getFromLocal("startup.filters","").split(""));return isSet?autoFilters.add(key):autoFilters.delete(key),void this.storage.setToLocal("startup.filters",[...autoFilters].join(","),!0)}const aRecent=target.closest("a[data-key]");let ctx;var _this$storage$getRece;aRecent&&(ctx=null===(_this$storage$getRece=this.storage.getRecentUsed().filter((e=>e.key===widget.key))[0])||void 0===_this$storage$getRece?void 0:_this$storage$getRece.p);let confirmMsg=null;widget.isUsableInScope()||(confirmMsg="Aquest widget no és adequat per a la pàgina actual. Segur que voleu continuar?");const forceInsert=null!==aRecent||"true"===(null==button||null===(_button$dataset2=button.dataset)||void 0===_button$dataset2?void 0:_button$dataset2.insert);confirmMsg?this.editor.windowManager.confirm(confirmMsg,(state=>{state&&this.handlePickModalAction(widget,forceInsert,ctx)})):this.handlePickModalAction(widget,forceInsert,ctx)}handlePickModalAction(widget,forceInsert,ctx){var _this$modal3;null===(_this$modal3=this.modal)||void 0===_this$modal3||_this$modal3.hide();const paramsController=this.widgetParamsFactory(widget);paramsController.parentCtrl=this,forceInsert||0===(widget.parameters??[]).length&&!widget.instructions?paramsController.insertWidget(ctx??{}):paramsController.handleAction()}}_exports.WidgetPickerCtrl=WidgetPickerCtrl;const widgetPickerCtrlInstances=new Map}));

//# sourceMappingURL=widgetPickerCtrl.min.js.map