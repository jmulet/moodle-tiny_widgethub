define("tiny_widgethub/controller/widgetParamsCtrl",["exports","../controller/formCtrl","../extension","../service/modalSrv","../service/templateSrv","../service/userStorageSrv","../util","core/str"],(function(_exports,_formCtrl,_extension,_modalSrv,_templateSrv,_userStorageSrv,_util,coreStr){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.WidgetParamsCtrl=void 0,_exports.getWidgetParamsFactory=function(editor){const applyWidgetFilter=(0,_util.applyWidgetFilterFactory)(editor,coreStr);return widget=>new WidgetParamsCtrl(editor,(0,_userStorageSrv.getUserStorage)(editor),(0,_templateSrv.getTemplateSrv)(),(0,_modalSrv.getModalSrv)(),(0,_formCtrl.getFormCtrl)(editor),applyWidgetFilter,widget)},coreStr=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}
/**
   * Tiny WidgetHub plugin.
   *
   * @module      tiny_widgethub/plugin
   * @copyright   2024 Josep Mulet Pol <pep.mulet@gmail.com>
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */(coreStr);class WidgetParamsCtrl{modal=null;parentCtrl;constructor(editor,userStorage,templateSrv,modalSrv,formCtrl,applyWidgetFilter,widget){this.editor=editor,this.storage=userStorage,this.templateSrv=templateSrv,this.modalSrv=modalSrv,this.formCtrl=formCtrl,this.applyWidgetFilter=applyWidgetFilter,this.widget=widget}async handleAction(){const data=this.formCtrl.createContext(this.widget),modal=await this.modalSrv.create("params",data,(()=>{var _this$modal;null===(_this$modal=this.modal)||void 0===_this$modal||_this$modal.destroy(),this.modal=null}));this.modal=modal,modal.body.find(`a[href="#${data.idTabpane}_1"`).on("click",(async()=>{const ctxFromDialogue=this.formCtrl.extractFormParameters(this.widget,modal.body.find("form"),!0);await this.updatePreview(data.idTabpane,ctxFromDialogue)})),this.formCtrl.attachPickers(modal.body),modal.footer.show(),modal.footer.find("button.btn-secondary").on("click",(async()=>{modal.destroy(),this.parentCtrl&&await this.parentCtrl.handleAction()})),modal.footer.find("button.btn-primary").on("click",(async()=>{const ctxFromDialogue=this.formCtrl.extractFormParameters(this.widget,modal.body.find("form"),!0);modal.hide(),await this.insertWidget(ctxFromDialogue),modal.destroy()}));const selectMode=""!=this.editor.selection.getContent().trim();this.formCtrl.applyFieldWatchers(modal.body,this.widget.defaults,this.widget,selectMode),modal.show()}destroy(){var _this$modal2;null===(_this$modal2=this.modal)||void 0===_this$modal2||_this$modal2.destroy()}render(ctx){const defaultsCopy={...this.widget.defaults},toInterpolate=Object.assign(defaultsCopy,ctx??{});let engine=this.widget.prop("engine");return this.templateSrv.render(this.widget.template??"",toInterpolate,this.widget.I18n,engine)}async generateInterpolatedCode(ctxFromDialogue){const sel=this.editor.selection.getContent();let interpoledComponentCode=await this.render(ctxFromDialogue);if(sel.trim()&&this.widget.insertquery){let query=this.widget.insertquery.trim(),replaceMode=query.startsWith("r!");replaceMode&&(query=query.substring(2).trim());const tmpDiv=document.createElement("div");tmpDiv.innerHTML=interpoledComponentCode,console.log(interpoledComponentCode);const insertPoint=tmpDiv.querySelector(query);insertPoint?(replaceMode?insertPoint.outerHTML=sel:insertPoint.innerHTML=sel,interpoledComponentCode=tmpDiv.innerHTML):console.error("Cannot find insert point",query)}return interpoledComponentCode}async updatePreview(idTabpane,ctxFromDialogue){var _this$modal3,_this$modal3$body;const interpoledCode=await this.generateInterpolatedCode(ctxFromDialogue),$previewPanel=null===(_this$modal3=this.modal)||void 0===_this$modal3||null===(_this$modal3$body=_this$modal3.body)||void 0===_this$modal3$body?void 0:_this$modal3$body.find(`#${idTabpane}_1`);$previewPanel&&$previewPanel.html(interpoledCode)}async insertWidget(ctxFromDialogue){const recentList=this.storage.getRecentUsed(),pos=recentList.map((e=>e.key)).indexOf(this.widget.key);if(pos>=0&&recentList.splice(pos,1),recentList.unshift({key:this.widget.key,p:ctxFromDialogue}),recentList.length>4&&recentList.splice(5,recentList.length-4),this.storage.setToSession("recent",JSON.stringify(recentList),!0),this.widget.isFilter())return this.applyWidgetFilter(this.widget.template??"",!1,ctxFromDialogue),void this.editor.focus();const interpoledCode=await this.generateInterpolatedCode(ctxFromDialogue);this.editor.selection.setContent(interpoledCode),this.editor.focus(),(0,_extension.getListeners)("widgetInserted").forEach((listener=>listener(this.editor,this.widget,ctxFromDialogue)))}}_exports.WidgetParamsCtrl=WidgetParamsCtrl}));

//# sourceMappingURL=widgetParamsCtrl.min.js.map