{"version":3,"file":"form_ctrl.min.js","sources":["../../src/controller/form_ctrl.js"],"sourcesContent":["/* eslint-disable max-len */\n/* eslint-disable no-console */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny WidgetHub plugin.\n *\n * @module      tiny_widgethub/plugin\n * @copyright   2024 Josep Mulet Pol <pep.mulet@gmail.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport {getFileSrv} from '../service/file_service';\nimport {getTemplateSrv} from '../service/template_service';\nimport {getUserStorage} from '../service/userstorage_service';\nimport {capitalize, cleanParameterName, evalInContext, genID, stream, toHexAlphaColor, toRgba} from '../util';\n\nconst questionPopover = '{{#tooltip}}<a href=\"javascript:void(0)\" data-toggle=\"popover\" data-trigger=\"hover\" data-content=\"{{tooltip}}\" data-bs-toggle=\"popover\" data-bs-trigger=\"hover\" data-bs-content=\"{{tooltip}}\"><i class=\"fa fas fa-question-circle text-info\"></i></a>{{/tooltip}}';\n\nexport const Templates = {\n   TEXTFIELDTEMPLATE: `<div id=\"{{elementid}}\" class=\"form-group row mx-1{{#hidden}} d-none{{/hidden}}\"><label class=\"col-sm-5 col-form-label\" for=\"{{elementid}}_ftmpl\" title=\"{{varname}}\">{{vartitle}} ${questionPopover}</label>\n   <div class=\"col-sm-7\"><input type=\"text\" id=\"{{elementid}}_ftmpl\" class=\"form-control\" name=\"{{varname}}\" {{#disabled}}disabled{{/disabled}} value=\"{{defaultvalue}}\"/></div>\n   </div>`,\n\n   IMAGETEMPLATE: `<div id=\"{{elementid}}\" class=\"form-group row mx-1{{#hidden}} d-none{{/hidden}}\"><label class=\"col-sm-5 col-form-label\" for=\"{{elementid}}_ftmpl\" title=\"{{varname}}\">{{vartitle}} ${questionPopover}</label>\n   <div class=\"col-sm-7\">\n   <input type=\"text\" id=\"{{elementid}}_ftmpl\" class=\"form-control d-inline-block w-75\" name=\"{{varname}}\" {{#disabled}}disabled{{/disabled}} value=\"{{defaultvalue}}\"/>\n   <button class=\"whb-image-picker btn btn-sm btn-secondary d-inline-block\" title=\"Search\"><i class=\"fas fa fa-search\"></i></button>\n   </div>\n   </div>`,\n\n   NUMERICTEMPLATE: `<div id=\"{{elementid}}\" class=\"form-group row mx-1{{#hidden}} d-none{{/hidden}}\"><label class=\"col-sm-5 col-form-label\"  for=\"{{elementid}}_fntmpl\" title=\"{{varname}}\">{{vartitle}} ${questionPopover}</label>\n   <div class=\"col-sm-7\"><input type=\"number\" id=\"{{elementid}}_fntmpl\" class=\"form-control\" name=\"{{varname}}\" {{{minMax}}} {{#disabled}}disabled{{/disabled}} value=\"{{defaultvalue}}\"/></div>\n   </div>`,\n\n   COLORTEMPLATE: `<div id=\"{{elementid}}\" class=\"form-group row mx-1{{#hidden}} d-none{{/hidden}}\"><label class=\"col-sm-5 col-form-label\"  for=\"{{elementid}}_fntmpl\" title=\"{{varname}}\">{{vartitle}} ${questionPopover}</label>\n   <div class=\"col-sm-7\">\n   <span class=\"w-50 tiny_widgethub-pattern\">\n      <input type=\"color\" id=\"{{elementid}}_fctmpl\" name=\"{{varname}}\" {{#disabled}}disabled{{/disabled}} value=\"{{defaultvalue}}\"/>\n   </span>\n   <input type=\"range\" id=\"{{elementid}}_fcatmpl\" title=\"Opacity\" name=\"{{varname}}_alpha\" {{#disabled}}disabled{{/disabled}} value=\"{{defaultvalueAlpha}}\" min=\"0\" max=\"1\" step=\"0.01\"/>\n   </div></div>`,\n\n   TEXTAREATEMPLATE: `<div id=\"{{elementid}}\" class=\"form-group{{#hidden}} d-none{{/hidden}}\"><label for=\"{{elementid}}_tatmpl\" title=\"{{varname}}\">{{vartitle}} ${questionPopover}</label>\n   <textarea id=\"{{elementid}}_tatmpl\" rows=\"3\" class=\"form-control\" name=\"{{varname}}\" {{#disabled}}disabled{{/disabled}} {{#tooltip}}title=\"{{tooltip}}\"{{/tooltip}}>{{defaultvalue}}</textarea>\n   </div>`,\n\n   CHECKBOXTEMPLATE: `<div id=\"{{elementid}}\" class=\"form-group w-75 m-2{{#hidden}} d-none{{/hidden}}\">\n   <label>\n   <input title=\"{{varname}}\" id=\"{{elementid}}_cbtmpl\" {{#disabled}}disabled{{/disabled}} type=\"checkbox\" name=\"{{varname}}\" value=\"{{defaultvalue}}\" {{#defaultvalue}}checked{{/defaultvalue}}/></span>\n   {{vartitle}}</label> <span>&nbsp;&nbsp;  ${questionPopover}</span>\n   </div>`,\n\n   SELECTTEMPLATE: `<div id=\"{{elementid}}\" class=\"form-group row mx-1{{#hidden}} d-none{{/hidden}}\">\n   <label class=\"col-sm-5 col-form-label\" for=\"{{elementid}}_stmpl\" title=\"{{varname}}\">{{vartitle}} ${questionPopover}</label>\n   <div class=\"col-sm-7\">\n   <select id=\"{{elementid}}_stmpl\" class=\"form-control\" name=\"{{varname}}\" {{#disabled}}disabled{{/disabled}} {{#tooltip}}title=\"{{tooltip}}\"{{/tooltip}}>\n   {{#options}}\n   <option value=\"{{optionValue}}\"{{#selected}} selected{{/selected}}>{{optionLabel}}</option>\n   {{/options}}\n   </select>\n   </div>\n   </div>`,\n\n   AUTOCOMPLETETEMPLATE: `<div id=\"{{elementid}}\" class=\"form-group row mx-1{{#hidden}} d-none{{/hidden}}\"><label class=\"col-sm-5 col-form-label\" for=\"{{elementid}}_ftmpl\" title=\"{{varname}}\">{{vartitle}} ${questionPopover}</label>\n   <div class=\"col-sm-7\"><input type=\"text\" list=\"{{elementid}}_aclist\" id=\"{{elementid}}_actmpl\" class=\"form-control\" name=\"{{varname}}\" {{#disabled}}disabled{{/disabled}} value=\"{{defaultvalue}}\" autocomplete=\"off\"/>\n   <datalist id=\"{{elementid}}_aclist\">\n   {{#options}}\n   <option value=\"{{optionValue}}\"/>\n   {{/options}}\n   </datalist>\n   </div>\n   </div>`,\n\n   REPEATABLE: `<div id=\"{{elementid}}\" name=\"{{varname}}\" type=\"repeatable\" class=\"form-group row mx-1{{#hidden}} d-none{{/hidden}}\">\n      <span class=\"form-label\" title=\"{{varname}}\">{{vartitle}} ${questionPopover}</span>\n      {{{itemControls}}}\n   </div>`,\n};\n\n\nexport class FormCtrl {\n   /**\n    * @param {import('../plugin').TinyMCE} editor\n    * @param {import('../service/userstorage_service').UserStorageSrv} userStorage\n    * @param {import('../service/template_service').TemplateSrv} templateSrv\n    * @param {import('../service/file_service').FileSrv} fileSrv\n    */\n   constructor(editor, userStorage, templateSrv, fileSrv) {\n      /** @type {import('../plugin').TinyMCE} */\n      this.editor = editor;\n      /** @type {import('../service/userstorage_service').UserStorageSrv} */\n      this.storage = userStorage;\n      /** @type {import('../service/template_service').TemplateSrv} */\n      this.templateSrv = templateSrv;\n      /** @type {import('../service/file_service').FileSrv} */\n      this.fileSrv = fileSrv;\n   }\n\n   /**\n    * @param {import('../options').Widget} widget\n    * @returns {*} - The generated context\n    */\n   createContext(widget) {\n      /** @type {boolean} */\n      const mustSaveAll = this.storage.getFromLocal('saveall', false);\n      /** @type {Object.<string, any>} */\n      const saveAllData = this.storage.getFromLocal('saveall_data', {});\n      /** @type {Object.<string, any>} */\n      const values = this.storage.getFromLocal(\"values\", {});\n      const defaults = widget.defaults;\n\n      /**\n       * @param {import('../options').Param} param\n       * @returns {any}\n       */\n      const obtainCurrentValue = (param) => {\n         const sname = widget.key;\n         const pname = param.name;\n         let currentval = defaults[pname];\n         if (pname.startsWith(\"_\") && values[pname]) {\n            currentval = values[pname];\n         }\n         if (mustSaveAll) {\n            // Search the last used value of this parameter\n            if ((saveAllData[sname]?.[pname] ?? null) !== null) {\n               currentval = saveAllData[sname][pname];\n            }\n         }\n         return currentval;\n      };\n\n      const controls = widget.parameters.map(param => this.createControlHTML(this.editor.id, param, obtainCurrentValue(param)));\n\n      const ctx = {\n         idtabpane: genID(),\n         selectmode: this.editor.selection.getContent().trim().length > 0,\n         name: widget.name,\n         instructions: widget.instructions,\n         filter: widget.isFilter(),\n         controls: controls\n      };\n      return ctx;\n   }\n\n   /**\n    * @param {string} hostId - The id of the editor\n    * @param {import('../options').Param} param - The parameter object defining the control\n    * @param {any} defaultValue - Default values for the parameter\n    * @param {string} [prefixName] - Add a suffix to the control name\n    * @param {number | undefined} [index] - Index used in repeatable fields\n    * @returns {string} - The generated HTML for this control\n    */\n   createControlHTML(hostId, param, defaultValue, prefixName, index) {\n      let markup = '';\n      let pname = cleanParameterName(param.name);\n      if (prefixName) {\n         pname = prefixName + \"_\" + pname;\n      }\n      const generalCtx = {\n         elementid: hostId + \"_\" + pname + (index === undefined ? '' : index),\n         varname: pname,\n         vartitle: param.title,\n         defaultvalue: defaultValue,\n         tooltip: param.tip || param.tooltip,\n         disabled: param.editable === false,\n         hidden: param.hidden === true\n      };\n      if (param.type === 'textarea') {\n         markup = this.templateSrv.renderMustache(Templates.TEXTAREATEMPLATE, generalCtx);\n      } else if (param.type === 'numeric') {\n         let minMax = \"\";\n         if (param.min) {\n            minMax += `min=\"${param.min}\"`;\n         }\n         if (param.max) {\n            minMax += ` max=\"${param.max}\"`;\n         }\n         markup = this.templateSrv.renderMustache(Templates.NUMERICTEMPLATE, {minMax: minMax, ...generalCtx});\n      } else if (param.type === 'checkbox') {\n         markup = this.templateSrv.renderMustache(Templates.CHECKBOXTEMPLATE, generalCtx);\n      } else if (param.type === 'select' || param.type === 'autocomplete') {\n         const options = (param.options ?? []).map(opt => {\n            let label;\n            let value;\n            if (typeof opt === 'string') {\n               label = capitalize(opt);\n               value = opt;\n            } else {\n               label = opt.l;\n               value = opt.v;\n            }\n            return {optionLabel: label, optionValue: value, selected: value === defaultValue};\n         });\n         const tmpl = param.type === 'select' ? Templates.SELECTTEMPLATE : Templates.AUTOCOMPLETETEMPLATE;\n         markup = this.templateSrv.renderMustache(tmpl, {options, ...generalCtx});\n      } else if (param.type === 'color') {\n         // Value must be in hex form and must find alpha (0-1)\n         const [hex, alpha] = toHexAlphaColor(generalCtx.defaultvalue);\n         generalCtx.defaultvalue = hex;\n         /** @ts-ignore */\n         generalCtx.defaultvalueAlpha = alpha;\n         markup = this.templateSrv.renderMustache(Templates.COLORTEMPLATE, generalCtx);\n      } else if (param.type === 'image') {\n         markup = this.templateSrv.renderMustache(Templates.IMAGETEMPLATE, generalCtx);\n      } else if (param.type === 'repeatable') {\n         let itemControls = '';\n         if (Array.isArray(defaultValue) && defaultValue.length) {\n            // Generate the controls statically (used in context menus)\n            const ul = RepeatableCtrl.createListGroup();\n            defaultValue.forEach(obj => {\n               if (typeof obj !== 'object') {\n                  return;\n               }\n               const tmpDiv = document.createElement(\"DIV\");\n               tmpDiv.className = 'w-100';\n               Object.keys(obj).forEach(key => {\n                  const field = param.fields?.filter(f => f.name === key)[0];\n                  if (field) {\n                     tmpDiv.innerHTML = this.createControlHTML(hostId, field, obj[key], pname, index);\n                  }\n               });\n               ul.append(RepeatableCtrl.createRegularItem(tmpDiv, false));\n            });\n            itemControls = ul.outerHTML;\n         }\n         markup = this.templateSrv.renderMustache(Templates.REPEATABLE, {...generalCtx, itemControls});\n      } else {\n         // Assume textfield\n         markup = this.templateSrv.renderMustache(Templates.TEXTFIELDTEMPLATE, generalCtx);\n      }\n      return markup;\n   }\n\n   /**\n    * It extracts the value of a single HTML input control\n    * @param {HTMLInputElement} elem\n    * @param {import('../options').Param} param\n    */\n   extractControlValue(elem, param) {\n      const type = elem.getAttribute(\"type\");\n      /** @type {string | number | boolean} */\n      let value = elem.value ?? \"\";\n      if (elem.tagName === \"INPUT\" && type === \"checkbox\") {\n         value = elem.checked;\n      } else if (elem.tagName === \"INPUT\" && type === \"number\") {\n         if (value.indexOf(\".\") >= 0) {\n            value = parseFloat(value);\n         } else {\n            value = parseInt(value);\n         }\n      } else if (elem.tagName === \"INPUT\" && type === \"color\") {\n         // Must also find the corresponding alpha channel value\n         const pname = param.name;\n         const cleanPname = cleanParameterName(pname);\n         /** @type {HTMLInputElement | null | undefined} */\n         const rangeControl = elem.closest(\".form-group\")?.querySelector(`[name=\"${cleanPname}_alpha\"]`);\n         const alpha = rangeControl?.value ?? 1;\n         value = toRgba(value, +alpha);\n      }\n\n      if (param.transform) {\n         value = stream(param.transform).reduce(value);\n      }\n      return value;\n   }\n\n   /**\n    * Obtains the updated parameter values from the modal\n    * This is used in insertWidget\n    * @param {import('../options').Widget} widget\n    * @param {HTMLElement} form\n    * @param {boolean} doStore\n    * @returns {Record<string, any>} - The updated parameters dict\n    */\n   extractFormParameters(widget, form, doStore) {\n      /** @type {Object.<string, any>}  */\n      const ctx = {};\n      /** @type {Object.<string, any>}  */\n      const toPersist = {};\n      const defaults = widget.defaults;\n      widget.parameters.forEach(param => {\n         const pname = param.name;\n         const cleanParamname = cleanParameterName(pname);\n         /** @type {HTMLInputElement | null} */\n         const elem = form.querySelector(`[name=\"${cleanParamname}\"]`);\n         if (!elem) {\n            ctx[pname] = defaults[pname];\n            return;\n         }\n         // The elem might be a div for repeatable inputs.\n         if (param.type === 'repeatable') {\n            /** @type {any[]}  */\n            const listValue = [];\n            elem.querySelectorAll(\".list-group-item.tiny_widgethub-regularitem\").forEach(subform => {\n               /** @type {Record<string, any>} */\n               const itemObj = {};\n               param.fields?.forEach(field => {\n                  const cleanFieldname = cleanParameterName(field.name);\n                  /** @type {HTMLInputElement | null} */\n                  const subelem = subform.querySelector(`[name=\"${cleanParamname}_${cleanFieldname}\"]`);\n                  if (subelem) {\n                     itemObj[field.name] = this.extractControlValue(subelem, field);\n                  }\n               });\n               listValue.push(itemObj);\n            });\n            ctx[pname] = listValue;\n         } else {\n            ctx[pname] = this.extractControlValue(elem, param);\n         }\n\n         if (pname.trim().startsWith(\"_\")) {\n            toPersist[pname] = ctx[pname];\n         }\n      });\n\n      if (doStore && this.storage) {\n         if (Object.keys(toPersist).length) {\n            // Only those starting with _\n            this.storage.setToLocal('values', toPersist, true);\n         }\n         // Should all values be persisted?\n         const mustSaveAll = this.storage.getFromLocal('saveall', false);\n         if (mustSaveAll) {\n            /** @type {Object.<string, any>}  */\n            const previousAllData = this.storage.getFromLocal('saveall_data', {});\n            previousAllData[widget.name] = {...ctx};\n            this.storage.setToLocal('saveall_data', previousAllData, true);\n         }\n      }\n      return ctx;\n   }\n\n   /**\n    * @param {HTMLElement} modalBody - The modal body\n    */\n   attachPickers(modalBody) {\n      // Find all file pickers\n      const canShowFilePicker = typeof this.fileSrv.getImagePicker() !== 'undefined';\n      if (canShowFilePicker) {\n         /** @type {NodeListOf<HTMLButtonElement>} */\n         const pickers = modalBody.querySelectorAll('button.whb-image-picker');\n         pickers.forEach(picker => {\n            picker.disabled = !canShowFilePicker;\n            // Attach a click handler to any image-picker buttons\n            picker.addEventListener(\"click\", async(evt) => {\n               evt.preventDefault();\n               try {\n                  /** @type {{url?: string}} */\n                  const params = await this.fileSrv.displayImagePicker();\n                  if (params?.url) {\n                     const parent = /** @type {HTMLElement} */ (evt.currentTarget).parentElement;\n                     const input = parent?.querySelector('input');\n                     if (input) {\n                        input.value = params.url;\n                     }\n                  }\n               } catch (ex) {\n                  console.error(ex);\n               }\n            });\n         });\n      }\n\n      // Find all color pickers\n      /** @type {NodeListOf<HTMLInputElement>} */\n      const colorPickers = modalBody.querySelectorAll('input[type=\"color\"]');\n      colorPickers.forEach(inputColor => {\n         const name = inputColor.getAttribute('name');\n         if (!name) {\n            return;\n         }\n         // Find corresponding range slider\n         /** @type {HTMLInputElement | null} */\n         const inputRange = modalBody.querySelector(`input[name=\"${name}_alpha\"]`);\n         if (!inputRange) {\n            return;\n         }\n         const opacity = inputRange.value ?? 1;\n         inputColor.style.opacity = '' + opacity;\n         // Bind envent change\n         inputRange.addEventListener('change', () => {\n            const opacity = inputRange.value ?? 1;\n            inputColor.style.opacity = '' + opacity;\n         });\n      });\n   }\n\n   /**\n    * @param {HTMLElement} formElem\n    * @param {Object.<string, any>} defaultsData\n    * @param {import('../options').Widget} widget\n    * @param {boolean} selectmode\n    */\n   applyFieldWatchers(formElem, defaultsData, widget, selectmode) {\n      /** @type {string[]} */\n      const watchedvars = []; // All these variable names must be watched\n      /**\n       * all these components must be updated when one watcher changes\n       *  @type {{\n       *    condition: string,\n       *    component: Element,\n       *    type: string,\n       *    indx: number\n       *  }[]}\n       */\n      const updatableComponents = [];\n\n      const regex = /\\{{2}([^}]*)\\}{2}/gm;\n      for (let indx = 0, len = widget.parameters.length; indx < len; indx++) {\n\n         const varobj = widget.parameters[indx];\n\n         if (varobj.when) {\n            const condition = varobj.when;\n            const t = varobj.type;\n            const control = formElem.querySelector(`[name=\"${cleanParameterName(varobj.name)}\"]`);\n            if (!control || !t) {\n               continue;\n            }\n            updatableComponents.push({\n               condition: condition.replace(/[{}]{2}/g, ''),\n               component: control,\n               indx: indx,\n               type: t\n            });\n            const varsInvolved = condition.match(regex);\n            varsInvolved?.forEach(evar => {\n               evar = evar.replace(/[{}]*/g, '').trim();\n               // Can only watch real variables SELECT_MODE is not a variable\n               if (watchedvars.indexOf(evar) < 0 && (defaultsData[evar] ?? null) !== null) {\n                  watchedvars.push(evar);\n               }\n            });\n         }\n         watchedvars.push(varobj.name);\n      }\n\n      const doUpdateVisibilities = () => {\n         updatableComponents.forEach(upcomp => {\n            // Evaluate condition\n            const newVariables = this.extractFormParameters(widget, formElem, false);\n            // Add to the new variables the internal variables\n            newVariables.SELECT_MODE = selectmode;\n            // Eval JS condition for new variables\n            const showme = evalInContext(newVariables, upcomp.condition);\n            if (upcomp.component) {\n               /** @type {HTMLElement | null} */\n               const theComponent = upcomp.component.closest('.form-group');\n               // Only change visibilities of nodes not hidden from user\n               if (theComponent && !theComponent.getAttribute('data-amagat')) {\n                  theComponent.style.display = showme ? '' : 'none';\n               }\n            }\n         });\n      };\n\n      // Apply the watchers\n      widget.parameters.forEach((varobj) => {\n         const control = formElem.querySelector(`[name=\"${cleanParameterName(varobj.name)}\"]`);\n         if (watchedvars.indexOf(varobj.name) < 0 || !control) {\n            return;\n         }\n         let evtName = \"change\";\n         if (varobj.type === 'textfield' || varobj.type === 'textarea') {\n            evtName = \"keyup\";\n         }\n         control.addEventListener(evtName, () => {\n            doUpdateVisibilities();\n         });\n      });\n\n      // Decide which form elements are visible accoding to the current values of the parameters.\n      doUpdateVisibilities();\n   }\n   /**\n    * Create controllers for every repeatable element in form.\n    * @param {HTMLElement} form\n    * @param {import(\"../options\").Widget} widget\n    */\n   attachRepeatable(form, widget) {\n      const that = this;\n\n      widget.parameters.filter(p => p.type === 'repeatable').forEach((param) => {\n         // Make the parameter do not produce any default\n         const cleanParamname = cleanParameterName(param.name);\n         /** @type {HTMLElement | null} */\n         const subform = form.querySelector(`div[type=\"repeatable\"][name=\"${cleanParamname}\"]`);\n         if (!subform) {\n            return;\n         }\n         if (!param.fields?.length) {\n            subform.style.display = 'none';\n            return;\n         }\n         /**\n          * Inform the controller how to create a new item\n          * @param {number} i\n          * @returns {HTMLElement}\n          */\n         const itemBuilder = (i) => {\n            const controls = (param.fields ?? []).map(field => {\n               // Field value must be interpolated with the {{i}} placeholder\n               let value = field.value;\n               if (typeof (value) === 'string' && value.indexOf(\"{{i}}\") >= 0) {\n                  value = that.templateSrv.renderMustache(value, {i: i});\n               }\n               return that.createControlHTML(that.editor.id, field, value, cleanParamname, i);\n            });\n            const div = document.createElement(\"div\");\n            div.className = 'w-100';\n            div.innerHTML = controls.join(\" \");\n            return div;\n         };\n         new RepeatableCtrl(subform, itemBuilder, param);\n      });\n   }\n}\n\n/**\n * @typedef {Object} RepeatableOptions\n * @property {number} [min=1] - The minimum number of items allowed in the list.\n * @property {number} [max] - The maximum number of items allowed in the list.\n */\n\n/**\n * @callback ItemBuilder\n * @param {number} index - The index of the item being created.\n * @returns {HTMLElement} - The DOM Node to be inserted into the item.\n */\n\n/**\n * Controls a UI component that allows users to add and remove items from a list.\n * This class uses the underscore convention (_) to indicate private properties and methods.\n */\nclass RepeatableCtrl {\n   // Properties are defined in the constructor for broader compatibility.\n\n   /**\n    * @param {HTMLElement} form - The container element to append the list to.\n    * @param {ItemBuilder} itemBuilder - A function that returns the content for a new item.\n    * @param {RepeatableOptions} [opts={}] - Configuration options for the controller.\n    */\n   constructor(form, itemBuilder, opts = {}) {\n      /** @private */\n      this._form = form;\n      /** @private */\n      this._itemBuilder = itemBuilder;\n      /** @private */\n      this._opts = {min: 1, ...opts};\n      /** @private */\n      /** @type {HTMLUListElement} */\n      this._ul = document.createElement('ul');\n      /** @private */\n      this._itemCount = 0;\n      /** @private */\n      this._boundOnClick = this._onClick.bind(this);\n      this._init();\n   }\n\n   /**\n    * Initializes the list, creates the initial items, and attaches event listeners.\n    * @private\n    */\n   _init() {\n      this._ul.classList.add('list-group', 'list-group-flush', 'w-100', 'ml-5');\n\n      this._ul.append(RepeatableCtrl.createAddItem());\n\n      const initialCount = this._opts.min;\n      for (let i = 0; i < initialCount; i++) {\n         // Generate the content\n         this._itemCount += 1;\n         const content = this._itemBuilder(this._itemCount);\n         this._ul.append(RepeatableCtrl.createRegularItem(content, true));\n         this._ul.append(RepeatableCtrl.createAddItem());\n      }\n\n      this._form.append(this._ul);\n      this._updateButtonStates();\n      this._ul.addEventListener('click', this._boundOnClick);\n   }\n   /**\n    * Creates a list group container for the list items\n    * @returns {HTMLUListElement}\n    */\n   static createListGroup() {\n      const ul = document.createElement('ul');\n      ul.classList.add('list-group', 'list-group-flush', 'w-100', 'ml-5');\n      return ul;\n   }\n   /**\n    * Creates the \"add item\" separator row with a plus button.\n    * @private\n    * @returns {HTMLLIElement} The list item element representing the add button.\n    */\n   static createAddItem() {\n      const li = document.createElement('li');\n      li.classList.add('list-group-item', 'position-relative', 'text-center', 'tiny_widgethub-additem');\n\n      const button = document.createElement('button');\n      button.type = 'button';\n\n      button.className = 'tiny_widgethub-addbtn btn btn-sm btn-outline-secondary bg-white text-secondary';\n\n      const icon = document.createElement('i');\n      icon.className = 'fa fa-plus';\n\n      button.append(icon);\n      li.append(button);\n      return li;\n   }\n\n   /**\n    * Creates a regular list item containing user-defined content and a remove button.\n    * @param {string | Node} content\n    * @param {boolean} showDelBtn\n    * @returns {HTMLLIElement} The list item element.\n    */\n   static createRegularItem(content, showDelBtn) {\n      const li = document.createElement('li');\n      li.classList.add('list-group-item', 'd-flex', 'w-100', 'justify-content-between', 'align-items-center', 'tiny_widgethub-regularitem');\n      li.append(content);\n      if (showDelBtn) {\n         const button = document.createElement('button');\n         button.type = 'button';\n         button.className = 'tiny_widgethub-removeitem btn btn-sm btn-outline-danger';\n\n         const icon = document.createElement('i');\n         icon.className = 'fa fa-trash';\n\n         button.append(icon);\n         li.append(button);\n      }\n      return li;\n   }\n\n   /**\n    * Updates the enabled/disabled state of all add and remove buttons.\n    * @private\n    */\n   _updateButtonStates() {\n      const count = this._ul.querySelectorAll('.list-group-item.tiny_widgethub-regularitem').length;\n\n      const canDelete = count > (this._opts.min ?? 1);\n      /** @type {NodeListOf<HTMLButtonElement>} */\n      let buttons = this._ul.querySelectorAll('button.tiny_widgethub-removeitem');\n      buttons.forEach(btn => (btn.disabled = !canDelete));\n\n      const canAdd = this._opts.max === undefined || count < this._opts.max;\n      buttons = this._ul.querySelectorAll('button.tiny_widgethub-addbtn');\n      buttons.forEach(btn => (btn.disabled = !canAdd));\n   }\n\n   /**\n    * Handles click events on the list, delegating to add or remove actions.\n    * @private\n    * @param {MouseEvent} evt - The click event.\n    */\n   _onClick(evt) {\n      if (!(evt.target instanceof Element)) {\n         return;\n      }\n      const btn = evt.target?.closest(\"button\");\n      if (!btn || btn.disabled) {\n         return;\n      }\n\n      const li = btn.closest('li');\n      if (!li) {\n         return;\n      }\n\n      if (btn.classList.contains('tiny_widgethub-addbtn')) {\n         this._itemCount += 1;\n         const content = this._itemBuilder(this._itemCount);\n         li.after(RepeatableCtrl.createRegularItem(content, true), RepeatableCtrl.createAddItem());\n      } else if (btn.classList.contains('tiny_widgethub-removeitem')) {\n         const separator = li.previousElementSibling;\n         if (separator) {\n            separator.remove();\n         }\n         li.remove();\n      }\n\n      this._updateButtonStates();\n   }\n   /**\n    * Removes the event listener on the list\n    */\n   destroy() {\n      this._ul.removeEventListener('click', this._boundOnClick);\n   }\n}\n\n\nconst formCtrlInstances = new Map();\n/**\n * @param {import('../plugin').TinyMCE} editor\n * @returns {FormCtrl}\n */\nexport function getFormCtrl(editor) {\n   let instance = formCtrlInstances.get(editor);\n   if (!instance) {\n      // @ts-ignore\n      instance = new FormCtrl(editor, getUserStorage(editor), getTemplateSrv(), getFileSrv(editor));\n      formCtrlInstances.set(editor, instance);\n   }\n   return instance;\n}\n"],"names":["editor","instance","formCtrlInstances","get","FormCtrl","set","questionPopover","Templates","TEXTFIELDTEMPLATE","IMAGETEMPLATE","NUMERICTEMPLATE","COLORTEMPLATE","TEXTAREATEMPLATE","CHECKBOXTEMPLATE","SELECTTEMPLATE","AUTOCOMPLETETEMPLATE","REPEATABLE","constructor","userStorage","templateSrv","fileSrv","storage","createContext","widget","mustSaveAll","this","getFromLocal","saveAllData","values","defaults","controls","parameters","map","param","createControlHTML","id","sname","key","pname","name","currentval","startsWith","obtainCurrentValue","idtabpane","selectmode","selection","getContent","trim","length","instructions","filter","isFilter","hostId","defaultValue","prefixName","index","markup","generalCtx","elementid","undefined","varname","vartitle","title","defaultvalue","tooltip","tip","disabled","editable","hidden","type","renderMustache","minMax","min","max","options","opt","label","value","l","v","optionLabel","optionValue","selected","tmpl","hex","alpha","defaultvalueAlpha","itemControls","Array","isArray","ul","RepeatableCtrl","createListGroup","forEach","obj","tmpDiv","document","createElement","className","Object","keys","field","fields","_param$fields","f","innerHTML","append","createRegularItem","outerHTML","extractControlValue","elem","getAttribute","tagName","checked","indexOf","parseFloat","parseInt","cleanPname","rangeControl","closest","_elem$closest","querySelector","transform","reduce","extractFormParameters","form","doStore","ctx","toPersist","cleanParamname","listValue","querySelectorAll","subform","itemObj","cleanFieldname","subelem","push","setToLocal","previousAllData","attachPickers","modalBody","canShowFilePicker","getImagePicker","picker","addEventListener","async","evt","preventDefault","params","displayImagePicker","url","parent","currentTarget","parentElement","input","ex","console","error","inputColor","inputRange","opacity","style","applyFieldWatchers","formElem","defaultsData","watchedvars","updatableComponents","regex","indx","len","varobj","when","condition","t","control","replace","component","varsInvolved","match","evar","doUpdateVisibilities","upcomp","newVariables","SELECT_MODE","showme","theComponent","display","evtName","attachRepeatable","that","p","_param$fields3","i","div","join","itemBuilder","opts","_form","_itemBuilder","_opts","_ul","_itemCount","_boundOnClick","_onClick","bind","_init","classList","add","createAddItem","initialCount","content","_updateButtonStates","li","button","icon","showDelBtn","count","canDelete","buttons","btn","canAdd","target","Element","_evt$target","contains","after","separator","previousElementSibling","remove","destroy","removeEventListener","Map"],"mappings":"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"}