define("tiny_widgethub/contextinit",["exports","./options","./service/dom_service","./controller/widgetproperties_ctrl","./extension","./common","core/str"],(function(_exports,_options,_dom_service,_widgetproperties_ctrl,_extension,_common,_str){var obj;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.initContextActions=async function(editor){const ctx={actionPaths:{},editor:editor};!function(editor){editor.ui.registry.addIcon(ICONS_gear,'<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 512 512"><path d="M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2c-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.3-28.2 18.9-44 25.4l-12.5 57.1c-2 9.1-9 16.3-18.2 17.8c-13.8 2.3-28 3.5-42.5 3.5s-28.7-1.2-42.5-3.5c-9.2-1.5-16.2-8.7-18.2-17.8l-12.5-57.1c-15.8-6.5-30.6-15.1-44-25.4L83.1 425.9c-8.8 2.8-18.6 .3-24.5-6.8c-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6c4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2c5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.3 28.2-18.9 44-25.4l12.5-57.1c2-9.1 9-16.3 18.2-17.8C227.3 1.2 241.5 0 256 0s28.7 1.2 42.5 3.5c9.2 1.5 16.2 8.7 18.2 17.8l12.5 57.1c15.8 6.5 30.6 15.1 44 25.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8c8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z"/></svg>'),editor.ui.registry.addIcon(ICONS_arrowUpFromBracket,'<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 448 512"><path d="M246.6 9.4c-12.5-12.5-32.8-12.5-45.3 0l-128 128c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 109.3 192 320c0 17.7 14.3 32 32 32s32-14.3 32-32l0-210.7 73.4 73.4c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3l-128-128zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64c0 53 43 96 96 96l256 0c53 0 96-43 96-96l0-64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64c0 17.7-14.3 32-32 32L96 448c-17.7 0-32-14.3-32-32l0-64z"/></svg>'),editor.ui.registry.addIcon(ICONS_arrowUp,'<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 384 512"><path d="M214.6 41.4c-12.5-12.5-32.8-12.5-45.3 0l-160 160c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 141.2 160 448c0 17.7 14.3 32 32 32s32-14.3 32-32l0-306.7L329.4 246.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3l-160-160z"/></svg>'),editor.ui.registry.addIcon(ICONS_arrowDown,'<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 384 512"><path d="M169.4 470.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 370.8 224 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 306.7L54.6 265.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z"/></svg>'),editor.ui.registry.addIcon(ICONS_arrowLeft,'<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 448 512"><path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.2 288 416 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-306.7 0L214.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg>'),editor.ui.registry.addIcon(ICONS_arrowRight,'<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 448 512"><path d="M438.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L338.8 224 32 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l306.7 0L233.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l160-160z"/></svg>'),editor.ui.registry.addIcon(ICONS_clone,'<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 512 512"><path d="M64 464l224 0c8.8 0 16-7.2 16-16l0-64 48 0 0 64c0 35.3-28.7 64-64 64L64 512c-35.3 0-64-28.7-64-64L0 224c0-35.3 28.7-64 64-64l64 0 0 48-64 0c-8.8 0-16 7.2-16 16l0 224c0 8.8 7.2 16 16 16zM224 304l224 0c8.8 0 16-7.2 16-16l0-224c0-8.8-7.2-16-16-16L224 48c-8.8 0-16 7.2-16 16l0 224c0 8.8 7.2 16 16 16zm-64-16l0-224c0-35.3 28.7-64 64-64L448 0c35.3 0 64 28.7 64 64l0 224c0 35.3-28.7 64-64 64l-224 0c-35.3 0-64-28.7-64-64z"/></svg>'),editor.ui.registry.addIcon(ICONS_cut,'<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 640 640"><path d="M256 320L216.5 359.5C203.9 354.6 190.3 352 176 352C114.1 352 64 402.1 64 464C64 525.9 114.1 576 176 576C237.9 576 288 525.9 288 464C288 449.7 285.3 436.1 280.5 423.5L563.2 140.8C570.3 133.7 570.3 122.3 563.2 115.2C534.9 86.9 489.1 86.9 460.8 115.2L320 256L280.5 216.5C285.4 203.9 288 190.3 288 176C288 114.1 237.9 64 176 64C114.1 64 64 114.1 64 176C64 237.9 114.1 288 176 288C190.3 288 203.9 285.3 216.5 280.5L256 320zM353.9 417.9L460.8 524.8C489.1 553.1 534.9 553.1 563.2 524.8C570.3 517.7 570.3 506.3 563.2 499.2L417.9 353.9L353.9 417.9zM128 176C128 149.5 149.5 128 176 128C202.5 128 224 149.5 224 176C224 202.5 202.5 224 176 224C149.5 224 128 202.5 128 176zM176 416C202.5 416 224 437.5 224 464C224 490.5 202.5 512 176 512C149.5 512 128 490.5 128 464C128 437.5 149.5 416 176 416z"/></svg>'),editor.ui.registry.addIcon(ICONS_paste,'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M128 64C92.7 64 64 92.7 64 128L64 448C64 483.3 92.7 512 128 512L240 512L240 288C240 226.1 290.1 176 352 176L416 176L416 128C416 92.7 387.3 64 352 64L128 64zM312 176L168 176C154.7 176 144 165.3 144 152C144 138.7 154.7 128 168 128L312 128C325.3 128 336 138.7 336 152C336 165.3 325.3 176 312 176zM352 224C316.7 224 288 252.7 288 288L288 512C288 547.3 316.7 576 352 576L512 576C547.3 576 576 547.3 576 512L576 346.5C576 329.5 569.3 313.2 557.3 301.2L498.8 242.7C486.8 230.7 470.5 224 453.5 224L352 224z"/></svg>')}(editor);const[strProperties,strUnwrap,strMoveUp,strMoveDown,strMoveAfter,strMoveBefore,strInsert,strRemove,strPrintable,strCut,strPaste]=await(0,_str.get_strings)([{key:"properties",component:component},{key:"unwrap",component:component},{key:"moveup",component:component},{key:"movedown",component:component},{key:"moveafter",component:component},{key:"movebefore",component:component},{key:"insert",component:component},{key:"remove",component:component},{key:"printable",component:component},{key:"cut",component:component},{key:"paste",component:component}]),widgetList=Object.values((0,_options.getWidgetDict)(editor)),domSrv=(0,_dom_service.getDomSrv)(),predefinedActions=function(editor,domSrv){const factory={unwrap:context=>{var _context$widget;if(null==context||!context.elem||null==context||null===(_context$widget=context.widget)||void 0===_context$widget||!_context$widget.unwrap)return;const nodes=context.elem.querySelectorAll(context.widget.unwrap);if(context.elem.parentNode){if(0===nodes.length){const textNode=document.createTextNode(context.elem.textContent);context.elem.replaceWith(textNode)}else if(1===nodes.length)context.elem.replaceWith(nodes[0]);else{const fragment=document.createDocumentFragment();nodes.forEach((node=>fragment.appendChild(node))),context.elem.replaceWith(fragment)}(0,_extension.getListeners)("widgetRemoved").forEach((listener=>listener(editor,context.widget)))}},movebefore:context=>{const el=null==context?void 0:context.targetElement,root=null==context?void 0:context.elem;if(!el||!root)return;const prev=el.previousElementSibling;var _el$parentNode;prev&&(null===(_el$parentNode=el.parentNode)||void 0===_el$parentNode||_el$parentNode.insertBefore(el,prev),prev.closest(".nav")&&domSrv.findReferences(el,root).forEach((ref=>{const prev2=ref.previousElementSibling;var _ref$parentNode;prev2&&(null===(_ref$parentNode=ref.parentNode)||void 0===_ref$parentNode||_ref$parentNode.insertBefore(ref,prev2))})))},moveafter:context=>{const el=null==context?void 0:context.targetElement,root=null==context?void 0:context.elem;if(!el||!root)return;const next=el.nextElementSibling;var _next$parentNode;next&&(null===(_next$parentNode=next.parentNode)||void 0===_next$parentNode||_next$parentNode.insertBefore(next,el),next.closest(".nav")&&domSrv.findReferences(el,root).forEach((ref=>{const next2=ref.nextElementSibling;var _next2$parentNode;next2&&(null===(_next2$parentNode=next2.parentNode)||void 0===_next2$parentNode||_next2$parentNode.insertBefore(next2,ref))})))},insertafter:context=>{var _el$parentNode2;const el=null==context?void 0:context.targetElement,root=null==context?void 0:context.elem;if(!el||!root)return;const idMap={},clone=domSrv.smartClone(el,root,idMap);null===(_el$parentNode2=el.parentNode)||void 0===_el$parentNode2||_el$parentNode2.insertBefore(clone,el.nextSibling),clone.classList.remove("active","show")},remove:context=>{const el=null==context?void 0:context.targetElement,root=null==context?void 0:context.elem,widget=null==context?void 0:context.widget;if(!el||!root||!widget)return;if(el===root)return root.remove(),void(0,_extension.getListeners)("widgetRemoved").forEach((listener=>listener(editor,widget)));domSrv.findReferences(el,root).forEach((ref=>ref.remove()));const parent=el.parentNode;null==el||el.remove(),parent&&0===parent.children.length&&(root.remove(),(0,_extension.getListeners)("widgetRemoved").forEach((listener=>listener(editor,widget))))},printable:context=>{const el=null==context?void 0:context.elem;el&&el.classList.toggle("d-print-none")},cut:context=>{const el=null==context?void 0:context.elem;el&&null!=context&&context.widget&&(widgetCutClipboard={widget:context.widget,html:el.outerHTML},el.remove(),editor.nodeChanged(),editor.undoManager.add(),(0,_extension.getListeners)("widgetRemoved").forEach((listener=>listener(editor,context.widget))))}};return factory.moveup=factory.movebefore,factory.movedown=factory.moveafter,factory.moveleft=factory.movebefore,factory.moveright=factory.moveafter,factory.insert=factory.insertafter,factory}(editor,domSrv),showPropertiesAction=async()=>{const path=domSrv.findWidgetOnEventPath(widgetList,editor.selection.getNode());if(ctx.path=path,!path.widget)return;const widgetPropertiesCtrl=(0,_widgetproperties_ctrl.getWidgetPropertiesCtrl)(editor);await widgetPropertiesCtrl.show(path)};function genericAction(name){return function(){var _ctx$path,_ctx$path2;if((null===(_ctx$path=ctx.path)||void 0===_ctx$path||!_ctx$path.widget)&&(ctx.path=domSrv.findWidgetOnEventPath(widgetList,editor.selection.getNode()),null===(_ctx$path2=ctx.path)||void 0===_ctx$path2||!_ctx$path2.widget))return;const action=predefinedActions[name];action&&(action(ctx.path),(0,_extension.getListeners)("ctxAction").forEach((listener=>{var _ctx$path3;return listener(editor,null===(_ctx$path3=ctx.path)||void 0===_ctx$path3?void 0:_ctx$path3.widget)})))}}editor.ui.registry.addButton(`${componentName}_modal_btn`,{icon:ICONS_gear,tooltip:strProperties,onAction:showPropertiesAction}),editor.ui.registry.addMenuItem(`${componentName}_modal_item`,{icon:ICONS_gear,text:strProperties,onAction:showPropertiesAction}),editor.ui.registry.addMenuItem(`${componentName}_paste_item`,{icon:ICONS_paste,text:strPaste,onAction:()=>{var _widgetCutClipboard,_widgetCutClipboard2;const html=null===(_widgetCutClipboard=widgetCutClipboard)||void 0===_widgetCutClipboard?void 0:_widgetCutClipboard.html,widget=null===(_widgetCutClipboard2=widgetCutClipboard)||void 0===_widgetCutClipboard2?void 0:_widgetCutClipboard2.html;html&&widget&&(editor.insertContent(html),editor.undoManager.add(),editor.nodeChanged(),(0,_extension.getListeners)("widgetInserted").forEach((listener=>listener(editor,widget))),widgetCutClipboard=null)}}),editor.ui.registry.addButton(`${componentName}_unwrap_btn`,{icon:ICONS_arrowUpFromBracket,tooltip:strUnwrap,onAction:genericAction("unwrap")}),editor.ui.registry.addMenuItem(`${componentName}_unwrap_item`,{icon:ICONS_arrowUpFromBracket,text:strUnwrap,onAction:genericAction("unwrap")}),editor.ui.registry.addMenuItem(`${componentName}_moveup_item`,{icon:ICONS_arrowUp,text:strMoveUp,onAction:genericAction("movebefore")}),editor.ui.registry.addMenuItem(`${componentName}_movedown_item`,{icon:ICONS_arrowDown,text:strMoveDown,onAction:genericAction("moveafter")}),editor.ui.registry.addMenuItem("widgethub_movebefore_item",{icon:ICONS_arrowLeft,text:strMoveBefore,onAction:genericAction("movebefore")}),editor.ui.registry.addMenuItem("widgethub_moveafter_item",{icon:ICONS_arrowRight,text:strMoveAfter,onAction:genericAction("moveafter")}),editor.ui.registry.addMenuItem(`${componentName}_insertafter_item`,{icon:ICONS_clone,text:strInsert,onAction:genericAction("insertafter")}),editor.ui.registry.addMenuItem(`${componentName}_remove_item`,{icon:ICONS_remove,text:strRemove,onAction:genericAction("remove")}),editor.ui.registry.addMenuItem(`${componentName}_cut_item`,{icon:ICONS_cut,text:strCut,onAction:genericAction("cut")}),editor.ui.registry.addToggleMenuItem(`${componentName}_printable_item`,{icon:"print",text:strPrintable,onAction:genericAction("printable"),onSetup:api=>{var _ctx$path4,_ctx$path4$elem,_ctx$path4$elem$class;let toggleState=!0;return null!==(_ctx$path4=ctx.path)&&void 0!==_ctx$path4&&null!==(_ctx$path4$elem=_ctx$path4.elem)&&void 0!==_ctx$path4$elem&&null!==(_ctx$path4$elem$class=_ctx$path4$elem.classList)&&void 0!==_ctx$path4$elem$class&&_ctx$path4$elem$class.contains("d-print-none")&&(toggleState=!1),api.setActive(toggleState),()=>({})}});const widgetsWithExtensions=(await Promise.all((0,_extension.getMenuItemProviders)().map((provider=>provider(ctx))))).flat();widgetsWithExtensions.forEach((menuItem=>{menuItem.subMenuItems?editor.ui.registry.addNestedMenuItem(`${componentName}_${menuItem.name}`,{icon:menuItem.icon,text:menuItem.title,getSubmenuItems:menuItem.subMenuItems}):menuItem.onAction&&editor.ui.registry.addMenuItem(`${componentName}_${menuItem.name}`,{icon:menuItem.icon,text:menuItem.title,onAction:menuItem.onAction})}));const prefixMenuItems=menuItems=>menuItems.map((e=>"|"===e?"|":`${componentName}_${e}_item`));editor.ui.registry.addContextMenu(component,{update:element=>{var _ctx$path5;let menuItems=[];if(widgetCutClipboard&&menuItems.push("paste"),ctx.path=domSrv.findWidgetOnEventPath(widgetList,element),null===(_ctx$path5=ctx.path)||void 0===_ctx$path5||!_ctx$path5.widget||ctx.path.widget.prop("contexttoolbar"))return prefixMenuItems(menuItems).join(" ");const widget=ctx.path.widget;hasBindings(widget)&&menuItems.push("modal");let parentPath=null;if(widget.prop("bubbles")){var _ctx$path6,_ctx$path6$elem;const parentElem=null===(_ctx$path6=ctx.path)||void 0===_ctx$path6||null===(_ctx$path6$elem=_ctx$path6.elem)||void 0===_ctx$path6$elem?void 0:_ctx$path6$elem.parentElement;if(parentElem){var _p$widget;const p=domSrv.findWidgetOnEventPath(widgetList,parentElem);p&&(null===(_p$widget=p.widget)||void 0===_p$widget?void 0:_p$widget.key)===widget.prop("bubbles")&&(parentPath=p)}}const populateMenuItems=function(path){var _path$widget;let contextmenu=null===(_path$widget=path.widget)||void 0===_path$widget?void 0:_path$widget.prop("contextmenu");contextmenu&&(Array.isArray(contextmenu)||(contextmenu=[contextmenu]),contextmenu.forEach((cm=>{let targetElem=null;if(targetElem=cm.predicate?element.matches(cm.predicate)?element:element.closest(cm.predicate):(null==path?void 0:path.elem)??null,!targetElem)return;const newActionsToAdd=cm.actions.split(" ").map((e=>e.trim())).map((action=>"moveleft"===action?"movebefore":"moveright"===action?"moveafter":"insert"===action?"insertafter":action)).filter((e=>"|"===e||!menuItems.includes(e)));menuItems.push(...newActionsToAdd),newActionsToAdd.filter((e=>"|"!==e)).forEach((e=>{path.targetElement=targetElem,ctx.actionPaths[e]={...path}}))})))};parentPath&&populateMenuItems(parentPath),populateMenuItems(ctx.path),menuItems=prefixMenuItems(menuItems);const actionNames=widgetsWithExtensions.filter((e=>function(condition,key){if("string"==typeof condition)return condition.split(",").map((e=>e.trim())).includes(key);if(condition instanceof RegExp)return condition.test(key);if("function"==typeof condition)return condition();return!1}(e.condition,widget.key))).map((e=>`${componentName}_${e.name}`));return menuItems.push(...actionNames),widget.unwrap&&menuItems.push(`${componentName}_unwrap_item`),menuItems.join(" ")}}),widgetList.filter((widget=>function(widget){return widget.hasBindings()||(widget.unwrap??"").trim().length>0}(widget))).forEach((widget=>{const items=[];hasBindings(widget)&&items.push("modal"),widget.unwrap&&items.push("unwrap"),widget.prop("contexttoolbar")&&editor.ui.registry.addContextToolbar(`${componentName}_ctb_${widget.key}`,{predicate:function(node){return domSrv.matchesSelectors(node,widget.selectors)},items:items.map((e=>`${componentName}_${e}_btn`)).join(" "),position:"node"})}))},_common=(obj=_common)&&obj.__esModule?obj:{default:obj};const{component:component,componentName:componentName}=_common.default,ICONS_gear="gear",ICONS_arrowUpFromBracket="arrow-up-from-bracket",ICONS_arrowUp="arrow-up",ICONS_arrowDown="arrow-down",ICONS_arrowLeft="arrow-left",ICONS_arrowRight="arrow-right",ICONS_remove="remove",ICONS_clone="clone",ICONS_cut="cut",ICONS_paste="paste";
/**
   * Tiny WidgetHub plugin.
   *
   * @module      tiny_widgethub/plugin
   * @copyright   2024 Josep Mulet Pol <pep.mulet@gmail.com>
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */function hasBindings(widget){var _widget$parameters;return null===(_widget$parameters=widget.parameters)||void 0===_widget$parameters?void 0:_widget$parameters.some((param=>{if("repeatable"===param.type){var _param$fields;const hasFieldBindings=null===(_param$fields=param.fields)||void 0===_param$fields?void 0:_param$fields.some((f=>void 0!==f.bind));return"object"==typeof param.bind||hasFieldBindings&&"string"==typeof param.item_selector}return void 0!==param.bind}))}let widgetCutClipboard=null}));

//# sourceMappingURL=contextinit.min.js.map